<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">SmartPay Wallet - Modern Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <style>
        /* --- MODERN RESET & VARIABLES --- */
        :root {
            --primary: #2563eb;
            --primary-light: #3b82f6;
            --primary-dark: #1d4ed8;
            --secondary: #7c3aed;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1e293b;
            --dark-2: #334155;
            --light: #f8fafc;
            --light-2: #e2e8f0;
            --white: #ffffff;
            --text: #475569;
            --text-light: #64748b;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.12);
            --radius: 12px;
            --radius-lg: 16px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --app-width: 100%;
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Hind Siliguri', sans-serif; 
        }
        
        body {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 0;
        }

        /* --- MAINTENANCE OVERLAY --- */
        .maintenance-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
            padding: 20px;
        }

        .maintenance-overlay.active {
            display: flex;
        }

        .maintenance-content {
            max-width: 500px;
            padding: 40px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .maintenance-icon {
            font-size: 64px;
            margin-bottom: 20px;
            color: #f59e0b;
        }

        .maintenance-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 20px;
            color: white;
        }

        .maintenance-message {
            font-size: 16px;
            line-height: 1.6;
            color: #cbd5e1;
            margin-bottom: 30px;
        }

        /* --- AUTHENTICATION SCREENS --- */
        .auth-container {
            width: 100%;
            max-width: 400px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        /* Welcome Screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 30px 20px;
            text-align: center;
        }

        .welcome-logo {
            font-size: 48px;
            margin-bottom: 30px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
        }

        .welcome-title {
            font-size: 32px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 40px;
        }

        .auth-btn {
            width: 100%;
            padding: 18px;
            margin: 12px 0;
            border: none;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .auth-btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.3);
        }

        .auth-btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(37, 99, 235, 0.4);
        }

        .auth-btn-secondary {
            background: var(--white);
            color: var(--primary);
            border: 2px solid var(--primary);
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.1);
        }

        .auth-btn-secondary:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-3px);
        }

        /* Sign In & Sign Up Screens */
        .auth-screen {
            width: 100%;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 20px;
            position: relative;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .auth-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 10px;
        }

        .auth-subtitle {
            font-size: 14px;
            color: var(--text-light);
        }

        .auth-form {
            width: 100%;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--light-2);
            border-radius: var(--radius);
            font-size: 16px;
            background: var(--white);
            transition: var(--transition);
            outline: none;
        }

        .form-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        .forgot-link {
            display: block;
            text-align: right;
            color: var(--primary);
            font-size: 14px;
            font-weight: 600;
            margin: 15px 0;
            text-decoration: none;
            transition: var(--transition);
        }

        .forgot-link:hover {
            color: var(--primary-dark);
        }

        .auth-footer {
            text-align: center;
            margin-top: 30px;
            font-size: 14px;
            color: var(--text-light);
        }

        .auth-link {
            color: var(--primary);
            font-weight: 600;
            text-decoration: none;
            margin-left: 5px;
            transition: var(--transition);
        }

        .auth-link:hover {
            color: var(--primary-dark);
        }

        .back-btn-auth {
            position: absolute;
            top: 30px;
            left: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--light);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--dark);
            font-size: 18px;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            z-index: 10;
        }

        .back-btn-auth:hover {
            background: var(--light-2);
            transform: translateX(-3px);
        }

        /* Error Message */
        .error-message {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border: 2px solid var(--danger);
            border-radius: var(--radius);
            padding: 15px;
            margin-bottom: 20px;
            color: var(--danger);
            font-size: 14px;
            font-weight: 600;
            display: none;
            align-items: center;
            gap: 10px;
        }

        .success-message {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border: 2px solid var(--success);
            border-radius: var(--radius);
            padding: 15px;
            margin-bottom: 20px;
            color: #059669;
            font-size: 14px;
            font-weight: 600;
            display: none;
            align-items: center;
            gap: 10px;
        }

        /* Loading State */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* --- APP CONTAINER --- */
        #app-container {
            width: 100%;
            max-width: var(--app-width);
            background-color: var(--white);
            min-height: 100vh;
            border-radius: 0;
            position: relative;
            box-shadow: none;
            overflow-x: hidden;
            overflow-y: auto;
            transition: var(--transition);
            margin: 0;
            display: none;
        }

        /* --- FIXED HEADER FOR ALL PAGES --- */
        .dashboard-header,
        .page-header {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            z-index: 1000 !important;
            width: 100% !important;
            max-width: var(--app-width) !important;
            margin: 0 auto !important;
            transition: background 0.3s ease;
        }

        /* Adjust padding for pages to account for fixed header */
        #dashboard-view.page-view {
            padding-top: 70px !important;
        }

        .page-view {
            padding-top: 70px !important;
            min-height: 100vh;
        }

        /* Remove old margin-top from timer-section */
        .timer-section {
            margin-top: 0 !important;
        }

        /* Adjust status alert margin */
        .status-alert {
            margin-top: 0 !important;
            border-radius: 0 !important;
        }

        /* --- UPDATED DASHBOARD HEADER (dynamic background) --- */
        .dashboard-header {
            background: var(--dark); /* fallback - will be overridden by Firestore */
            color: var(--white);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 0;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .logo { 
            font-size: 22px; 
            font-weight: 700; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        .logo i, .logo img {
            display: inline-block;
        }
        .logo img {
            height: 30px;
            width: auto;
            object-fit: contain;
        }
        .logo span { 
            /* color will be dynamically set */
        }
        .header-actions { 
            display: flex; 
            gap: 15px; 
            align-items: center; 
        }
        
        .menu-btn { 
            font-size: 24px; 
            cursor: pointer;
            background: rgba(255, 255, 255, 0.1);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            transition: var(--transition);
            color: white; /* fallback */
        }
        .menu-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        /* --- ONE-LINE VERIFICATION STATUS (Dashboard Only) --- */
        .status-alert {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border-left: 4px solid var(--danger);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 0;
            border-radius: 0;
            box-shadow: var(--shadow);
            min-height: 44px;
            max-height: 48px;
            white-space: nowrap;
            overflow: hidden;
        }
        .status-alert.processing {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left: 4px solid var(--warning);
        }
        .status-alert.processing p { 
            color: #92400e; 
        }
        .status-alert p { 
            color: var(--danger); 
            font-size: 14px; 
            font-weight: 600; 
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
        }
        .verify-btn-sm {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 30px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
            white-space: nowrap;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .verify-btn-sm:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
        }

        /* --- UPDATED LIVE TIMER SECTION (dynamic colors) --- */
        .timer-section {
            background: var(--dark); /* fallback */
            padding: 18px;
            border-radius: 0;
            margin: 0;
            color: white;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
            transition: background 0.3s ease;
        }
        .timer-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #60a5fa, #7c3aed, #10b981);
        }
        .timer-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 12px; 
        }
        .timer-title { 
            font-weight: bold; 
            font-size: 14px; 
            color: #e2e8f0; /* will be overridden by text color */
        }
        .launch-date { 
            font-size: 11px; 
            color: #cbd5e1; 
            background: rgba(255, 255, 255, 0.1); 
            padding: 5px 10px; 
            border-radius: 16px; 
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .timer-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        .timer-box {
            background: rgba(255, 255, 255, 0.1); /* fallback */
            padding: 12px 0;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            text-align: center;
            min-height: 70px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: background 0.3s ease;
        }
        .timer-val { 
            font-size: 24px; 
            font-weight: 800; 
            color: white; 
            display: block; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            line-height: 1;
            margin-bottom: 4px;
            font-family: monospace;
            transition: color 0.3s ease;
        }
        .timer-label { 
            font-size: 11px; 
            color: #cbd5e1; 
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: color 0.3s ease;
        }

        /* --- MODERN MARQUEE --- */
        .marquee-container {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            padding: 12px 0;
            overflow: hidden;
            white-space: nowrap;
            margin: 0;
            border-radius: 0;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--warning);
        }
        .marquee-text {
            display: inline-block;
            color: #92400e;
            font-weight: 600;
            font-size: 14px;
            padding-left: 100%;
            animation: scroll 20s linear infinite;
        }
        @keyframes scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }

        /* --- TEMPORARY NOTICE TRIGGER (Updated) --- */
        .notice-trigger {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 12px 0;
            border-radius: 0;
            border-left: 4px solid var(--primary);
            box-shadow: var(--shadow);
            transition: var(--transition);
            cursor: pointer;
            min-height: 52px;
        }
        .notice-trigger:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.15);
        }
        .notice-left { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            font-weight: 700; 
            color: var(--dark); 
            font-size: 14px;
        }
        .dot { 
            height: 10px; 
            width: 10px; 
            background: var(--primary); 
            border-radius: 50%; 
            display: inline-block;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .tap-view { 
            background: white; 
            padding: 6px 12px; 
            border-radius: 20px; 
            font-size: 12px; 
            border: 1px solid #60a5fa; 
            color: var(--primary); 
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }
        .tap-view:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.05);
        }

        /* --- TEMPORARY MESSAGE VIEW MODAL (Updated) --- */
        .message-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .message-modal-overlay.active {
            display: flex;
        }

        .message-modal {
            background: white;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalPop 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            display: flex;
            flex-direction: column;
        }

        .message-modal-header {
            background: linear-gradient(135deg, var(--dark) 0%, var(--dark-2) 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .message-modal-title {
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .message-modal-close {
            background: rgba(255, 255, 255, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .message-modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        .message-modal-content {
            padding: 25px;
            overflow-y: auto;
            flex: 1;
        }

        .message-modal-text {
            color: var(--text);
            line-height: 1.6;
            font-size: 15px;
        }

        .message-modal-actions {
            padding: 20px;
            border-top: 1px solid var(--light-2);
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .message-modal-link {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .message-modal-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(37, 99, 235, 0.4);
        }

        .message-modal-close-btn {
            background: var(--light);
            color: var(--text);
            border: 2px solid var(--light-2);
            padding: 12px 24px;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .message-modal-close-btn:hover {
            background: #e2e8f0;
        }

        /* --- UPDATED COMPACT WALLET SECTION (Mobile Friendly) --- */
        .wallet-section { 
            padding: 0; 
            margin-top: 20px;
        }
        .section-title { 
            font-size: 16px; 
            font-weight: 700; 
            margin-bottom: 12px; 
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0 15px;
        }
        .section-title::before {
            content: '';
            width: 4px;
            height: 16px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 2px;
        }
        .section-title span { 
            font-size: 11px; 
            color: var(--text-light); 
            font-weight: 400; 
            margin-left: auto;
        }
        
        /* COMPACT MAIN BALANCE CARD - 2 WALLET WIDTH */
        .main-balance-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            padding: 16px;
            border-radius: 0;
            color: white;
            text-align: center;
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.25);
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            grid-column: span 2;
        }
        .balance-label { 
            font-size: 12px; 
            opacity: 0.9; 
            margin-bottom: 4px;
            letter-spacing: 0.5px;
        }
        .balance-amount { 
            font-size: 28px; 
            font-weight: 800; 
            margin: 6px 0;
            text-shadow: 0 2px 8px rgba(0,0,0,0.2);
            line-height: 1.2;
        }
        .balance-amount::before {
            content: 'à§³ ';
            font-size: 20px;
            opacity: 0.9;
        }
        .balance-subtext {
            font-size: 10px;
            opacity: 0.8;
            margin-top: 4px;
        }

        /* UPDATED COMPACT WALLET GRID - 2 CARDS PER ROW */
        .wallet-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            padding: 0 15px 20px;
        }
        .stat-card {
            background: var(--white);
            padding: 12px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            border: 1px solid var(--light-2);
            transition: var(--transition);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            min-height: 80px;
            justify-content: space-between;
        }
        .stat-card:hover { 
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.12);
            border-color: var(--primary-light);
        }
        .stat-card:active { 
            transform: scale(0.98); 
        }
        .stat-card.locked { 
            opacity: 0.6; 
            pointer-events: none; 
            position: relative; 
        }
        .stat-card.locked::after {
            content: '\f023';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 50%; 
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px; 
            color: #94a3b8;
            z-index: 2;
        }

        .card-icon-area { 
            margin-bottom: 8px; 
            width: 32px; 
            height: 32px; 
            border-radius: 8px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: white;
            font-size: 14px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }
        .card-amount { 
            font-size: 16px; 
            font-weight: 800; 
            color: var(--dark); 
            margin: 4px 0;
            line-height: 1.2;
        }
        .card-title { 
            font-size: 11px; 
            color: var(--text-light); 
            font-weight: 500; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .bg-green { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .bg-blue { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .bg-orange { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); }
        .bg-purple { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }
        .bg-teal { background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%); }
        .bg-pink { background: linear-gradient(135deg, #ec4899 0%, #db2777 100%); }
        .bg-yellow { background: linear-gradient(135deg, #eab308 0%, #ca8a04 100%); } /* For Free Job Wallet */

        /* --- Package Grid for Withdraw --- */
        .package-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 10px;
        }

        .package-card {
            background: var(--white);
            border: 2px solid var(--light-2);
            border-radius: var(--radius);
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .package-card:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(37, 99, 235, 0.15);
        }

        .package-card.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        }

        .package-amount {
            font-size: 20px;
            font-weight: 800;
            color: var(--dark);
            margin-bottom: 5px;
        }

        .package-charge {
            font-size: 14px;
            color: var(--danger);
            margin-bottom: 5px;
        }

        .package-receive {
            font-size: 16px;
            font-weight: 700;
            color: var(--success);
        }

        /* --- MODERN SIDEBAR MENU --- */
        .sidebar-overlay {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: rgba(0,0,0,0.7); 
            z-index: 999; 
            display: none;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }
        .sidebar {
            position: fixed; 
            top: 0; 
            right: -350px;
            width: 320px; 
            height: 100%;
            background: linear-gradient(180deg, var(--dark) 0%, #0f172a 100%); 
            z-index: 1000;
            transition: right 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            display: flex;
            flex-direction: column;
            box-shadow: -10px 0 40px rgba(0,0,0,0.3);
        }
        .sidebar.active { right: 0; }
        
        .sidebar-header {
            background: rgba(255, 255, 255, 0.05); 
            padding: 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
            display: flex; 
            align-items: center; 
            justify-content: space-between;
        }
        .user-profile { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
        }
        .user-avatar { 
            width: 50px; 
            height: 50px; 
            background: linear-gradient(135deg, #60a5fa 0%, #7c3aed 100%); 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: white;
            font-size: 22px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .user-info h4 { 
            font-size: 16px; 
            font-weight: 700; 
            color: white;
            margin-bottom: 5px;
        }
        .verified-badge { 
            font-size: 11px; 
            background: linear-gradient(135deg, #10b981 0%, #059669 100%); 
            color: white; 
            padding: 4px 10px; 
            border-radius: 20px; 
            display: inline-block; 
            font-weight: 600;
        }
        .unverified-badge { 
            font-size: 11px; 
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); 
            color: white; 
            padding: 4px 10px; 
            border-radius: 20px; 
            display: inline-block; 
            font-weight: 600;
        }
        .processing-badge {
            font-size: 11px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            display: inline-block;
            font-weight: 600;
        }
        .close-menu { 
            font-size: 22px; 
            color: #94a3b8; 
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            transition: var(--transition);
        }
        .close-menu:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transform: rotate(90deg);
        }

        .sidebar-menu { 
            overflow-y: auto; 
            flex: 1; 
            padding: 20px 15px; 
        }
        .menu-item {
            display: flex; 
            align-items: center; 
            gap: 15px;
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius);
            margin-bottom: 10px;
            color: #cbd5e1;
            text-decoration: none;
            font-size: 15px;
            font-weight: 500;
            transition: var(--transition);
            cursor: pointer;
            border-left: 3px solid transparent;
        }
        .menu-item:hover { 
            background: rgba(255, 255, 255, 0.1); 
            color: white;
            transform: translateX(5px);
            border-left: 3px solid var(--primary);
        }
        .menu-item i { 
            width: 24px; 
            text-align: center; 
            color: #94a3b8;
            font-size: 18px;
        }
        .menu-item:hover i {
            color: white;
        }
        .menu-logout { 
            color: #f87171; 
            background: rgba(239, 68, 68, 0.1);
        }
        .menu-logout i { 
            color: #f87171; 
        }
        .menu-logout:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        /* --- PAGES --- */
        .page-view { 
            display: none; 
            animation: fadeIn 0.4s ease; 
            min-height: auto;
            overflow-y: auto;
        }
        .page-view.active { 
            display: block; 
        }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        @keyframes modalPop {
            0% { transform: scale(0.7); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* --- PAGE HEADERS (For non-dashboard pages) --- */
        .page-header {
            background: var(--dark); /* fallback */
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border-radius: 0;
        }
        .back-btn { 
            font-size: 20px; 
            cursor: pointer; 
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            transition: var(--transition);
        }
        .back-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(-3px);
        }
        .page-title { 
            font-size: 18px; 
            font-weight: 700; 
            flex: 1; 
            color: white; /* fallback */
        }

        /* --- PROFILE PAGE --- */
        .profile-container { 
            padding: 20px; 
            min-height: auto;
        }
        .profile-section {
            background: var(--white);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            border: 1px solid var(--light-2);
        }

        .section-label {
            font-size: 13px;
            color: var(--text-light);
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .section-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 10px;
        }
        .input-group {
            display: flex;
            gap: 12px;
            margin-top: 15px;
        }
        .profile-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--light-2);
            border-radius: var(--radius);
            font-size: 14px;
            outline: none;
            transition: var(--transition);
            background: var(--light);
        }
        .profile-input:focus {
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        .update-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            padding: 0 20px;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
            font-size: 14px;
        }
        .update-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(37, 99, 235, 0.4);
        }
        .read-only-value {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--light-2);
        }
        .read-only-value:last-child {
            border-bottom: none;
        }
        .lock-icon {
            color: #94a3b8;
            font-size: 16px;
        }
        .status-verified {
            color: #059669;
            background: #d1fae5;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .status-unverified {
            color: #dc2626;
            background: #fee2e2;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .status-processing {
            color: #92400e;
            background: #fef3c7;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        /* --- UPDATED WITHDRAW PAGE (PACKAGE BASED VERSION) - UPDATED --- */
        .withdraw-container { 
            padding: 20px; 
            min-height: auto;
        }
        .withdraw-notice {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid var(--warning);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #92400e;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            box-shadow: var(--shadow);
        }

        /* NEW: Payment Method Card Style */
        .payment-method-card {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px solid var(--light-2);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }
        
        .payment-method-card .form-label {
            font-size: 16px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .payment-method-card .form-select {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--light-2);
            border-radius: var(--radius);
            font-size: 16px;
            background: var(--white);
            transition: var(--transition);
            outline: none;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%231e293b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 20px;
            padding-right: 50px;
            cursor: pointer;
        }
        
        .payment-method-card .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        /* Available Balance Display */
        .available-balance-display {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 2px solid #a7f3d0;
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        .balance-display-amount {
            font-size: 32px;
            font-weight: 800;
            color: var(--dark);
            margin: 10px 0;
        }

        /* Calculation Preview */
        .calculation-preview {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            border: 2px solid var(--light-2);
        }
        .calc-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--light-2);
            font-size: 14px;
        }
        .calc-row:last-child {
            border-bottom: none;
            font-weight: 800;
            color: var(--success);
            font-size: 16px;
        }
        .withdraw-submit-btn {
            width: 100%;
            background: linear-gradient(135deg, var(--dark) 0%, #334155 100%);
            color: white;
            border: none;
            padding: 18px;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .withdraw-submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            background: linear-gradient(135deg, #334155 0%, var(--dark) 100%);
        }
        .withdraw-submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* --- UPDATED VERIFICATION PAGE - NEW FULL-WIDTH PAYMENT METHOD CARD --- */
        .verify-container { 
            padding: 20px; 
            min-height: auto;
        }
        .verification-instruction {
            background: linear-gradient(135deg, #fff3cd 0%, #ffecb5 100%);
            border: 2px solid #ffeeba;
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 25px;
            font-size: 14px;
            color: #92400e;
        }
        .receiver-number-box {
            padding: 15px;
            background: white;
            border-radius: var(--radius);
            border: 2px dashed #f59e0b;
            text-align: center;
            margin-top: 15px;
        }
        .receiver-number {
            font-size: 20px;
            font-weight: 800;
            color: var(--dark);
            display: block;
            margin: 10px 0;
        }
        .form-group { 
            margin-bottom: 16px; 
        }
        .btn-submit {
            width: 100%; 
            background: linear-gradient(135deg, var(--dark) 0%, #334155 100%); 
            color: white; 
            padding: 16px; 
            border: none; 
            border-radius: var(--radius); 
            font-weight: 700; 
            cursor: pointer;
            font-size: 16px;
            transition: var(--transition);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        .btn-submit:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .btn-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* --- NOTIFICATIONS PAGE --- */
        .notifications-container {
            padding: 20px;
            min-height: auto;
        }
        .notification-full-item {
            background: var(--white);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            border: 1px solid var(--light-2);
            transition: var(--transition);
        }
        .notification-full-item.unread {
            border-left: 4px solid var(--primary);
            background: #f0f9ff;
        }
        .notification-full-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }
        .notification-full-title {
            font-weight: 700;
            color: var(--dark);
            font-size: 15px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .notification-full-message {
            color: var(--text);
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 10px;
        }
        .notification-full-time {
            font-size: 12px;
            color: var(--text-light);
        }

        /* --- FLOATING BUTTON --- */
        .fab {
            position: fixed; 
            bottom: 30px; 
            right: 30px;
            width: 60px; 
            height: 60px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); 
            border-radius: 50%;
            display: flex; 
            align-items: center; 
            justify-content: center;
            color: white; 
            font-size: 24px;
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4);
            z-index: 40; 
            cursor: pointer;
            transition: var(--transition);
            border: none;
        }
        .fab:hover {
            transform: scale(1.1) rotate(15deg);
            box-shadow: 0 12px 35px rgba(37, 99, 235, 0.5);
        }

        /* --- LOGOUT MODAL --- */
        .modal-overlay {
            position: fixed; 
            top:0; 
            left:0; 
            width:100%; 
            height:100%;
            background: rgba(0,0,0,0.7); 
            z-index: 2001;
            display: none; 
            align-items: center; 
            justify-content: center;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }
        .modal-box {
            background: white; 
            width: 85%; 
            max-width: 350px;
            border-radius: var(--radius-lg); 
            padding: 25px; 
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalPop 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        .modal-title { 
            font-size: 20px; 
            font-weight: 800; 
            margin-bottom: 12px; 
            color: var(--dark);
        }
        .modal-btn-group { 
            display: flex; 
            gap: 12px; 
            margin-top: 20px; 
        }
        .btn-modal { 
            flex: 1; 
            padding: 12px; 
            border-radius: var(--radius); 
            border: none; 
            font-weight: 700; 
            cursor: pointer; 
            transition: var(--transition);
            font-size: 14px;
        }
        .btn-cancel { 
            background: var(--light); 
            color: var(--text); 
            border: 2px solid var(--light-2);
        }
        .btn-cancel:hover {
            background: #e2e8f0;
            transform: translateY(-2px);
        }
        .btn-confirm { 
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%); 
            color: white; 
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }
        .btn-confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        /* --- UPDATED SALARY PAGE WITH IMPROVED UI --- */
        .salary-package-card {
            background: var(--white);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            border: 1px solid var(--light-2);
            transition: var(--transition);
            position: relative;
        }
        .salary-package-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.12);
            border-color: var(--primary-light);
        }
        .salary-package-card.locked {
            opacity: 1;
            pointer-events: auto;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }
        /* Remove the big lock icon from middle */
        .salary-package-card.locked::after {
            display: none;
        }
        .salary-amount-bdt {
            font-size: 24px;
            font-weight: 800;
            color: var(--success);
            margin-top: 8px;
        }
        .salary-amount-bdt::before {
            content: 'à§³';
            font-size: 20px;
            margin-right: 2px;
        }
        .salary-requirement {
            font-size: 14px;
            color: var(--text);
            margin-top: 5px;
        }
        .salary-requirement .verified-count {
            color: var(--success);
            font-weight: 700;
        }
        .salary-requirement .required-count {
            color: var(--text);
            font-weight: 700;
        }
        
        /* Improved text visibility for locked packages */
        .salary-package-card.locked .salary-amount-bdt {
            color: var(--text-light) !important;
        }
        .salary-package-card.locked .salary-requirement {
            color: var(--text-light) !important;
        }
        .salary-package-card.locked .salary-requirement .required-count {
            color: var(--text-light) !important;
        }

        /* Disabled button style */
        .master-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Salary Tables - REMOVED (no longer used) */

        /* --- RESPONSIVE DESIGN --- */
        @media (max-width: 768px) {
            body {
                padding: 0;
            }
            #app-container {
                min-height: 100vh;
            }
            .wallet-grid {
                grid-template-columns: repeat(2, 1fr);
                padding: 0 10px 20px;
            }
            .main-balance-card {
                padding: 14px;
                min-height: 90px;
                border-radius: 0;
            }
            .balance-amount {
                font-size: 24px;
            }
            .method-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 0;
            }
            #app-container {
                min-height: 100vh;
                border-radius: 0;
            }
            .dashboard-header {
                padding: 15px;
            }
            .wallet-grid {
                grid-template-columns: repeat(2, 1fr);
                padding: 0 10px 20px;
            }
            .timer-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            .method-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .fab {
                width: 55px;
                height: 55px;
                bottom: 25px;
                right: 25px;
            }
            .status-alert {
                padding: 10px 16px;
                min-height: 44px;
            }
            .main-balance-card {
                min-height: 85px;
                padding: 12px;
                border-radius: 0;
            }
            .balance-amount {
                font-size: 22px;
            }
            .stat-card {
                min-height: 75px;
                padding: 10px;
            }
            .card-amount {
                font-size: 15px;
            }
            .card-icon-area {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }
        }

        /* --- LOADING STATES --- */
        .loading {
            position: relative;
            pointer-events: none;
            opacity: 0.7;
        }
        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 3px solid rgba(0,0,0,0.1);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* --- TEMPORARY TOAST MESSAGES --- */
        .toast-message {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--success);
            color: white;
            padding: 12px 20px;
            border-radius: var(--radius);
            font-weight: 600;
            z-index: 3000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            max-width: 90%;
            text-align: center;
            opacity: 0;
        }
        .toast-message.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        .toast-message.error {
            background: var(--danger);
        }
        .toast-message.warning {
            background: var(--warning);
        }

        /* --- OTHER COMPONENTS --- */
        .free-job-container, 
        .gmail-sell-container, 
        .referral-system-container, 
        .salary-apply-container, 
        .my-referrals-container,
        .help-line-container,
        .top-ref-container,
        .job-submissions-container {
            padding: 20px;
            min-height: auto;
        }

        .category-card,
        .task-card,
        .generation-card,
        .salary-package-card,
        .support-card,
        .podium-card,
        .leaderboard-row {
            background: var(--white);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            border: 1px solid var(--light-2);
            transition: var(--transition);
        }

        .category-card:hover,
        .task-card:hover,
        .generation-card:hover,
        .salary-package-card:hover,
        .support-card:hover,
        .podium-card:hover,
        .leaderboard-row:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.12);
            border-color: var(--primary-light);
        }

        .badge-pending,
        .badge-approved,
        .badge-rejected {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .badge-pending {
            background: #fef3c7;
            color: #92400e;
        }
        .badge-approved {
            background: #d1fae5;
            color: #059669;
        }
        .badge-rejected {
            background: #fee2e2;
            color: #dc2626;
        }

        /* --- COMPACT LEADERBOARD STYLES --- */
        .top-three-section {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 10px;
            margin: 20px 0;
        }
        
        .podium-card {
            background: var(--white);
            border-radius: var(--radius);
            padding: 15px 10px;
            text-align: center;
            box-shadow: var(--shadow);
            min-width: 80px;
            flex: 1;
        }
        
        .podium-card.first {
            order: 2;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid var(--warning);
            height: 100px;
        }
        
        .podium-card.second {
            order: 1;
            background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
            border: 2px solid #9ca3af;
            height: 80px;
        }
        
        .podium-card.third {
            order: 3;
            background: linear-gradient(135deg, #fcd34d 0%, #fbbf24 100%);
            border: 2px solid #d97706;
            height: 70px;
        }
        
        .rank-badge {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .podium-user {
            font-size: 12px;
            font-weight: 600;
            color: var(--dark);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 5px;
        }
        
        .podium-count {
            font-size: 16px;
            font-weight: 800;
            color: var(--dark);
        }
        
        .podium-label {
            font-size: 9px;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Compact Leaderboard Rows */
        .leaderboard-row {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            background: var(--white);
            border-radius: var(--radius);
            margin-bottom: 8px;
            box-shadow: var(--shadow);
            border: 1px solid var(--light-2);
            transition: var(--transition);
            height: 50px;
        }
        
        .leaderboard-row:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }
        
        .row-rank {
            width: 30px;
            font-size: 14px;
            font-weight: 700;
            color: var(--dark);
            text-align: center;
        }
        
        .row-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .row-user {
            font-size: 13px;
            font-weight: 600;
            color: var(--dark);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .row-refs {
            font-size: 10px;
            color: var(--text-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .row-count {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark);
            min-width: 50px;
            text-align: right;
        }

        /* Support Card Compact */
        .support-card {
            background: var(--white);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            border: 1px solid var(--light-2);
            text-align: center;
        }
        
        .support-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            color: white;
            font-size: 20px;
        }
        
        .support-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 8px;
        }
        
        .support-desc {
            font-size: 13px;
            color: var(--text-light);
            margin-bottom: 15px;
            line-height: 1.4;
        }
        
        .support-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 0 auto;
            width: 100%;
            max-width: 200px;
        }
        
        .support-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(37, 99, 235, 0.3);
        }

        /* --- SCROLLBAR STYLING --- */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: var(--light);
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--primary-light);
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        /* --- GMAIL SELL SPECIFIC STYLES --- */
        .gmail-status-cards {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin: 20px 0;
        }
        
        .gmail-status-card {
            flex: 1;
            text-align: center;
            padding: 15px 10px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            transition: var(--transition);
        }
        
        .gmail-status-card.processing {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid var(--warning);
        }
        
        .gmail-status-card.approved {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border: 2px solid var(--success);
        }
        
        .gmail-status-card.rejected {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border: 2px solid var(--danger);
        }
        
        .gmail-status-count {
            font-size: 24px;
            font-weight: 800;
            margin: 5px 0;
        }
        
        .gmail-status-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .gmail-price-box {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #bae6fd;
            border-radius: var(--radius);
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .gmail-price-amount {
            font-size: 32px;
            font-weight: 800;
            color: var(--dark);
            margin: 10px 0;
        }
        
        .password-today-box {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 2px solid #a7f3d0;
            border-radius: var(--radius);
            padding: 20px;
            margin: 20px 0;
        }
        
        .password-display {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark);
            background: white;
            padding: 12px;
            border-radius: var(--radius);
            border: 2px dashed #10b981;
            text-align: center;
            margin: 15px 0;
            font-family: monospace;
        }
        
        .gmail-notice-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }
        
        .gmail-notice-modal-overlay.active {
            display: flex;
        }
        
        .gmail-notice-modal {
            background: white;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalPop 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        
        .gmail-notice-modal-header {
            background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .gmail-notice-modal-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .gmail-notice-modal-content {
            padding: 25px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.6;
            color: var(--text);
        }
        
        .gmail-notice-modal-actions {
            padding: 20px;
            border-top: 1px solid var(--light-2);
            display: flex;
            justify-content: center;
        }
        
        .gmail-notice-close-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .gmail-notice-close-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(37, 99, 235, 0.3);
        }

        /* --- GMAIL PROCESSING PAGE STYLES --- */
        .gmail-processing-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .gmail-processing-table th {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 12px;
            text-align: left;
            color: var(--dark);
            font-weight: 700;
            border-bottom: 2px solid var(--light-2);
            font-size: 13px;
        }
        
        .gmail-processing-table td {
            padding: 12px;
            border-bottom: 1px solid var(--light-2);
            font-size: 13px;
        }
        
        .gmail-processing-table tr:hover {
            background: #f8fafc;
        }

        /* --- GMAIL SUMMARY CARDS (NEW) --- */
        .gmail-summary-cards {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }
        .gmail-summary-card {
            flex: 1;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: var(--radius);
            padding: 15px;
            text-align: center;
            border: 2px solid var(--light-2);
        }
        .gmail-summary-card-value {
            font-size: 24px;
            font-weight: 800;
            color: var(--dark);
            margin-bottom: 5px;
        }
        .gmail-summary-card-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-light);
            text-transform: uppercase;
        }

        /* --- UNIFIED BUTTON DESIGN --- */
        .master-btn {
            width: 100%;
            padding: 16px 24px;
            border: none;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-decoration: none;
            margin: 15px 0;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
            min-height: 52px;
        }
        
        .master-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .master-btn:active {
            transform: translateY(-1px);
        }
        
        .master-btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }
        
        .master-btn-primary:hover {
            box-shadow: 0 10px 25px rgba(37, 99, 235, 0.4);
        }
        
        .master-btn-green {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
        }
        
        .master-btn-green:hover {
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.4);
        }
        
        .master-btn-red {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            color: white;
        }
        
        .master-btn-red:hover {
            box-shadow: 0 10px 25px rgba(239, 68, 68, 0.4);
        }
        
        .master-btn-dark {
            background: linear-gradient(135deg, var(--dark) 0%, #334155 100%);
            color: white;
        }
        
        .master-btn-dark:hover {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        
        .master-btn-orange {
            background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
            color: white;
        }
        
        .master-btn-orange:hover {
            box-shadow: 0 10px 25px rgba(245, 158, 11, 0.4);
        }
        
        .master-btn-sm {
            padding: 12px 20px;
            font-size: 14px;
            min-height: 44px;
            width: auto;
            margin: 0 5px;
        }
        
        .master-btn-full {
            width: 100%;
        }
        
        .master-btn-disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .master-btn-disabled:hover {
            transform: none;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        
        /* --- REFERRAL SYSTEM SPECIFIC STYLES --- */
        .referral-status-card {
            background: var(--white);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            border: 1px solid var(--light-2);
            text-align: center;
        }
        
        .referral-stat-number {
            font-size: 36px;
            font-weight: 800;
            margin: 10px 0;
            color: var(--dark);
        }
        
        .referral-stat-label {
            font-size: 14px;
            color: var(--text-light);
            font-weight: 600;
        }
        
        .referral-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            border-bottom: 1px solid var(--light-2);
            transition: var(--transition);
        }
        
        .referral-item:hover {
            background: #f8fafc;
        }
        
        .referral-item-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .referral-item-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }
        
        .referral-item-details {
            flex: 1;
        }
        
        .referral-item-name {
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
        }
        
        .referral-item-date {
            font-size: 12px;
            color: var(--text-light);
        }
        
        .referral-item-status {
            font-size: 12px;
            font-weight: 600;
            padding: 5px 12px;
            border-radius: 20px;
        }
        
        .referral-item-pending {
            background: #fef3c7;
            color: #92400e;
        }
        
        .referral-item-verified {
            background: #d1fae5;
            color: #059669;
        }
        
        .referral-item-amount {
            font-size: 14px;
            font-weight: 700;
            color: var(--success);
        }

        /* ========== FREE JOB SYSTEM STYLES ========== */
        .free-job-project-card,
        .free-job-card-item,
        .free-job-item {
            background: var(--white);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            border: 1px solid var(--light-2);
            transition: var(--transition);
            cursor: pointer;
        }
        .free-job-project-card:hover,
        .free-job-card-item:hover,
        .free-job-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.12);
            border-color: var(--primary-light);
        }
        .free-job-project-locked,
        .free-job-card-locked,
        .free-job-locked {
            opacity: 0.6;
            pointer-events: none;
            position: relative;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }
        .free-job-project-locked::after,
        .free-job-card-locked::after,
        .free-job-locked::after {
            content: '\f023';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: #94a3b8;
            z-index: 2;
        }
        .free-job-project-coming {
            opacity: 0.8;
            pointer-events: none;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        }
        .free-job-project-coming::after {
            content: 'Coming Soon';
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--warning);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }
        .free-job-job-banner {
            width: 100%;
            height: 160px;
            object-fit: cover;
            border-radius: var(--radius);
            margin-bottom: 16px;
            border: 1px solid var(--light-2);
        }
        .free-job-instruction-step {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--light-2);
        }
        .free-job-step-number {
            width: 24px;
            height: 24px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            flex-shrink: 0;
        }
        .free-job-step-text {
            font-size: 14px;
            color: var(--dark);
            line-height: 1.5;
        }
        .free-job-proof-section {
            background: var(--light);
            border-radius: var(--radius);
            padding: 16px;
            margin-top: 20px;
        }
        .free-job-upload-area {
            margin-bottom: 15px;
        }
        .free-job-upload-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 8px;
        }
        .free-job-file-input {
            width: 100%;
            padding: 12px;
            background: white;
            border: 2px dashed var(--primary-light);
            border-radius: var(--radius);
            cursor: pointer;
        }
        .free-job-link-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--light-2);
            border-radius: var(--radius);
            font-size: 14px;
        }

        /* --- JOB SUBMISSIONS PAGE STYLES --- */
        .job-submission-card {
            background: var(--white);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            border: 1px solid var(--light-2);
            transition: var(--transition);
        }
        .job-submission-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.12);
            border-color: var(--primary-light);
        }
        .submission-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .submission-project {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark);
            background: var(--light);
            padding: 6px 12px;
            border-radius: 20px;
        }
        .submission-status {
            font-size: 12px;
            font-weight: 700;
            padding: 6px 12px;
            border-radius: 20px;
        }
        .submission-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 15px 0;
            padding: 15px 0;
            border-top: 1px solid var(--light-2);
            border-bottom: 1px solid var(--light-2);
        }
        .submission-detail-item {
            font-size: 13px;
            color: var(--text);
        }
        .submission-detail-label {
            font-weight: 600;
            color: var(--text-light);
            margin-right: 6px;
        }
        .submission-proofs {
            background: var(--light);
            border-radius: var(--radius);
            padding: 15px;
            margin-bottom: 15px;
            font-size: 13px;
        }
        .submission-proof-title {
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 8px;
        }
        .submission-proof-item {
            display: flex;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px dashed var(--light-2);
        }
        .submission-proof-item:last-child {
            border-bottom: none;
        }
        .submission-proof-key {
            font-weight: 600;
            color: var(--text-light);
            min-width: 100px;
        }
        .submission-proof-value {
            font-weight: 500;
            color: var(--dark);
            word-break: break-all;
        }
        .filter-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .filter-tab {
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            background: var(--light);
            color: var(--text);
            border: 2px solid var(--light-2);
        }
        .filter-tab.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-color: transparent;
        }
        .summary-cards {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }
        .summary-card {
            flex: 1;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: var(--radius);
            padding: 15px;
            text-align: center;
            border: 2px solid var(--light-2);
        }
        .summary-card-value {
            font-size: 24px;
            font-weight: 800;
            color: var(--dark);
            margin-bottom: 5px;
        }
        .summary-card-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-light);
            text-transform: uppercase;
        }

        /* --- MEDIA SLIDER STYLES --- */
        .media-slider-container {
            position: relative;
            width: 100%;
            margin-bottom: 20px;
            border-radius: var(--radius);
            overflow: hidden;
            background: #000;
        }
        .media-slide {
            display: none;
            width: 100%;
        }
        .media-slide.active {
            display: block;
        }
        .media-slide img, .media-slide video {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        .slider-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            z-index: 10;
        }
        .slider-btn:hover {
            background: rgba(0,0,0,0.8);
            transform: translateY(-50%) scale(1.1);
        }
        .slider-btn.prev {
            left: 10px;
        }
        .slider-btn.next {
            right: 10px;
        }
        .media-indicators {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            z-index: 10;
        }
        .media-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
            cursor: pointer;
            transition: var(--transition);
        }
        .media-dot.active {
            background: white;
            transform: scale(1.2);
        }
    </style>
</head>
<body>

    <!-- MAINTENANCE OVERLAY -->
    <div class="maintenance-overlay" id="maintenance-overlay">
        <div class="maintenance-content">
            <div class="maintenance-icon">
                <i class="fa-solid fa-tools"></i>
            </div>
            <h2 class="maintenance-title">Under Maintenance</h2>
            <p class="maintenance-message" id="maintenance-message">
                We're currently performing some maintenance. We'll be back soon!
            </p>
        </div>
    </div>

    <!-- AUTHENTICATION SCREENS (Shown by Default) -->
    <div id="auth-container" class="auth-container">
        <!-- Welcome Screen -->
        <div id="welcome-screen" class="welcome-screen">
            <div class="welcome-logo">
                <i class="fa-solid fa-wallet"></i>
            </div>
            <h1 class="welcome-title">WELCOME BACK</h1>
            
            <button class="auth-btn auth-btn-primary" onclick="showSignIn()">
                <i class="fa-solid fa-right-to-bracket"></i> SIGN IN
            </button>
            
            <button class="auth-btn auth-btn-secondary" onclick="showSignUp()">
                <i class="fa-solid fa-user-plus"></i> SIGN UP
            </button>
        </div>

        <!-- Sign In Screen -->
        <div id="signin-screen" class="auth-screen" style="display: none;">
            <button class="back-btn-auth" onclick="showWelcome()">
                <i class="fa-solid fa-arrow-left"></i>
            </button>
            
            <div class="auth-header">
                <h1 class="auth-title">HELLO SIGN IN</h1>
                <p class="auth-subtitle">Welcome back! Please sign in to continue</p>
            </div>

            <div class="error-message" id="signin-error">
                <i class="fa-solid fa-exclamation-circle"></i>
                <span id="signin-error-text"></span>
            </div>

            <form class="auth-form" id="signin-form" onsubmit="signIn(event)">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="signin-email" placeholder="Joydeo@gmail.com" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="signin-password" placeholder="Password" required>
                </div>
                
                <a href="#" class="forgot-link" onclick="showForgotPassword()">Forgot password?</a>
                
                <button type="submit" class="auth-btn auth-btn-primary" id="signin-btn">
                    <i class="fa-solid fa-right-to-bracket"></i> SIGN IN
                </button>
            </form>

            <div class="auth-footer">
                Don't have account? 
                <a href="#" class="auth-link" onclick="showSignUp()">Sign up</a>
            </div>
        </div>

        <!-- Sign Up Screen -->
        <div id="signup-screen" class="auth-screen" style="display: none;">
            <button class="back-btn-auth" onclick="showSignIn()">
                <i class="fa-solid fa-arrow-left"></i>
            </button>
            
            <div class="auth-header">
                <h1 class="auth-title">CREATE YOUR ACCOUNT</h1>
                <p class="auth-subtitle">Join us and start your journey</p>
            </div>

            <div class="error-message" id="signup-error">
                <i class="fa-solid fa-exclamation-circle"></i>
                <span id="signup-error-text"></span>
            </div>

            <form class="auth-form" id="signup-form" onsubmit="signUp(event)">
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" class="form-input" id="signup-name" placeholder="Full Name" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="signup-email" placeholder="Phone or Email" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="signup-password" placeholder="Password" required minlength="6">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Confirm Password</label>
                    <input type="password" class="form-input" id="signup-confirm-password" placeholder="Confirm Password" required minlength="6">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Referral Code (Optional)</label>
                    <input type="text" class="form-input" id="signup-referral" placeholder="Referral Code">
                </div>
                
                <button type="submit" class="auth-btn auth-btn-primary" id="signup-btn">
                    <i class="fa-solid fa-user-plus"></i> SIGN UP
                </button>
            </form>

            <div class="auth-footer">
                Already have an account? 
                <a href="#" class="auth-link" onclick="showSignIn()">Sign In</a>
            </div>
        </div>

        <!-- Forgot Password Screen -->
        <div id="forgot-password-screen" class="auth-screen" style="display: none;">
            <button class="back-btn-auth" onclick="showSignIn()">
                <i class="fa-solid fa-arrow-left"></i>
            </button>
            
            <div class="auth-header">
                <h1 class="auth-title">Reset Password</h1>
                <p class="auth-subtitle">Enter your email to reset password</p>
            </div>

            <div class="error-message" id="forgot-error" style="display: none;">
                <i class="fa-solid fa-exclamation-circle"></i>
                <span id="forgot-error-text"></span>
            </div>

            <div class="success-message" id="forgot-success" style="display: none;">
                <i class="fa-solid fa-check-circle"></i>
                <span id="forgot-success-text"></span>
            </div>

            <form class="auth-form" id="forgot-form" onsubmit="resetPassword(event)">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="forgot-email" placeholder="Enter your email" required>
                </div>
                
                <button type="submit" class="auth-btn auth-btn-primary" id="forgot-btn">
                    <i class="fa-solid fa-key"></i> Reset Password
                </button>
            </form>

            <div class="auth-footer">
                Already have an account? 
                <a href="#" class="auth-link" onclick="showSignIn()">Sign In</a>
            </div>
        </div>
    </div>

    <!-- MAIN APP CONTAINER (Hidden until authentication) -->
    <div id="app-container" style="display: none;">
        
        <!-- DASHBOARD VIEW -->
        <div id="dashboard-view" class="page-view active">
            <!-- UPDATED DASHBOARD HEADER (dynamic colors & logo) -->
            <header class="dashboard-header">
                <div class="logo" id="dashboard-logo">
                    <!-- Logo will be dynamically injected by Firestore config -->
                    <i class="fa-solid fa-wallet"></i>
                    <span id="app-name">SmartPay</span>
                </div>
                <div class="header-actions">
                    <div class="menu-btn" onclick="toggleMenu()">
                        <i class="fa-solid fa-bars"></i>
                    </div>
                </div>
            </header>

            <!-- ONE-LINE VERIFICATION STATUS (Dashboard Only) -->
            <div class="status-alert" id="verification-status-alert">
                <p><i class="fa-solid fa-shield-exclamation"></i> <span id="verification-text">Account not verified</span></p>
                <button class="master-btn master-btn-red master-btn-sm" onclick="navigateTo('verify')"><span id="verify-btn-text">Verify</span></button>
            </div>

            <!-- UPDATED LIVE TIMER SECTION (dynamic colors) -->
            <div class="timer-section">
                <div class="timer-header">
                    <span class="timer-title">Live Timer</span>
                    <span class="launch-date" id="launch-date-display">
                        <span id="launch-badge-dot" style="width: 8px; height: 8px; background: #10b981; border-radius: 50%; display: inline-block; margin-right: 4px;"></span>
                        <span id="launch-text">Launch: Admin Panel</span>
                    </span>
                </div>
                <div class="timer-grid">
                    <div class="timer-box"><span class="timer-val" id="t-hour">00</span><span class="timer-label">Hour</span></div>
                    <div class="timer-box"><span class="timer-val" id="t-minute">00</span><span class="timer-label">Minute</span></div>
                    <div class="timer-box"><span class="timer-val" id="t-second">00</span><span class="timer-label">Second</span></div>
                </div>
                <p style="font-size: 11px; color: #fca5a5; margin-top: 10px; font-weight: 600; text-align: center; letter-spacing: 0.5px;">
                    <i class="fa-solid fa-triangle-exclamation"></i> <span id="warning-text">à¦à¦à¦¾à¦§à¦¿à¦ à¦à¦à¦¾à¦à¦¨à§à¦ à¦à¦°à¦¬à§à¦¨ à¦¨à¦¾ - à¦¸à¦¬ à¦à¦à¦¾à¦à¦¨à§à¦ à¦¸à¦¾à¦¸à¦ªà§à¦¨à§à¦¡</span>
                </p>
            </div>

            <!-- MARQUEE SECTION -->
            <div class="marquee-container" id="marquee-container">
                <div class="marquee-text" id="marquee-text-element">
                    <i class="fa-solid fa-circle-info"></i> <span id="marquee-text">à¦à¦ªà¦¨à¦¾à¦° à¦à§à¦¯à¦¾à¦à¦¾à¦à¦¨à§à¦ à¦¸à¦à¦à§à¦°à¦¾à¦¨à§à¦¤ à¦à§à¦¨à§ à¦à§à¦¡, OTP, Email à¦¬à¦¾ Password à¦à¦¾à¦°à§ à¦¸à¦¾à¦¥à§ à¦¶à§à¦¯à¦¼à¦¾à¦° à¦à¦°à¦¬à§à¦¨ à¦¨à¦¾à¥¤ à¦¹à§à¦²à§à¦ªà¦²à¦¾à¦à¦¨ à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦° à¦à¦°à§à¦¨à¥¤</span>
                </div>
            </div>

            <!-- TEMPORARY NOTICE TRIGGER -->
            <div class="notice-trigger" id="notice-trigger" onclick="showMessageModal()">
                <div class="notice-left">
                    <span class="dot"></span> <span id="notice-title">Important Notice</span>
                </div>
                <button class="master-btn master-btn-primary master-btn-sm">Tap to view</button>
            </div>

            <!-- UPDATED COMPACT WALLET SECTION -->
            <div class="wallet-section">
                <h3 class="section-title">Your Wallets <span>Balances & summary</span></h3>
                
                <div class="wallet-grid">
                    <!-- Main Balance Card - Spans 2 columns -->
                    <div class="main-balance-card">
                        <div class="balance-label">Available Balance</div>
                        <div class="balance-amount"><span id="main-balance">0.00</span></div>
                        <p class="balance-subtext">Instant withdrawal available</p>
                    </div>

                    <!-- Other Wallets - 2 per row -->
                    <div class="stat-card" onclick="navigateTo('referral-system')">
                        <div class="card-icon-area bg-blue"><i class="fa-solid fa-users"></i></div>
                        <div class="card-amount" id="referral-income">0.00</div>
                        <div class="card-title">Referral Income</div>
                    </div>
                    <div class="stat-card" onclick="navigateTo('salary-apply')">
                        <div class="card-icon-area bg-teal"><i class="fa-solid fa-money-bill-wave"></i></div>
                        <div class="card-amount" id="salary-wallet">0.00</div>
                        <div class="card-title">Salary Wallet</div>
                    </div>
                    <div class="stat-card">
                        <div class="card-icon-area bg-orange"><i class="fa-solid fa-chart-line"></i></div>
                        <div class="card-amount" id="total-income">0</div>
                        <div class="card-title">Total Income</div>
                    </div>
                    <div class="stat-card" onclick="navigateTo('withdraw')">
                        <div class="card-icon-area bg-blue"><i class="fa-solid fa-arrow-down"></i></div>
                        <div class="card-amount" id="total-withdraw">0</div>
                        <div class="card-title">Total Withdraw</div>
                    </div>
                    <div class="stat-card" onclick="navigateTo('gmail-sell')">
                        <div class="card-icon-area bg-purple"><i class="fa-solid fa-envelope"></i></div>
                        <div class="card-amount" id="gmail-wallet">0.00</div>
                        <div class="card-title">Gmail Wallet</div>
                    </div>
                    <!-- ===== FREE JOB WALLET CARD ===== -->
                    <div class="stat-card" onclick="navigateTo('free-job-projects')">
                        <div class="card-icon-area bg-yellow"><i class="fa-solid fa-briefcase"></i></div>
                        <div class="card-amount" id="free-job-balance">0.00</div>
                        <div class="card-title">Free Job Wallet</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TEMPORARY MESSAGE VIEW MODAL -->
        <div class="message-modal-overlay" id="message-modal">
            <div class="message-modal">
                <div class="message-modal-header">
                    <div class="message-modal-title">
                        <i class="fa-solid fa-bell"></i>
                        <span id="message-title">SmartPay Wallet</span>
                    </div>
                    <div class="message-modal-close" onclick="closeMessageModal()">
                        <i class="fa-solid fa-times"></i>
                    </div>
                </div>
                <div class="message-modal-content">
                    <div class="message-modal-text" id="message-content">
                        Welcome to SmartPay Wallet!<br><br>
                        Features included:
                        <br>â¢ Dashboard with wallet balances
                        <br>â¢ Profile page
                        <br>â¢ Help Line page
                        <br>â¢ Withdraw page
                        <br>â¢ Verification page
                        <br>â¢ Gmail Sell page
                        <br>â¢ Referral system
                        <br>â¢ Salary apply system
                        <br>â¢ Processing page
                        <br><br>
                        All data is stored securely in Firebase Firestore.
                    </div>
                </div>
                <div class="message-modal-actions">
                    <button class="master-btn master-btn-primary" onclick="closeMessageModal()">Close</button>
                </div>
            </div>
        </div>

        <!-- HELP LINE PAGE -->
        <div id="help-line-view" class="page-view">
            <div class="page-header">
                <div class="back-btn" onclick="navigateTo('dashboard')">
                    <i class="fa-solid fa-arrow-left"></i>
                </div>
                <div class="page-title">Help Line</div>
            </div>

            <div class="help-line-container">
                <!-- Support Cards will be loaded dynamically from Firestore -->
                <div id="support-cards-container">
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-light);">
                        <i class="fa-solid fa-spinner fa-spin" style="font-size: 48px; margin-bottom: 20px;"></i>
                        <p>Loading support information...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- PROFILE PAGE -->
        <div id="profile-view" class="page-view">
            <div class="page-header">
                <div class="back-btn" onclick="navigateTo('dashboard')">
                    <i class="fa-solid fa-arrow-left"></i>
                </div>
                <div class="page-title">Profile</div>
            </div>

            <div class="profile-container">
                <!-- Username Section -->
                <div class="profile-section">
                    <div class="section-label">
                        <i class="fa-solid fa-user"></i>
                        Username
                    </div>
                    <div class="input-group">
                        <input type="text" class="profile-input" id="username-input" placeholder="Enter your username" value="">
                        <button class="master-btn master-btn-primary master-btn-sm" onclick="updateUsername()">Update</button>
                    </div>
                    <p style="font-size: 13px; color: var(--text-light); margin-top: 10px; display: flex; align-items: flex-start; gap: 8px;">
                        <i class="fa-solid fa-circle-info" style="color: var(--primary); margin-top: 2px;"></i>
                        You can change your username anytime. Other users will see this name.
                    </p>
                </div>

                <!-- Email Address -->
                <div class="profile-section">
                    <div class="section-label">
                        <i class="fa-solid fa-envelope"></i>
                        Email Address
                    </div>
                    <div class="read-only-value">
                        <div>
                            <div class="section-value" id="user-email">loading...</div>
                            <div style="font-size: 13px; color: var(--text-light);">Used for login and notifications</div>
                        </div>
                        <div class="lock-icon">
                            <i class="fa-solid fa-lock"></i>
                        </div>
                    </div>
                </div>

                <!-- Account Status -->
                <div class="profile-section">
                    <div class="section-label">
                        <i class="fa-solid fa-shield-halved"></i>
                        Account Status
                    </div>
                    <div class="read-only-value">
                        <div>
                            <div class="section-value" id="account-status-display">
                                <span class="status-unverified"><i class="fa-solid fa-xmark"></i> Non-Verified</span>
                            </div>
                            <div style="font-size: 13px; color: var(--text-light);">
                                Account verification required for full access
                            </div>
                        </div>
                        <div id="verify-now-button-cell">
                            <button class="master-btn master-btn-red master-btn-sm" onclick="navigateTo('verify')">Verify Now</button>
                        </div>
                    </div>
                </div>

                <!-- Join Date -->
                <div class="profile-section">
                    <div class="section-label">
                        <i class="fa-solid fa-calendar-plus"></i>
                        Join Date
                    </div>
                    <div class="read-only-value">
                        <div>
                            <div class="section-value" id="join-date">Loading...</div>
                            <div style="font-size: 13px; color: var(--text-light);">Your account creation date</div>
                        </div>
                        <div class="lock-icon">
                            <i class="fa-solid fa-lock"></i>
                        </div>
                    </div>
                </div>

                <!-- Referral ID -->
                <div class="profile-section">
                    <div class="section-label">
                        <i class="fa-solid fa-link"></i>
                        Referral ID
                    </div>
                    <div class="read-only-value">
                        <div>
                            <div class="section-value" id="referral-id-display">Loading...</div>
                            <div style="font-size: 13px; color: var(--text-light);">Share this ID to earn referral income</div>
                        </div>
                        <div class="lock-icon">
                            <i class="fa-solid fa-lock"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- UPDATED WITHDRAW PAGE (PACKAGE BASED VERSION) - 100% FIRESTORE DRIVEN, WALLET-WISE -->
        <div id="withdraw-view" class="page-view">
            <div class="page-header">
                <div class="back-btn" onclick="navigateTo('dashboard')">
                    <i class="fa-solid fa-arrow-left"></i>
                </div>
                <div class="page-title">Withdraw Money</div>
            </div>

            <div class="withdraw-container">
                <!-- Notice Section -->
                <div class="withdraw-notice">
                    <i class="fa-solid fa-bell"></i>
                    <span id="withdraw-notice-text">Minimum withdraw amount is à§³500. Processing time: 24-48 hours.</span>
                </div>

                <!-- Payment Method Card Style -->
                <div class="payment-method-card">
                    <div class="form-label">
                        <i class="fa-solid fa-credit-card"></i>
                        Payment Method
                    </div>
                    <select class="form-select" id="withdraw-payment-method">
                        <option value="">Select payment method</option>
                        <!-- Options will be loaded from Firestore -->
                    </select>
                </div>

                <!-- Receiver Number Input -->
                <div class="withdraw-form-group">
                    <div class="form-label">Receiver Number (à¦¯à§ à¦¨à¦¾à¦®à§à¦¬à¦¾à¦°à§ à¦à¦¾à¦à¦¾ à¦¯à¦¾à¦¬à§)</div>
                    <input type="number" class="form-input" id="receiver-number" placeholder="01XXXXXXXXX" maxlength="11">
                    <p style="font-size: 13px; color: var(--text-light); margin-top: 8px;">
                        <i class="fa-solid fa-info-circle"></i> Enter 11-digit Bangladeshi mobile number
                    </p>
                </div>

                <!-- ========== NEW: WALLET SELECTION CARD ========== -->
                <div class="payment-method-card" id="wallet-selection-card">
                    <div class="form-label">
                        <i class="fa-solid fa-wallet"></i>
                        Select Wallet to Withdraw From
                    </div>
                    <select class="form-select" id="withdraw-wallet-select">
                        <option value="">Loading wallets...</option>
                    </select>
                </div>
                <!-- ================================================ -->

                <!-- Available Balance Display (shows selected wallet balance) -->
                <div class="available-balance-display">
                    <div class="form-label">Wallet Balance</div>
                    <div class="balance-display-amount">à§³<span id="withdraw-available-balance">0.00</span></div>
                    <div style="font-size: 13px; color: var(--text-light);">You are withdrawing from the selected wallet</div>
                </div>

                <!-- Withdraw Package Selection (wallet-wise) -->
                <div class="withdraw-form-group">
                    <div class="form-label">Select Withdraw Package</div>
                    <div class="package-grid" id="withdraw-package-grid">
                        <!-- Packages will be loaded dynamically from Firestore for selected wallet -->
                    </div>
                </div>

                <!-- Calculation Preview -->
                <div class="calculation-preview">
                    <div class="form-label">Calculation Preview</div>
                    <div class="calc-row">
                        <span>Selected Package:</span>
                        <span id="calc-package-name">-</span>
                    </div>
                    <div class="calc-row">
                        <span>Withdraw Amount:</span>
                        <span id="calc-amount">à§³0</span>
                    </div>
                    <div class="calc-row">
                        <span>Charge:</span>
                        <span id="calc-charge">à§³0</span>
                    </div>
                    <div class="calc-row">
                        <span>Receive Amount:</span>
                        <span id="calc-receive">à§³0</span>
                    </div>
                </div>

                <!-- Submit Button -->
                <button class="master-btn master-btn-dark master-btn-full" onclick="submitWithdraw()" id="withdraw-submit-btn">
                    <i class="fa-solid fa-money-bill-transfer"></i> Withdraw Now
                </button>

                <!-- Withdraw History Button -->
                <button class="master-btn master-btn-primary master-btn-full" onclick="navigateTo('withdraw-processing')">
                    <i class="fa-solid fa-history"></i> Withdraw History
                </button>
            </div>
        </div>

        <!-- NEW: WITHDRAW PROCESSING/HISTORY PAGE (Gmail Processing Style) -->
        <div id="withdraw-processing-view" class="page-view">
            <div class="page-header">
                <div class="back-btn" onclick="navigateTo('withdraw')">
                    <i class="fa-solid fa-arrow-left"></i>
                </div>
                <div class="page-title">Withdraw Processing</div>
            </div>
            <div class="withdraw-processing-container" style="padding: 20px;">
                <!-- Withdraw Processing Table -->
                <div class="form-card">
                    <h4 style="margin-bottom: 20px; color: var(--dark);">Withdraw History</h4>
                    <div style="overflow-x: auto;">
                        <table class="gmail-processing-table" style="min-width: 500px;">
                            <thead>
                                <tr>
                                    <th>SL</th>
                                    <th>Amount (à§³)</th>
                                    <th>Payment Method</th>
                                    <th>Receiver Number</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="withdraw-processing-tbody">
                                <!-- Content will be loaded from Firestore -->
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 40px; color: var(--text-light);">
                                        <i class="fa-solid fa-inbox" style="font-size: 48px; margin-bottom: 20px; opacity: 0.5;"></i>
                                        <p>No withdraw history yet</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Back to Withdraw Button -->
                <button class="master-btn master-btn-primary master-btn-full" onclick="navigateTo('withdraw')">
                    <i class="fa-solid fa-arrow-left"></i> Back to Withdraw
                </button>
            </div>
        </div>

        <!-- VERIFICATION PAGE (UPDATED WITH FULL-WIDTH PAYMENT METHOD CARD) -->
        <div id="verify-view" class="page-view">
            <div class="page-header">
                <div class="back-btn" onclick="navigateTo('dashboard')">
                    <i class="fa-solid fa-arrow-left"></i>
                </div>
                <div class="page-title">Account Verification</div>
            </div>

            <div class="verify-container">
                <!-- Payment Method Card Style (Same as Withdraw Page) -->
                <div class="payment-method-card">
                    <div class="form-label">
                        <i class="fa-solid fa-credit-card"></i>
                        à¦ªà§à¦®à§à¦¨à§à¦ à¦®à§à¦¥à¦¡ à¦¸à¦¿à¦²à§à¦à§à¦ à¦à¦°à§à¦¨:
                    </div>
                    <select class="form-select" id="verification-method-select" onchange="updateVerificationDetails()">
                        <option value="">à¦ªà§à¦®à§à¦¨à§à¦ à¦®à§à¦¥à¦¡ à¦¸à¦¿à¦²à§à¦à§à¦ à¦à¦°à§à¦¨</option>
                        <!-- Options will be loaded from Firestore -->
                    </select>
                </div>

                <!-- Receiver Number (Auto Fill, Read-only) -->
                <div class="form-group">
                    <label class="form-label">Receiver Number (à¦à¦ à¦¨à¦¾à¦®à§à¦¬à¦¾à¦°à§ à¦à¦¾à¦à¦¾ à¦ªà¦¾à¦ à¦¾à¦¬à§à¦¨)</label>
                    <input type="text" class="form-input" id="receiver-number-display" readonly style="background: #f8fafc; color: #1e293b; font-weight: 600;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
                        <button class="master-btn master-btn-primary master-btn-sm" onclick="copyReceiverNumber()">
                            <i class="fa-solid fa-copy"></i> à¦à¦ªà¦¿ à¦à¦°à§à¦¨
                        </button>
                        <span style="font-size: 12px; color: var(--text-light);">à¦à¦¡à¦®à¦¿à¦¨ à¦ªà§à¦¯à¦¾à¦¨à§à¦² à¦¥à§à¦à§ à¦¸à§à¦ à¦à¦°à¦¾ à¦¨à¦¾à¦®à§à¦¬à¦¾à¦°</span>
                    </div>
                </div>

                <!-- Amount (Read-only, Admin Controlled) -->
                <div class="form-group">
                    <label class="form-label">Amount (à¦à¦¾à¦à¦¾à¦° à¦ªà¦°à¦¿à¦®à¦¾à¦£)</label>
                    <input type="text" class="form-input" id="verification-amount-display" readonly style="background: #f8fafc; color: #dc2626; font-weight: 700; font-size: 16px;">
                    <p style="font-size: 13px; color: var(--text-light); margin-top: 8px;">
                        <i class="fa-solid fa-lock"></i> à¦à¦¡à¦®à¦¿à¦¨ à¦ªà§à¦¯à¦¾à¦¨à§à¦² à¦¥à§à¦à§ à¦¸à§à¦ à¦à¦°à¦¾ à¦ªà¦°à¦¿à¦®à¦¾à¦£
                    </p>
                </div>

                <!-- User Input Fields (Only These) -->
                <div class="form-group">
                    <label class="form-label">à¦¯à§ à¦¨à¦¾à¦®à§à¦¬à¦¾à¦° à¦¥à§à¦à§ à¦à¦¾à¦à¦¾ à¦ªà¦¾à¦ à¦¿à§à§à¦à§à¦¨</label>
                    <input type="number" class="form-input" id="sender-number" placeholder="01XXXXXXXXX" maxlength="11">
                </div>

                <div class="form-group">
                    <label class="form-label">Transaction ID (TrxID)</label>
                    <input type="text" class="form-input" id="transaction-id" placeholder="Example: 8JHS62...">
                </div>

                <button class="master-btn master-btn-dark master-btn-full" onclick="submitVerification()" id="verification-submit-btn">
                    <i class="fa-solid fa-paper-plane"></i> Submit Verification
                </button>
            </div>
        </div>

        <!-- UPDATED GMAIL SELL PAGE (Action Page) -->
        <div id="gmail-sell-view" class="page-view">
            <div class="page-header">
                <div class="back-btn" onclick="navigateTo('dashboard')">
                    <i class="fa-solid fa-arrow-left"></i>
                </div>
                <div class="page-title">Sell Gmail</div>
            </div>
            <div class="gmail-sell-container">
                <!-- Gmail Top Notice -->
                <div class="notice-trigger" onclick="showGmailNoticeModal()" id="gmail-notice-trigger">
                    <div class="notice-left">
                        <span class="dot"></span> <span>Gmail Top Notice</span>
                    </div>
                    <button class="master-btn master-btn-primary master-btn-sm">Tap to view</button>
                </div>

                <!-- Status Summary Cards -->
                <div class="gmail-status-cards" id="gmail-status-cards">
                    <div class="gmail-status-card processing">
                        <div class="gmail-status-count" id="gmail-processing-count">0</div>
                        <div class="gmail-status-label">Processing</div>
                    </div>
                    <div class="gmail-status-card approved">
                        <div class="gmail-status-count" id="gmail-approved-count">0</div>
                        <div class="gmail-status-label">Approved</div>
                    </div>
                    <div class="gmail-status-card rejected">
                        <div class="gmail-status-count" id="gmail-rejected-count">0</div>
                        <div class="gmail-status-label">Rejected</div>
                    </div>
                </div>

                <!-- Price Info Box -->
                <div class="gmail-price-box" id="gmail-price-box">
                    <div style="font-size: 14px; color: #0369a1;">à¦ªà§à¦°à¦¤à¦¿ à¦à¦¿à¦®à§à¦à¦² à¦à¦à¦¾à¦à¦¨à§à¦ à¦à¦° à¦à¦¨à§à¦¯ à¦ªà¦¾à¦¬à§à¦¨</div>
                    <div class="gmail-price-amount" id="gmail-price-amount">à§³0.00</div>
                    <div style="font-size: 13px; color: #0369a1;">Admin-à¦à¦° approval à¦ªà§à¦²à§à¦ à¦à¦¾à¦à¦¾ à¦¯à§à¦ à¦¹à¦¬à§</div>
                </div>

                <!-- Today's Gmail Password -->
                <div class="password-today-box" id="password-today-box">
                    <div style="font-size: 14px; color: #059669; font-weight: 600; margin-bottom: 10px;">
                        <i class="fa-solid fa-key"></i> à¦à¦à¦à§à¦° à¦à¦¿à¦®à§à¦à¦² à¦ªà¦¾à¦¸à¦à¦¯à¦¼à¦¾à¦°à§à¦¡
                    </div>
                    <div class="password-display" id="password-today-display">Loading...</div>
                    <button class="master-btn master-btn-green master-btn-full" onclick="copyPasswordToday()">
                        <i class="fa-solid fa-copy"></i> Copy Password
                    </button>
                </div>

                <!-- Gmail Submission Form -->
                <div class="form-card">
                    <div class="form-label">Gmail Address</div>
                    <input type="email" class="form-input" id="gmail-address" placeholder="example@gmail.com" required>
                    
                    <div class="form-label" style="margin-top: 20px;">Gmail Password</div>
                    <input type="password" class="form-input" id="gmail-password" placeholder="Enter password" required>
                    
                    <div id="gmail-form-message" style="display: none; margin-top: 15px; padding: 10px; border-radius: var(--radius); font-size: 13px;"></div>
                    
                    <button class="master-btn master-btn-red master-btn-full" id="gmail-submit-btn" onclick="submitGmail()">
                        <i class="fa-solid fa-paper-plane"></i> Submit Details
                    </button>
                </div>

                <!-- Gmail History Button -->
                <button class="master-btn master-btn-dark master-btn-full" onclick="navigateTo('gmail-processing')">
                    <i class="fa-solid fa-history"></i> Gmail History
                </button>
            </div>
        </div>

        <!-- GMAIL PROCESSING PAGE (History Page) -->
        <div id="gmail-processing-view" class="page-view">
            <div class="page-header">
                <div class="back-btn" onclick="navigateTo('gmail-sell')">
                    <i class="fa-solid fa-arrow-left"></i>
                </div>
                <div class="page-title">Gmail Processing</div>
            </div>
            <div class="processing-container" style="padding: 20px;">
                <!-- Gmail Summary Cards (NEW) -->
                <div class="gmail-summary-cards">
                    <div class="gmail-summary-card">
                        <div class="gmail-summary-card-value" id="gmail-total-approved">à§³0</div>
                        <div class="gmail-summary-card-label">Total Approved Earnings</div>
                    </div>
                    <div class="gmail-summary-card">
                        <div class="gmail-summary-card-value" id="gmail-total-pending">à§³0</div>
                        <div class="gmail-summary-card-label">Total Pending Earnings</div>
                    </div>
                </div>

                <!-- Gmail Processing Table -->
                <div class="form-card">
                    <h4 style="margin-bottom: 20px; color: var(--dark);">Gmail Submissions</h4>
                    <div style="overflow-x: auto;">
                        <table class="gmail-processing-table" style="min-width: 500px;">
                            <thead>
                                <tr>
                                    <th>SL</th>
                                    <th>Gmail</th>
                                    <th>Amount (à§³)</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="gmail-history-tbody">
                                <!-- Content will be loaded from Firestore -->
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 40px; color: var(--text-light);">
                                        <i class="fa-solid fa-inbox" style="font-size: 48px; margin-bottom: 20px; opacity: 0.5;"></i>
                                        <p>No Gmail submissions yet</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Back to Gmail Sell Button -->
                <button class="master-btn master-btn-primary master-btn-full" onclick="navigateTo('gmail-sell')">
                    <i class="fa-solid fa-arrow-left"></i> Back to Gmail Sell
                </button>
            </div>
        </div>

        <!-- GMAIL NOTICE MODAL -->
        <div class="gmail-notice-modal-overlay" id="gmail-notice-modal">
            <div class="gmail-notice-modal">
                <div class="gmail-notice-modal-header">
                    <div class="gmail-notice-modal-title">
                        <i class="fa-solid fa-bell"></i> Gmail Top Notice
                    </div>
                </div>
                <div class="gmail-notice-modal-content" id="gmail-notice-content">
                    Loading notice...
                </div>
                <div class="gmail-notice-modal-actions">
                    <button class="master-btn master-btn-primary" onclick="closeGmailNoticeModal()">
                        Close
                    </button>
                </div>
            </div>
        </div>

        <!-- REFERRAL SYSTEM PAGE - COMPLETELY FIXED, REAL-TIME UPDATES -->
        <div id="referral-system-view" class="page-view">
            <div class="page-header">
                <div class="back-btn" onclick="navigateTo('dashboard')">
                    <i class="fa-solid fa-arrow-left"></i>
                </div>
                <div class="page-title">Referral System</div>
            </div>
            <div class="referral-system-container">
                <!-- Referral Link and ID -->
                <div class="form-card">
                    <div class="form-label">Your Referral Link</div>
                    <div style="display: flex; gap: 12px; margin-top: 10px;">
                        <input type="text" class="form-input" id="referral-link" readonly style="background: var(--light);">
                        <button class="master-btn master-btn-primary master-btn-sm" onclick="copyReferralLink()">
                            <i class="fa-solid fa-copy"></i> Copy Link
                        </button>
                    </div>
                    
                    <div class="form-label" style="margin-top: 25px;">Your Referral ID</div>
                    <div style="display: flex; gap: 12px; margin-top: 10px;">
                        <input type="text" class="form-input" id="referral-id" readonly style="background: var(--light);">
                        <button class="master-btn master-btn-primary master-btn-sm" onclick="copyReferralId()">
                            <i class="fa-solid fa-copy"></i> Copy ID
                        </button>
                    </div>
                </div>
                
                <!-- Referral Message -->
                <div id="referral-message-container" style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); padding: 20px; border-radius: var(--radius); margin-top: 20px; border: 2px solid #a7f3d0; display: none;">
                    <p style="color: #059669; font-size: 14px; text-align: center; font-weight: 600;" id="referral-message">
                        à¦à¦ªà¦¨à¦¾à¦° à¦¬à¦¨à§à¦§à§à¦à§ à¦à¦®à¦¨à§à¦¤à§à¦°à¦£ à¦à¦°à§à¦¨ à¦à¦¬à¦ à¦ªà§à¦°à¦¤à¦¿ à¦°à§à¦«à¦¾à¦°à§ à¦à¦¨à¦à¦¾à¦® à¦à¦°à§à¦¨ 50 à¦à¦¾à¦à¦¾
                    </p>
                </div>
                
                <!-- Referral Summary - UPDATES LIVE -->
                <div class="form-card" style="margin-top: 25px;">
                    <h4 style="margin-bottom: 20px; color: var(--dark);">Referral Summary</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                        <div style="text-align: center; padding: 25px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: var(--radius); border: 2px solid #bae6fd;">
                            <div style="font-size: 32px; font-weight: 800; color: var(--dark);" id="total-referral">0</div>
                            <div style="font-size: 14px; color: #0369a1; margin-top: 8px; font-weight: 600;">Total Referral (All)</div>
                        </div>
                        <div style="text-align: center; padding: 25px; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: var(--radius); border: 2px solid #a7f3d0;">
                            <div style="font-size: 32px; font-weight: 800; color: var(--dark);" id="total-earning">0</div>
                            <div style="font-size: 14px; color: #059669; margin-top: 8px; font-weight: 600;">Total Earning (Verified Only)</div>
                        </div>
                    </div>
                </div>
                
                <!-- Referral Status - UPDATES LIVE -->
                <div style="margin-top: 20px;">
                    <h4 style="margin-bottom: 15px; color: var(--dark);">Referral Status</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: var(--radius); border: 2px solid #f59e0b;">
                            <div style="font-size: 24px; font-weight: 800; color: var(--dark);" id="pending-referral">0</div>
                            <div style="font-size: 13px; color: #92400e; margin-top: 5px; font-weight: 600;">Pending (Non-Verified)</div>
                        </div>
                        <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border-radius: var(--radius); border: 2px solid #10b981;">
                            <div style="font-size: 24px; font-weight: 800; color: var(--dark);" id="verified-referral">0</div>
                            <div style="font-size: 13px; color: #059669; margin-top: 5px; font-weight: 600;">Verified</div>
                        </div>
                    </div>
                </div>
                
                <!-- View My Referrals List Button -->
                <button class="master-btn master-btn-primary master-btn-full" onclick="navigateTo('my-referrals')">
                    <i class="fa-solid fa-list"></i> View My Referrals List
                </button>
            </div>
        </div>

        <!-- MY REFERRALS PAGE - COMPLETELY FIXED, REAL-TIME LIST -->
        <div id="my-referrals-view" class="page-view">
            <div class="page-header">
                <div class="back-btn" onclick="navigateTo('referral-system')">
                    <i class="fa-solid fa-arrow-left"></i>
                </div>
                <div class="page-title">My Referrals List</div>
            </div>
            <div class="my-referrals-container">
                <!-- Status Filter Buttons -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="master-btn master-btn-primary master-btn-sm" onclick="loadReferralList('all')" id="filter-all">All</button>
                    <button class="master-btn master-btn-green master-btn-sm" onclick="loadReferralList('verified')" id="filter-verified">Verified</button>
                    <button class="master-btn master-btn-orange master-btn-sm" onclick="loadReferralList('pending')" id="filter-pending">Pending</button>
                </div>
                
                <div id="referral-list">
                    <div class="form-card" id="referral-list-content">
                        <div style="text-align: center; padding: 40px 20px; color: var(--text-light);">
                            <i class="fa-solid fa-users" style="font-size: 48px; margin-bottom: 20px; opacity: 0.5;"></i>
                            <p>No referrals yet. Share your referral link to earn!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- UPDATED SALARY APPLY PAGE WITH IMPROVED UI (HISTORY SECTIONS REMOVED) -->
        <div id="salary-apply-view" class="page-view">
            <div class="page-header">
                <div class="back-btn" onclick="navigateTo('dashboard')">
                    <i class="fa-solid fa-arrow-left"></i>
                </div>
                <div class="page-title">Salary Apply</div>
            </div>
            <div class="salary-apply-container">
                <!-- Current Status -->
                <div class="form-card">
                    <h4 style="margin-bottom: 20px; color: var(--dark);">Current Status</h4>
                    <div style="text-align: center; padding: 25px; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: var(--radius); border: 2px solid var(--light-2);">
                        <div style="font-size: 42px; font-weight: 800; color: var(--dark);" id="verified-members-count">0</div>
                        <div style="font-size: 16px; color: var(--text-light); margin-top: 10px;">Verified Referrals</div>
                    </div>
                </div>
                
                <!-- Available Salary Packages -->
                <div class="form-card" style="margin-top: 30px;">
                    <h4 style="margin-bottom: 20px; color: var(--dark);">Available Salary Packages</h4>
                    <div id="salary-packages-container">
                        <div style="text-align: center; padding: 40px 20px; color: var(--text-light);">
                            <i class="fa-solid fa-spinner fa-spin"></i>
                            <p>Loading salary packages...</p>
                        </div>
                    </div>
                </div>
                
                <!-- ð´ Salary Applications History & Salary Receive History SECTIONS REMOVED COMPLETELY ð´ -->
            </div>
        </div>

        <!-- ========== FREE JOB SYSTEM PAGES ========== -->

        <!-- FREE JOB PROJECTS PAGE -->
        <div id="free-job-projects-view" class="page-view">
            <div class="page-header">
                <div class="back-btn" onclick="navigateTo('dashboard')">
                    <i class="fa-solid fa-arrow-left"></i>
                </div>
                <div class="page-title">Free API Jobs List</div>
            </div>
            <div class="free-job-container" id="free-job-projects-container">
                <!-- Projects will be loaded dynamically from Firestore -->
                <div style="text-align: center; padding: 40px 20px; color: var(--text-light);">
                    <i class="fa-solid fa-spinner fa-spin" style="font-size: 48px; margin-bottom: 20px;"></i>
                    <p>Loading projects...</p>
                </div>
            </div>
        </div>

        <!-- FREE JOB CARDS PAGE (Inside a Project) -->
        <div id="free-job-cards-view" class="page-view">
            <div class="page-header">
                <div class="back-btn" onclick="navigateTo('free-job-projects')">
                    <i class="fa-solid fa-arrow-left"></i>
                </div>
                <div class="page-title" id="free-job-cards-project-title">Cards</div>
            </div>
            <div class="free-job-container" id="free-job-cards-container">
                <!-- Cards will be loaded dynamically from Firestore -->
                <div style="text-align: center; padding: 40px 20px; color: var(--text-light);">
                    <i class="fa-solid fa-spinner fa-spin" style="font-size: 48px; margin-bottom: 20px;"></i>
                    <p>Loading cards...</p>
                </div>
            </div>
        </div>

        <!-- FREE JOB JOBS PAGE (Inside a Card) -->
        <div id="free-job-jobs-view" class="page-view">
            <div class="page-header">
                <div class="back-btn" onclick="navigateTo('free-job-cards')">
                    <i class="fa-solid fa-arrow-left"></i>
                </div>
                <div class="page-title" id="free-job-jobs-card-title">Jobs</div>
            </div>
            <div class="free-job-container" id="free-job-jobs-container">
                <!-- Jobs will be loaded dynamically from Firestore -->
                <div style="text-align: center; padding: 40px 20px; color: var(--text-light);">
                    <i class="fa-solid fa-spinner fa-spin" style="font-size: 48px; margin-bottom: 20px;"></i>
                    <p>Loading jobs...</p>
                </div>
            </div>
        </div>

        <!-- FREE JOB DETAILS PAGE -->
        <div id="free-job-details-view" class="page-view">
            <div class="page-header">
                <div class="back-btn" onclick="navigateTo('free-job-jobs')">
                    <i class="fa-solid fa-arrow-left"></i>
                </div>
                <div class="page-title">Job Details</div>
            </div>
            <div class="free-job-container" id="free-job-details-container">
                <!-- Job details will be rendered here -->
            </div>
        </div>

        <!-- ========== END FREE JOB PAGES ========== -->

        <!-- ========== JOB SUBMISSIONS PAGE (NEW) ========== -->
        <div id="job-submissions-view" class="page-view">
            <div class="page-header">
                <div class="back-btn" onclick="navigateTo('dashboard')">
                    <i class="fa-solid fa-arrow-left"></i>
                </div>
                <div class="page-title">My Job Submissions</div>
            </div>
            <div class="job-submissions-container">
                <!-- Summary Cards -->
                <div class="summary-cards" id="submission-summary">
                    <div class="summary-card">
                        <div class="summary-card-value" id="pending-reward-sum">à§³0</div>
                        <div class="summary-card-label">Pending Reward</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-card-value" id="approved-reward-sum">à§³0</div>
                        <div class="summary-card-label">Approved Reward</div>
                    </div>
                </div>

                <!-- Filter Tabs -->
                <div class="filter-tabs" id="submission-filter-tabs">
                    <div class="filter-tab active" onclick="filterSubmissions('all')">All</div>
                    <div class="filter-tab" onclick="filterSubmissions('processing')">Processing</div>
                    <div class="filter-tab" onclick="filterSubmissions('approved')">Approved</div>
                    <div class="filter-tab" onclick="filterSubmissions('rejected')">Rejected</div>
                </div>

                <!-- Submissions List -->
                <div id="job-submissions-list">
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-light);">
                        <i class="fa-solid fa-spinner fa-spin" style="font-size: 48px; margin-bottom: 20px;"></i>
                        <p>Loading submissions...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- JOB SUBMISSION DETAIL MODAL -->
        <div class="message-modal-overlay" id="submission-detail-modal">
            <div class="message-modal" style="max-width: 500px;">
                <div class="message-modal-header" style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);">
                    <div class="message-modal-title">
                        <i class="fa-solid fa-file-alt"></i>
                        Submission Details
                    </div>
                    <div class="message-modal-close" onclick="closeSubmissionDetailModal()">
                        <i class="fa-solid fa-times"></i>
                    </div>
                </div>
                <div class="message-modal-content" id="submission-detail-content">
                    <!-- Dynamic content -->
                </div>
                <div class="message-modal-actions">
                    <button class="master-btn master-btn-primary" onclick="closeSubmissionDetailModal()">Close</button>
                </div>
            </div>
        </div>

        <!-- SIDEBAR MENU -->
        <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleMenu()"></div>
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="user-profile">
                    <div class="user-avatar"><i class="fa-solid fa-user"></i></div>
                    <div class="user-info">
                        <h4 id="sidebar-username">Loading...</h4>
                        <span class="unverified-badge" id="badge-text"><i class="fa-solid fa-xmark"></i> Unverified</span>
                    </div>
                </div>
                <div class="close-menu" onclick="toggleMenu()"><i class="fa-solid fa-times"></i></div>
            </div>

            <div class="sidebar-menu">
                <div class="menu-item" style="background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(37, 99, 235, 0.3);">
                    <i class="fa-solid fa-link"></i> 
                    <div style="font-size: 13px;">Ref ID: <strong style="color: white;" id="sidebar-ref-id">Loading...</strong></div>
                </div>
                
                <div class="menu-item" onclick="navigateTo('dashboard')">
                    <i class="fa-solid fa-gauge"></i> Dashboard
                </div>
                <div class="menu-item" onclick="navigateTo('profile')">
                    <i class="fa-solid fa-user"></i> Profile
                </div>
                <div class="menu-item" onclick="navigateTo('help-line')">
                    <i class="fa-solid fa-headset"></i> Help Line
                </div>
                <div class="menu-item" onclick="navigateTo('withdraw')">
                    <i class="fa-solid fa-money-bill-transfer"></i> Withdraw
                </div>
                <div class="menu-item" onclick="navigateTo('gmail-sell')">
                    <i class="fa-brands fa-google"></i> Gmail Sell
                </div>
                <div class="menu-item" id="referral-menu-item" onclick="navigateTo('referral-system')">
                    <i class="fa-solid fa-link"></i> Referral System
                </div>
                <div class="menu-item" onclick="navigateTo('salary-apply')">
                    <i class="fa-solid fa-wallet"></i> Salary
                </div>
                <!-- ===== FREE JOB SIDEBAR MENU ITEM ===== -->
                <div class="menu-item" onclick="navigateTo('free-job-projects')">
                    <i class="fa-solid fa-briefcase"></i> Free Job
                </div>
                <!-- ===== JOB SUBMISSIONS SIDEBAR MENU ITEM ===== -->
                <div class="menu-item" onclick="navigateTo('job-submissions')">
                    <i class="fa-solid fa-clipboard-list"></i> Job Submissions
                </div>
                
                <div style="margin-top: 30px; border-top: 2px solid rgba(255, 255, 255, 0.1); padding-top: 20px;">
                    <div class="menu-item" onclick="logout()">
                        <i class="fa-solid fa-right-from-bracket"></i> Logout
                    </div>
                </div>
            </div>
        </div>

        <!-- FLOATING BUTTON -->
        <div class="fab" onclick="navigateTo('help-line')">
            <i class="fa-solid fa-headset"></i>
        </div>

    </div>

    <script>
        // â FULLY INTEGRATED FIRESTORE CONFIG â LIVE COLOR & LOGO UPDATE
        // =============================================================

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBY2R6jBre2pjrW3cN0QP8LGrLldgKWEtc",
            authDomain: "smartpay-4cae4.firebaseapp.com",
            projectId: "smartpay-4cae4",
            storageBucket: "smartpay-4cae4.firebasestorage.app",
            messagingSenderId: "531344716314",
            appId: "1:531344716314:web:0eac7f60479bfd66f7d7a3"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- GLOBAL VARIABLES ---
        let userData = null;
        let userDocRef = null;
        let userListener = null;
        let selectedVerificationMethod = '';
        let selectedWithdrawPackage = null;
        let appConfig = null;
        let appConfigListener = null;
        let salaryPackagesListener = null;
        // ð´ salaryApplicationsListener and salaryPaymentsListener REMOVED
        let withdrawPackagesListener = null;
        let gmailProcessingListener = null;
        let gmailHistoryListener = null;
        let gmailSettingsListener = null;
        let supportContactsListener = null;
        let referralSummaryListener = null;
        let referralListListener = null;
        // â Withdraw Requests Listener (replaces old withdrawHistoryListener)
        let withdrawRequestsListener = null;
        let liveTimerInterval = null;
        let previousVerificationStatus = null;
        
        // â Wallet types for withdraw (NEW)
        let walletTypes = [];
        let walletTypesListener = null;
        let selectedWalletKey = null;
        
        // â FIXED: Referral System Variables
        let referralSettings = null;
        let referralSettingsListener = null;
        let paymentMethods = [];
        let paymentMethodsListener = null;
        let verificationMethodsListener = null;
        let verificationMethods = [];

        // â CRITICAL FIX: Referral Requests Listener
        let referralRequestsListener = null;

        // â Gmail Wallet Listener (NEW)
        let gmailWalletListener = null;

        // ===== FREE JOB SYSTEM GLOBAL VARIABLES =====
        let freeJobProjectsListener = null;
        let freeJobCardsListener = null;
        let freeJobJobsListener = null;
        let freeJobSubmissionsListener = null;
        let selectedProjectId = null;
        let selectedCardId = null;
        let selectedJob = null;
        // NEW: store titles for submission tracking
        let selectedProjectTitle = '';
        let selectedCardTitle = '';
        let selectedJobTitle = '';

        // ===== JOB SUBMISSIONS VARIABLES =====
        let jobSubmissionsListener = null;
        let currentSubmissionFilter = 'all';
        let allSubmissions = []; // store all submissions for client-side filtering

        // =============================================

        // --- APP CONFIG REAL-TIME LISTENER (Extended for all color fields) ---
        function setupAppConfigListener() {
            if (appConfigListener) {
                appConfigListener();
            }

            appConfigListener = db.collection('app_config').doc('config')
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        appConfig = doc.data();
                        updateAppConfigUI(); // â now includes all color/logo updates
                    } else {
                        console.error('App config document not found');
                    }
                }, (error) => {
                    console.error('Error listening to app config:', error);
                });
        }

        // â FIXED: REFERRAL SETTINGS LISTENER
        function setupReferralSettingsListener() {
            if (referralSettingsListener) {
                referralSettingsListener();
            }

            referralSettingsListener = db.collection('referral_settings').doc('config')
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        referralSettings = doc.data();
                        updateReferralSettingsUI();
                    } else {
                        console.warn('Referral settings document not found');
                    }
                }, (error) => {
                    console.error('Error listening to referral settings:', error);
                });
        }

        // â FIXED: UPDATE REFERRAL SETTINGS UI
        function updateReferralSettingsUI() {
            if (!referralSettings) return;

            // Update referral message
            const referralMessageElement = document.getElementById('referral-message');
            if (referralMessageElement) {
                referralMessageElement.textContent = referralSettings.referralShareMessage || 'à¦à¦ªà¦¨à¦¾à¦° à¦¬à¦¨à§à¦§à§à¦à§ à¦à¦®à¦¨à§à¦¤à§à¦°à¦£ à¦à¦°à§à¦¨ à¦à¦¬à¦ à¦ªà§à¦°à¦¤à¦¿ à¦°à§à¦«à¦¾à¦°à§ à¦à¦¨à¦à¦¾à¦® à¦à¦°à§à¦¨ 50 à¦à¦¾à¦à¦¾';
            }

            // Update referral link (if we have userData)
            if (userData && userData.referralId) {
                const baseUrl = referralSettings.baseUrl || 'https://smartpay.vercel.app/?ref=';
                const referralLink = `${baseUrl}${userData.referralId}`;
                const referralLinkInput = document.getElementById('referral-link');
                if (referralLinkInput) {
                    referralLinkInput.value = referralLink;
                }
            }

            // Show referral message container
            document.getElementById('referral-message-container').style.display = 'block';
        }

        // â FIXED: SETUP PAYMENT METHODS LISTENER
        function setupPaymentMethodsListener() {
            if (paymentMethodsListener) {
                paymentMethodsListener();
            }

            paymentMethodsListener = db.collection('payment_methods')
                .where('isActive', '==', true)
                .onSnapshot((snapshot) => {
                    paymentMethods = [];
                    snapshot.forEach(doc => {
                        const method = doc.data();
                        method.id = doc.id;
                        paymentMethods.push(method);
                    });
                    updatePaymentMethodDropdowns();
                }, (error) => {
                    console.error('Error loading payment methods:', error);
                });
        }

        // â FIXED: SETUP VERIFICATION METHODS LISTENER
        function setupVerificationMethodsListener() {
            if (verificationMethodsListener) {
                verificationMethodsListener();
            }

            verificationMethodsListener = db.collection('verification_methods')
                .where('isActive', '==', true)
                .onSnapshot((snapshot) => {
                    verificationMethods = [];
                    snapshot.forEach(doc => {
                        const method = doc.data();
                        method.id = doc.id;
                        verificationMethods.push(method);
                    });
                    updateVerificationMethodDropdowns();
                }, (error) => {
                    console.error('Error loading verification methods:', error);
                });
        }

        // â FIXED: UPDATE PAYMENT METHOD DROPDOWNS
        function updatePaymentMethodDropdowns() {
            // Update withdraw page dropdown
            const withdrawSelect = document.getElementById('withdraw-payment-method');
            if (withdrawSelect) {
                while (withdrawSelect.options.length > 1) {
                    withdrawSelect.remove(1);
                }
                paymentMethods.forEach(method => {
                    const option = document.createElement('option');
                    option.value = method.id;
                    option.text = method.methodName || method.name || method.id;
                    withdrawSelect.appendChild(option);
                });
            }

            // Update verification page dropdown
            const verifySelect = document.getElementById('verification-method-select');
            if (verifySelect) {
                while (verifySelect.options.length > 1) {
                    verifySelect.remove(1);
                }
                paymentMethods.forEach(method => {
                    const option = document.createElement('option');
                    option.value = method.id;
                    option.text = method.methodName || method.name || method.id;
                    verifySelect.appendChild(option);
                });
            }
        }

        // â FIXED: UPDATE VERIFICATION METHOD DROPDOWNS
        function updateVerificationMethodDropdowns() {
            const verifySelect = document.getElementById('verification-method-select');
            if (verifySelect) {
                while (verifySelect.options.length > 1) {
                    verifySelect.remove(1);
                }
                verificationMethods.forEach(method => {
                    const option = document.createElement('option');
                    option.value = method.id;
                    option.text = method.methodName || method.name || method.id;
                    verifySelect.appendChild(option);
                });
            }
        }

        // â FIXED: UPDATE VERIFICATION DETAILS WHEN METHOD SELECTED
        function updateVerificationDetails() {
            const methodSelect = document.getElementById('verification-method-select');
            const selectedMethodId = methodSelect.value;
            
            if (!selectedMethodId) {
                document.getElementById('receiver-number-display').value = '';
                document.getElementById('verification-amount-display').value = '';
                return;
            }

            const selectedMethod = verificationMethods.find(method => method.id === selectedMethodId);
            
            if (selectedMethod) {
                document.getElementById('receiver-number-display').value = selectedMethod.receiverNumber || '';
                document.getElementById('verification-amount-display').value = selectedMethod.amount ? `à§³${selectedMethod.amount}` : '';
            } else {
                document.getElementById('receiver-number-display').value = '';
                document.getElementById('verification-amount-display').value = '';
            }
        }

        // â ENHANCED: UPDATE APP CONFIG UI â LIVE COLORS & LOGO
        function updateAppConfigUI() {
            if (!appConfig) return;

            // 1ï¸â£ App Basic Info
            if (appConfig.appName) {
                document.getElementById('app-name').textContent = appConfig.appName;
                document.getElementById('page-title').textContent = appConfig.appName + ' - Modern Dashboard';
            }

            if (appConfig.currencySymbol) {
                // Update currency symbol in balance display â handled via CSS, but we can set a global var if needed
            }

            if (appConfig.launchText) {
                document.getElementById('launch-text').textContent = appConfig.launchText;
            }

            // 2ï¸â£ Maintenance System
            const maintenanceOverlay = document.getElementById('maintenance-overlay');
            if (appConfig.maintenanceMode === true) {
                if (appConfig.maintenanceMessage) {
                    document.getElementById('maintenance-message').textContent = appConfig.maintenanceMessage;
                }
                maintenanceOverlay.classList.add('active');
                document.getElementById('app-container').style.display = 'none';
                document.getElementById('auth-container').style.display = 'none';
            } else {
                maintenanceOverlay.classList.remove('active');
            }

            // 3ï¸â£ Marquee System
            const marqueeContainer = document.getElementById('marquee-container');
            const marqueeTextElement = document.getElementById('marquee-text-element');
            const marqueeTextSpan = document.getElementById('marquee-text');

            if (appConfig.marqueeStatus === 'active') {
                marqueeContainer.style.display = 'block';
                
                if (appConfig.marqueeText) {
                    marqueeTextSpan.textContent = appConfig.marqueeText;
                }
                
                if (appConfig.marqueeBg) {
                    marqueeContainer.style.background = appConfig.marqueeBg;
                }
                
                if (appConfig.marqueeColor) {
                    marqueeTextElement.style.color = appConfig.marqueeColor;
                }
                
                // Set animation speed
                let duration = 20; // default
                if (appConfig.marqueeSpeed === 'slow') duration = 30;
                if (appConfig.marqueeSpeed === 'fast') duration = 10;
                marqueeTextElement.style.animationDuration = duration + 's';
            } else {
                marqueeContainer.style.display = 'none';
            }

            // 4ï¸â£ Notice System
            const noticeTrigger = document.getElementById('notice-trigger');
            if (appConfig.noticeSettings) {
                if (appConfig.noticeSettings.status === 'show') {
                    noticeTrigger.style.display = 'flex';
                    
                    if (appConfig.noticeSettings.title) {
                        document.getElementById('notice-title').textContent = appConfig.noticeSettings.title;
                        document.getElementById('message-title').textContent = appConfig.noticeSettings.title;
                    }
                    
                    if (appConfig.noticeSettings.content) {
                        document.getElementById('message-content').innerHTML = 
                            appConfig.noticeSettings.content.replace(/\n/g, '<br>');
                    }
                } else {
                    noticeTrigger.style.display = 'none';
                }
            } else {
                noticeTrigger.style.display = 'none';
            }

            // 5ï¸â£ Timer System
            if (appConfig.timerType && appConfig.timerFormat) {
                updateTimerBasedOnConfig();
            }

            // 6ï¸â£ Warning Messages
            if (appConfig.warningMessages) {
                if (appConfig.warningMessages.multiAccount) {
                    document.getElementById('warning-text').textContent = appConfig.warningMessages.multiAccount;
                }
            }

            // ----------------------------------------------------------------------
            // ð¨ NEW: LIVE COLOR & LOGO UPDATES FROM FIRESTORE (header, timer, etc.)
            // ----------------------------------------------------------------------

            // ð¹ HEADER BACKGROUND COLOR
            if (appConfig.headerBgColor) {
                document.querySelectorAll('.dashboard-header, .page-header').forEach(el => {
                    el.style.background = appConfig.headerBgColor;
                    // Remove any gradient if previously set
                    el.style.backgroundImage = 'none';
                });
            }

            // ð¹ HEADER TEXT COLOR (App name & page titles)
            if (appConfig.headerTextColor) {
                document.querySelectorAll('.logo span, .page-title').forEach(el => {
                    el.style.color = appConfig.headerTextColor;
                    // Remove gradient text effect if any
                    el.style.background = 'none';
                    el.style.webkitTextFillColor = '';
                    el.style.webkitBackgroundClip = '';
                });
            }

            // ð¹ HEADER ICON COLOR (menu & back & close buttons)
            if (appConfig.headerIconColor) {
                document.querySelectorAll('.menu-btn, .back-btn, .close-menu').forEach(el => {
                    el.style.color = appConfig.headerIconColor;
                });
            }

            // ð¹ HEADER LOGO IMAGE (replace icon with image if URL provided)
            const logoDiv = document.querySelector('.logo');
            if (logoDiv) {
                const existingImg = logoDiv.querySelector('img');
                if (appConfig.headerIconUrl && appConfig.headerIconUrl.trim() !== '') {
                    if (!existingImg) {
                        // Remove icon, add image
                        const icon = logoDiv.querySelector('i');
                        if (icon) icon.remove();
                        const img = document.createElement('img');
                        img.src = appConfig.headerIconUrl;
                        img.alt = 'Logo';
                        img.style.height = '30px';
                        img.style.width = 'auto';
                        img.style.objectFit = 'contain';
                        logoDiv.insertBefore(img, logoDiv.firstChild);
                    } else {
                        existingImg.src = appConfig.headerIconUrl;
                    }
                } else {
                    // No URL, ensure default icon is shown
                    if (existingImg) {
                        existingImg.remove();
                    }
                    if (!logoDiv.querySelector('i')) {
                        const icon = document.createElement('i');
                        icon.className = 'fa-solid fa-wallet';
                        logoDiv.insertBefore(icon, logoDiv.firstChild);
                    }
                }
            }

            // ð¹ LIVE TIMER SECTION BACKGROUND
            if (appConfig.liveTimerBgColor) {
                const timerSection = document.querySelector('.timer-section');
                if (timerSection) {
                    timerSection.style.background = appConfig.liveTimerBgColor;
                    timerSection.style.backgroundImage = 'none';
                }
            }

            // ð¹ TIMER CARD BACKGROUND (Hour/Minute/Second boxes)
            if (appConfig.liveTimerCardColor) {
                document.querySelectorAll('.timer-box').forEach(el => {
                    el.style.background = appConfig.liveTimerCardColor;
                    el.style.backgroundImage = 'none';
                });
            }

            // ð¹ TIMER TEXT COLOR (numbers and labels)
            if (appConfig.liveTimerTextColor) {
                document.querySelectorAll('.timer-val, .timer-label').forEach(el => {
                    el.style.color = appConfig.liveTimerTextColor;
                });
            }

            // ð¹ LAUNCH BADGE DOT COLOR
            if (appConfig.launchBadgeColor) {
                const dot = document.getElementById('launch-badge-dot');
                if (dot) {
                    dot.style.background = appConfig.launchBadgeColor;
                }
            }

            // ð¹ WARNING TEXT COLOR (bottom red message)
            if (appConfig.warningTextColor) {
                const warningText = document.getElementById('warning-text');
                if (warningText) {
                    warningText.style.color = appConfig.warningTextColor;
                }
            }

            // Update significant text if available
            if (appConfig.significantText) {
                if (!appConfig.marqueeText && marqueeTextSpan) {
                    marqueeTextSpan.textContent = appConfig.significantText;
                }
            }
        }

        // --- UPDATE TIMER BASED ON CONFIG ---
        function updateTimerBasedOnConfig() {
            if (!appConfig) return;

            if (liveTimerInterval) {
                clearInterval(liveTimerInterval);
            }

            const timerType = appConfig.timerType || 'countdown';
            const timerFormat = appConfig.timerFormat || 'hhmmss';

            if (timerType === 'countdown') {
                const targetDate = new Date();
                targetDate.setHours(targetDate.getHours() + 24);

                function updateCountdown() {
                    const now = new Date();
                    const difference = targetDate.getTime() - now.getTime();

                    if (difference <= 0) {
                        document.getElementById("t-hour").textContent = "00";
                        document.getElementById("t-minute").textContent = "00";
                        document.getElementById("t-second").textContent = "00";
                        return;
                    }

                    const totalSeconds = Math.floor(difference / 1000);
                    const hours = Math.floor(totalSeconds / 3600);
                    const minutes = Math.floor((totalSeconds % 3600) / 60);
                    const seconds = totalSeconds % 60;

                    const pad = (n) => n < 10 ? "0" + n : n.toString();

                    document.getElementById("t-hour").textContent = pad(hours);
                    document.getElementById("t-minute").textContent = pad(minutes);
                    document.getElementById("t-second").textContent = pad(seconds);
                }

                updateCountdown();
                liveTimerInterval = setInterval(updateCountdown, 1000);
            } else if (timerType === 'clock') {
                function updateClock() {
                    const now = new Date();
                    const hours = now.getHours();
                    const minutes = now.getMinutes();
                    const seconds = now.getSeconds();

                    const pad = (n) => n < 10 ? "0" + n : n.toString();

                    document.getElementById("t-hour").textContent = pad(hours);
                    document.getElementById("t-minute").textContent = pad(minutes);
                    document.getElementById("t-second").textContent = pad(seconds);
                }

                updateClock();
                liveTimerInterval = setInterval(updateClock, 1000);
            }
        }

        // â CRITICAL FIX: 1. UPDATE APP UI WITH REAL-TIME FIRESTORE DATA
        function updateAppUI(data) {
            console.log('Updating UI with data:', data);
            
            if (data.fullName) {
                document.getElementById('sidebar-username').textContent = data.fullName;
                document.getElementById('username-input').value = data.fullName;
            }
            
            if (data.email) {
                document.getElementById('user-email').textContent = data.email;
            }
            
            if (data.referralId) {
                document.getElementById('sidebar-ref-id').textContent = data.referralId;
                document.getElementById('referral-id-display').textContent = data.referralId;
                document.getElementById('referral-id').value = data.referralId;
                
                // â UPDATE REFERRAL LINK WITH REFERRAL SETTINGS
                if (referralSettings) {
                    const baseUrl = referralSettings.baseUrl || 'https://smartpay.vercel.app/?ref=';
                    const referralLink = `${baseUrl}${data.referralId}`;
                    document.getElementById('referral-link').value = referralLink;
                }
            }
            
            // â FIXED: JOIN DATE FORMATTING
            if (data.joinDate) {
                let date;
                try {
                    if (data.joinDate.toDate && typeof data.joinDate.toDate === 'function') {
                        date = data.joinDate.toDate();
                    } else if (typeof data.joinDate === 'string') {
                        if (data.joinDate.includes('T')) {
                            date = new Date(data.joinDate);
                        } else {
                            date = new Date(data.joinDate);
                        }
                    } else if (data.joinDate.seconds) {
                        date = new Date(data.joinDate.seconds * 1000);
                    } else {
                        date = new Date();
                    }
                    
                    const options = { year: 'numeric', month: 'short', day: 'numeric' };
                    const formattedDate = date.toLocaleDateString('en-US', options);
                    document.getElementById('join-date').textContent = formattedDate;
                } catch (error) {
                    console.error('Error formatting join date:', error);
                    document.getElementById('join-date').textContent = 'N/A';
                }
            }
            
            if (data.mainBalance !== undefined) {
                document.getElementById('main-balance').textContent = data.mainBalance.toFixed(2);
                // Do NOT set withdraw-available-balance here â it's now dynamic per selected wallet
            }
            
            if (data.referralIncome !== undefined) {
                document.getElementById('referral-income').textContent = data.referralIncome.toFixed(2);
            }
            
            if (data.salaryWallet !== undefined) {
                document.getElementById('salary-wallet').textContent = data.salaryWallet.toFixed(2);
            }
            
            if (data.gmailWallet !== undefined) {
                document.getElementById('gmail-wallet').textContent = data.gmailWallet.toFixed(2);
            }
            
            if (data.totalIncome !== undefined) {
                document.getElementById('total-income').textContent = data.totalIncome;
            }
            
            if (data.totalWithdraw !== undefined) {
                document.getElementById('total-withdraw').textContent = data.totalWithdraw;
            }

            // ===== FREE JOB WALLET BALANCE =====
            if (data.freeJobBalance !== undefined) {
                document.getElementById('free-job-balance').textContent = data.freeJobBalance.toFixed(2);
            }
            
            // â Update withdraw available balance if a wallet is selected
            if (selectedWalletKey) {
                updateWithdrawAvailableBalance();
            }
            
            // â CRITICAL FIX: Update verification status
            if (data.verificationStatus) {
                updateVerificationStatus(data.verificationStatus);
            }
        }

        // â COMPLETELY REWRITTEN SIGNUP â GUARANTEES REFERRAL REQUEST CREATION
        async function signUp(event) {
            event.preventDefault();
            
            const fullName = document.getElementById('signup-name').value.trim();
            const email = document.getElementById('signup-email').value.trim().toLowerCase();
            const password = document.getElementById('signup-password').value;
            const confirmPassword = document.getElementById('signup-confirm-password').value;
            let referralCode = document.getElementById('signup-referral').value.trim();
            const btn = document.getElementById('signup-btn');
            const errorDiv = document.getElementById('signup-error');
            const errorText = document.getElementById('signup-error-text');
            
            if (!fullName || !email || !password || !confirmPassword) {
                errorDiv.style.display = 'flex';
                errorText.textContent = 'à¦¸à¦¬ à¦¤à¦¥à§à¦¯ à¦¦à¦¿à¦¨';
                return;
            }
            
            if (password !== confirmPassword) {
                errorDiv.style.display = 'flex';
                errorText.textContent = 'à¦ªà¦¾à¦¸à¦à¦¯à¦¼à¦¾à¦°à§à¦¡ à¦®à¦¿à¦²à§à¦¨à¦¿à¥¤ à¦à¦¬à¦¾à¦° à¦¦à¦¿à¦¨à¥¤';
                return;
            }
            
            if (password.length < 6) {
                errorDiv.style.display = 'flex';
                errorText.textContent = 'à¦ªà¦¾à¦¸à¦à¦¯à¦¼à¦¾à¦°à§à¦¡ à¦à¦¨à§à¦¤à¦¤ à§¬ à¦à¦à§à¦·à¦°à§à¦° à¦¹à§à¦';
                return;
            }
            
            const originalBtnText = btn.innerHTML;
            btn.innerHTML = '<div class="loading-spinner"></div> à¦à§à¦¯à¦¾à¦à¦¾à¦à¦¨à§à¦ à¦¤à§à¦°à¦¿ à¦¹à¦à§à¦à§...';
            btn.disabled = true;
            errorDiv.style.display = 'none';
            
            try {
                // 1. Firebase Auth-à¦ à¦à¦à¦à¦¾à¦° à¦¤à§à¦°à¦¿
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const userId = userCredential.user.uid;
                console.log('â User created in Auth:', userId);
                
                // 2. à¦à¦à¦¨à¦¿à¦ à¦°à§à¦«à¦¾à¦°à§à¦² à¦à¦à¦¡à¦¿ à¦¤à§à¦°à¦¿
                const referralId = 'REF' + Math.random().toString(36).substr(2, 9).toUpperCase();
                
                // 3. à¦à¦à¦à¦¾à¦° à¦¡à¦¾à¦à¦¾ à¦à¦¬à¦à§à¦à§à¦
                const userData = {
                    uid: userId,
                    email: email,
                    fullName: fullName,
                    referralId: referralId,
                    mainBalance: 0.00,
                    referralIncome: 0.00,
                    salaryWallet: 0.00,
                    totalIncome: 0,
                    totalWithdraw: 0,
                    gmailWallet: 0.00,
                    freeJobBalance: 0.00,          // â NEW: Free Job Wallet
                    verificationStatus: 'unverified',
                    joinDate: firebase.firestore.FieldValue.serverTimestamp(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    referralCodeUsed: referralCode || null,
                    referredBy: null,
                    referredByCode: null
                };
                
                // 4. users à¦à¦¾à¦²à§à¦à¦¶à¦¨à§ à¦à¦à¦à¦¾à¦° à¦¡à¦à§à¦®à§à¦¨à§à¦ à¦¸à§à¦­
                await db.collection('users').doc(userId).set(userData);
                console.log('â User data saved to Firestore');
                
                // â 5. à¦°à§à¦«à¦¾à¦°à§à¦² à¦à§à¦¡ à¦¡à¦à§à¦®à§à¦¨à§à¦ à¦¤à§à¦°à¦¿ (referral_codes)
                await db.collection('referral_codes').doc(referralId).set({
                    userId: userId,
                    fullName: fullName,
                    email: email,
                    referralId: referralId,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('â Referral code document created');
                
                // â 6. à¦°à§à¦«à¦¾à¦°à§à¦² à¦ªà§à¦°à¦¸à§à¦¸à¦¿à¦ (à¦¯à¦¦à¦¿ à¦à§à¦¡ à¦¦à§à¦à§à¦¾ à¦¥à¦¾à¦à§)
                if (referralCode && referralCode !== '') {
                    try {
                        console.log('ð Processing referral code:', referralCode);
                        
                        // à¦¸à¦°à¦¾à¦¸à¦°à¦¿ referral_codes à¦à¦¾à¦²à§à¦à¦¶à¦¨ à¦¥à§à¦à§ à¦°à§à¦«à¦¾à¦°à¦¾à¦° à¦¤à¦¥à§à¦¯ à¦à¦¨à¦¾
                        const refDoc = await db.collection('referral_codes').doc(referralCode).get();
                        
                        if (refDoc.exists) {
                            const referrerData = refDoc.data();
                            const referrerId = referrerData.userId;
                            const referrerName = referrerData.fullName || '';
                            
                            console.log('â Found referrer:', referrerName, 'ID:', referrerId);
                            
                            // à¦°à¦¿à¦à§à¦¾à¦°à§à¦¡ à¦à§à¦¯à¦¾à¦®à¦¾à¦à¦¨à§à¦ (à¦°à§à¦«à¦¾à¦°à§à¦² à¦¸à§à¦à¦¿à¦à¦¸ à¦¥à§à¦à§)
                            let rewardAmount = 50;
                            try {
                                const settingsDoc = await db.collection('referral_settings').doc('config').get();
                                if (settingsDoc.exists) {
                                    rewardAmount = settingsDoc.data().rewardAmount || 50;
                                }
                            } catch (e) {
                                console.log('â¹ï¸ Using default reward amount (50)');
                            }
                            
                            // â à¦°à§à¦«à¦¾à¦°à§à¦² à¦°à¦¿à¦à§à§à§à¦¸à§à¦ à¦¤à§à¦°à¦¿ (à¦¸à§à¦à§à¦¯à¦¾à¦à¦¾à¦¸: pending)
                            const referralRequest = {
                                referrerId: referrerId,
                                referrerReferralId: referralCode,
                                referrerName: referrerName,
                                referredUserId: userId,
                                referredUserName: fullName,
                                referredUserEmail: email,
                                referralCode: referralCode,
                                rewardAmount: rewardAmount,
                                status: 'pending',
                                joinDate: firebase.firestore.FieldValue.serverTimestamp(),
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            };
                            
                            await db.collection('referral_requests').add(referralRequest);
                            console.log('â Referral request created â referrer will see this immediately if logged in.');
                            
                            // â à¦à¦à¦à¦¾à¦° à¦¡à¦à§à¦®à§à¦¨à§à¦ à¦à¦ªà¦¡à§à¦ (referredBy à¦ referredByCode à¦¸à§à¦)
                            await db.collection('users').doc(userId).update({
                                referredBy: referrerId,
                                referredByCode: referralCode,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            console.log('â New user updated with referrer info');
                            
                            showToast(`ð Referral recorded! You are now pending. Reward: à§³${rewardAmount} when verified.`, 'success');
                        } else {
                            console.log('â ï¸ No referrer found with code:', referralCode);
                            showToast('â Invalid referral code. Account created without referral.', 'warning');
                        }
                    } catch (error) {
                        console.error('ð¥ Error in referral processing:', error);
                        showToast('â ï¸ Account created but referral processing failed: ' + error.message, 'warning');
                    }
                } else {
                    console.log('â¹ï¸ No referral code provided');
                }
                
                // 7. à¦²à¦¿à¦¸à§à¦¨à¦¾à¦° à¦¸à§à¦à¦à¦ª à¦ à¦¡à§à¦¯à¦¾à¦¶à¦¬à§à¦°à§à¦¡à§ à¦¨à¦¿à§à§ à¦¯à¦¾à¦à§à¦¾
                setupUserListener(userId);
                setupAppConfigListener();
                setupReferralSettingsListener();
                setupPaymentMethodsListener();
                setupVerificationMethodsListener();
                
                document.getElementById('auth-container').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                navigateTo('dashboard');
                
                // à¦«à¦°à§à¦® à¦à§à¦²à¦¿à§à¦¾à¦°
                document.getElementById('signup-name').value = '';
                document.getElementById('signup-email').value = '';
                document.getElementById('signup-password').value = '';
                document.getElementById('signup-confirm-password').value = '';
                document.getElementById('signup-referral').value = '';
                
                showToast('â à¦à¦ªà¦¨à¦¾à¦° à¦¨à¦¤à§à¦¨ à¦à§à¦¯à¦¾à¦à¦¾à¦à¦¨à§à¦ à¦¸à¦«à¦²à¦­à¦¾à¦¬à§ à¦¤à§à¦°à¦¿ à¦¹à¦¯à¦¼à§à¦à§à¥¤');
                
            } catch (error) {
                console.error('â Sign Up Error:', error);
                errorDiv.style.display = 'flex';
                
                if (error.code === 'auth/email-already-in-use') {
                    errorText.textContent = 'à¦à¦ à¦à¦®à§à¦à¦² à¦à¦¤à¦¿à¦®à¦§à§à¦¯à§ à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦° à¦à¦°à¦¾ à¦¹à§à§à¦à§à¥¤ à¦²à¦à¦à¦¨ à¦à¦°à§à¦¨à¥¤';
                } else if (error.code === 'auth/invalid-email') {
                    errorText.textContent = 'à¦à¦®à§à¦à¦² à¦ à¦¿à¦à¦¾à¦¨à¦¾à¦à¦¿ à¦¸à¦ à¦¿à¦ à¦¨à§à¥¤';
                } else if (error.code === 'auth/weak-password') {
                    errorText.textContent = 'à¦ªà¦¾à¦¸à¦à¦¯à¦¼à¦¾à¦°à§à¦¡ à¦à§à¦¬ à¦¦à§à¦°à§à¦¬à¦²à¥¤ à¦¶à¦à§à¦¤à¦¿à¦¶à¦¾à¦²à§ à¦ªà¦¾à¦¸à¦à¦¯à¦¼à¦¾à¦°à§à¦¡ à¦¦à¦¿à¦¨à¥¤';
                } else {
                    errorText.textContent = 'à¦à§à¦¯à¦¾à¦à¦¾à¦à¦¨à§à¦ à¦¤à§à¦°à¦¿ à¦à¦°à¦¤à§ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à§à§à¦à§: ' + error.message;
                }
            } finally {
                btn.innerHTML = originalBtnText;
                btn.disabled = false;
            }
        }

        // â FIXED: 3. SETUP USER LISTENER WITH REAL-TIME DATA
        function setupUserListener(uid) {
            if (userListener) {
                userListener();
            }
            
            userDocRef = db.collection('users').doc(uid);
            userListener = userDocRef.onSnapshot((doc) => {
                if (doc.exists) {
                    userData = doc.data();
                    console.log('User data updated from Firestore:', userData);
                    updateAppUI(userData);
                    setupSalaryListeners();    // now only loads salary packages
                    // loadWithdrawPackages();  // ð REMOVED â now wallet-wise and dynamic
                    setupWalletTypesListener(); // â NEW â load wallet types for withdraw
                    setupGmailListeners();
                    setupSupportContactsListener();
                    
                    // â UPDATE REFERRAL LINK WITH REFERRAL SETTINGS
                    if (referralSettings && userData.referralId) {
                        const baseUrl = referralSettings.baseUrl || 'https://smartpay.vercel.app/?ref=';
                        const referralLink = `${baseUrl}${userData.referralId}`;
                        document.getElementById('referral-link').value = referralLink;
                    }
                    
                    // â Setup referral requests listener for this user (as referrer)
                    setupReferralRequestsListener(uid);
                    
                    // â Setup job submissions listener
                    setupJobSubmissionsListener(uid);
                    
                    // â Setup withdraw requests listener (handles status changes and table)
                    setupWithdrawRequestsListener(uid);
                    
                    // â Setup Gmail wallet listener
                    setupGmailWalletListener(uid);
                    
                } else {
                    logout();
                    showToast('User data not found. Please sign up again.', 'error');
                }
            }, (error) => {
                console.error('Error listening to user document:', error);
                showToast('Error loading user data: ' + error.message, 'error');
            });
        }

        // â NEW: SETUP REFERRAL REQUESTS LISTENER â UPDATES REFERRAL SUMMARY & LIST & WALLET
        function setupReferralRequestsListener(userId) {
            if (referralRequestsListener) {
                referralRequestsListener();
            }

            referralRequestsListener = db.collection('referral_requests')
                .where('referrerId', '==', userId)
                .onSnapshot((snapshot) => {
                    console.log('Referral requests snapshot received:', snapshot.size, 'items');
                    
                    // 1ï¸â£ Update summary counts
                    updateReferralSummary(snapshot);
                    
                    // 2ï¸â£ Detect status changes and add rewards to wallet
                    snapshot.docChanges().forEach(change => {
                        const doc = change.doc;
                        const data = doc.data();
                        
                        if (change.type === 'modified') {
                            const oldData = change.doc.metadata.hasPendingWrites ? null : null; // can't get old data easily
                            // Instead, we rely on the fact that we only update wallet when status becomes 'verified'
                            // and we haven't processed this document before. We'll use a transaction that checks current status.
                            // To avoid double-adding, we check if the current status is 'verified' and we haven't added yet.
                            // Since we don't track previous status, we can add a field 'rewardAdded' to the referral request.
                            // But for simplicity and correctness, we will run a transaction that checks if the status is 'verified' 
                            // and if the user's wallet has already been credited (by checking if the reward amount is already reflected).
                            // This is complex. Instead, we will assume that once a referral becomes verified, we add the reward 
                            // only once. We'll use a field 'rewardProcessed' in the referral request.
                            
                            // We'll implement this by checking if status === 'verified' and if the request doesn't have rewardProcessed flag.
                            // If not, we add reward and set rewardProcessed = true.
                            if (data.status === 'verified' && !data.rewardProcessed) {
                                addReferralReward(userId, data.rewardAmount || 50, doc.id);
                            }
                        } else if (change.type === 'added') {
                            // If a document is added with status 'verified' (should not happen, but just in case)
                            if (data.status === 'verified' && !data.rewardProcessed) {
                                addReferralReward(userId, data.rewardAmount || 50, doc.id);
                            }
                        }
                    });
                    
                    // If on referral list page, update it too
                    if (document.getElementById('my-referrals-view').classList.contains('active')) {
                        const activeFilter = document.querySelector('#my-referrals-view .master-btn-primary')?.textContent.toLowerCase() || 'all';
                        loadReferralList(activeFilter);
                    }
                }, (error) => {
                    console.error('Error listening to referral requests:', error);
                    if (error.code === 'failed-precondition') {
                        showToast('Missing Firestore index. Please create index for referral_requests (referrerId, createdAt).', 'error');
                    }
                });
        }

        // â NEW: Add referral reward to referrer's wallet (transaction)
        async function addReferralReward(referrerId, amount, requestId) {
            try {
                await db.runTransaction(async (transaction) => {
                    const referrerRef = db.collection('users').doc(referrerId);
                    const requestRef = db.collection('referral_requests').doc(requestId);
                    
                    const referrerDoc = await transaction.get(referrerRef);
                    const requestDoc = await transaction.get(requestRef);
                    
                    if (!referrerDoc.exists || !requestDoc.exists) return;
                    
                    // Double-check status and rewardProcessed inside transaction
                    const requestData = requestDoc.data();
                    if (requestData.status !== 'verified' || requestData.rewardProcessed) return;
                    
                    // Update referrer's wallet
                    transaction.update(referrerRef, {
                        referralIncome: firebase.firestore.FieldValue.increment(amount),
                        totalIncome: firebase.firestore.FieldValue.increment(amount),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Mark reward as processed
                    transaction.update(requestRef, {
                        rewardProcessed: true,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });
                console.log(`â Referral reward à§³${amount} added to user ${referrerId}`);
            } catch (error) {
                console.error('Error adding referral reward:', error);
            }
        }

        // â FIXED: 4. UPDATE REFERRAL SUMMARY â LIVE COUNTS
        function updateReferralSummary(snapshot) {
            console.log('Updating referral summary from snapshot');
            
            let totalReferrals = 0;
            let pendingReferrals = 0;
            let verifiedReferrals = 0;
            let totalEarning = 0;
            
            snapshot.forEach(doc => {
                const referral = doc.data();
                totalReferrals++;
                
                if (referral.status === 'pending') {
                    pendingReferrals++;
                } else if (referral.status === 'verified') {
                    verifiedReferrals++;
                    totalEarning += referral.rewardAmount || 0;
                }
            });
            
            // Update UI
            document.getElementById('total-referral').textContent = totalReferrals;
            document.getElementById('pending-referral').textContent = pendingReferrals;
            document.getElementById('verified-referral').textContent = verifiedReferrals;
            document.getElementById('verified-members-count').textContent = verifiedReferrals;
            document.getElementById('total-earning').textContent = totalEarning.toFixed(2);
        }

        // â FIXED: 5. LOAD REFERRAL LIST WITH FILTER â HANDLES INDEX ERRORS
        async function loadReferralList(filter = 'all') {
            const user = auth.currentUser;
            if (!user) return;
            
            console.log('Loading referral list with filter:', filter);
            
            // Update active button style
            const filterButtons = document.querySelectorAll('#my-referrals-view .master-btn');
            filterButtons.forEach(btn => {
                btn.classList.remove('master-btn-primary');
                btn.classList.add('master-btn-secondary');
            });
            
            let activeBtn;
            if (filter === 'all') activeBtn = document.getElementById('filter-all');
            else if (filter === 'verified') activeBtn = document.getElementById('filter-verified');
            else if (filter === 'pending') activeBtn = document.getElementById('filter-pending');
            
            if (activeBtn) {
                activeBtn.classList.remove('master-btn-secondary');
                activeBtn.classList.add('master-btn-primary');
            }
            
            try {
                let query = db.collection('referral_requests')
                    .where('referrerId', '==', user.uid);
                
                if (filter === 'verified') {
                    query = query.where('status', '==', 'verified');
                } else if (filter === 'pending') {
                    query = query.where('status', '==', 'pending');
                }
                
                query = query.orderBy('createdAt', 'desc');
                
                const snapshot = await query.get();
                updateReferralListUI(snapshot, filter);
                
            } catch (error) {
                console.error('Error loading referral list:', error);
                
                if (error.code === 'failed-precondition') {
                    showToast('Firestore index missing. Please create index for referral_requests (referrerId, status, createdAt).', 'error');
                }
                
                const container = document.getElementById('referral-list-content');
                if (container) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px; color: var(--danger);">
                            <i class="fa-solid fa-exclamation-circle" style="font-size: 48px; margin-bottom: 20px;"></i>
                            <p>Error loading referral list. Please check Firestore indexes.</p>
                        </div>
                    `;
                }
            }
        }

        // â FIXED: 6. UPDATE REFERRAL LIST UI â CLEAN & READABLE
        function updateReferralListUI(snapshot, filter) {
            const container = document.getElementById('referral-list-content');
            if (!container) return;

            if (snapshot.empty) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-light);">
                        <i class="fa-solid fa-users" style="font-size: 48px; margin-bottom: 20px; opacity: 0.5;"></i>
                        <p>No referrals yet. Share your referral link to earn!</p>
                    </div>
                `;
                return;
            }

            let html = '';
            let index = 1;
            
            snapshot.forEach(doc => {
                const referral = doc.data();
                const joinDate = referral.joinDate ? referral.joinDate.toDate() : new Date();
                const formattedDate = joinDate.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                const statusBadge = referral.status === 'verified' 
                    ? '<span class="badge-approved">Verified</span>'
                    : '<span class="badge-pending">Pending</span>';
                
                const earning = referral.status === 'verified' ? `à§³${referral.rewardAmount || 0}` : 'à§³0';
                
                html += `
                    <div style="padding: 15px; border-bottom: 1px solid var(--light-2);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 30px; height: 30px; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;">
                                    ${index}
                                </div>
                                <div>
                                    <div style="font-weight: 600; color: var(--dark);">${referral.referredUserName || 'User'}</div>
                                    <div style="font-size: 12px; color: var(--text-light);">${referral.referredUserEmail || ''}</div>
                                </div>
                            </div>
                            <div>${statusBadge}</div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--text-light);">
                            <div>Joined: ${formattedDate}</div>
                            <div>Earning: ${earning}</div>
                        </div>
                    </div>
                `;
                index++;
            });

            container.innerHTML = html;
        }

        // --- REMAINING FUNCTIONS (REQUIRED FOR APP FUNCTIONALITY) ---

        // ð´ LOAD SALARY PACKAGES ONLY â History functions removed
        function loadSalaryPackages(snapshot) {
            const packagesContainer = document.getElementById('salary-packages-container');
            if (!packagesContainer) return;

            packagesContainer.innerHTML = '';

            if (snapshot.empty) {
                packagesContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-light);">
                        <i class="fa-solid fa-inbox" style="font-size: 48px; margin-bottom: 20px; opacity: 0.5;"></i>
                        <p>No Salary Packages Available</p>
                    </div>
                `;
                return;
            }

            let packagesHTML = '';
            snapshot.forEach(doc => {
                const pkg = doc.data();
                const pkgId = doc.id;

                const userVerifiedReferrals = parseInt(document.getElementById('verified-members-count').textContent) || 0;
                const isEligible = userVerifiedReferrals >= pkg.requiredVerified;

                packagesHTML += `
                    <div class="salary-package-card ${isEligible ? '' : 'locked'}">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                            <div>
                                <div style="font-size: 16px; font-weight: 700; color: var(--dark);">${pkg.name}</div>
                                <div class="salary-requirement" style="font-size: 14px; color: var(--text-light); margin-top: 5px;">
                                    <i class="fa-solid fa-users"></i> ${pkg.requiredVerified} Verified Referrals Required
                                </div>
                            </div>
                            <div class="salary-amount-bdt" style="font-size: 24px; font-weight: 800; color: ${isEligible ? 'var(--success)' : 'var(--text-light)'};">
                                à§³${pkg.salaryAmount}
                            </div>
                        </div>
                        <div class="salary-requirement">
                            <div style="margin-bottom: 10px;">
                                <span style="color: var(--text-light);">Your Verified Referrals:</span>
                                <span class="${isEligible ? 'verified-count' : 'required-count'}" style="color: ${isEligible ? 'var(--success)' : 'var(--text-light)'}; font-weight: 700; margin-left: 10px;">
                                    ${userVerifiedReferrals} / ${pkg.requiredVerified}
                                </span>
                            </div>
                            <button class="master-btn master-btn-green master-btn-full" 
                                    onclick="applySalary('${pkgId}', '${pkg.name}', ${pkg.requiredVerified}, ${pkg.salaryAmount})" 
                                    ${isEligible ? '' : 'disabled'}
                                    style="margin-top: 15px;">
                                <i class="fa-solid ${isEligible ? 'paper-plane' : 'lock'}"></i> 
                                ${isEligible ? 'Apply for Salary' : 'Locked'}
                            </button>
                        </div>
                    </div>
                `;
            });

            packagesContainer.innerHTML = packagesHTML;
        }

        // APPLY SALARY FUNCTION
        async function applySalary(packageId, packageName, requiredVerified, salaryAmount) {
            const user = auth.currentUser;
            if (!user || !userDocRef || !userData) {
                showToast('Please login again', 'error');
                return;
            }

            const userVerifiedReferrals = parseInt(document.getElementById('verified-members-count').textContent) || 0;
            if (userVerifiedReferrals < requiredVerified) {
                showToast(`You need ${requiredVerified} verified referrals for this salary package.`, 'warning');
                return;
            }

            try {
                const existingAppQuery = await db.collection('salary_applications')
                    .where('uid', '==', user.uid)
                    .where('packageId', '==', packageId)
                    .where('status', 'in', ['processing', 'approved'])
                    .get();

                if (!existingAppQuery.empty) {
                    showToast('You have already applied for this salary package.', 'warning');
                    return;
                }

                const salaryData = {
                    uid: user.uid,
                    packageId: packageId,
                    packageName: packageName,
                    requiredVerified: requiredVerified,
                    userVerifiedAtApply: userVerifiedReferrals,
                    salaryAmount: salaryAmount,
                    applyDate: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'processing',
                    isActive: true
                };

                await db.collection('salary_applications').add(salaryData);

                showToast(`Applied for ${packageName} Salary (à§³${salaryAmount}/month) successfully!`);

            } catch (error) {
                console.error('Error applying for salary:', error);
                showToast('Failed to apply for salary', 'error');
            }
        }

        // UPDATE VERIFICATION STATUS
        function updateVerificationStatus(status) {
            const statusDisplay = document.getElementById('account-status-display');
            const badge = document.getElementById('badge-text');
            const statusAlert = document.getElementById('verification-status-alert');
            const verificationText = document.getElementById('verification-text');
            const verifyBtnText = document.getElementById('verify-btn-text');
            const verifyBtnCell = document.getElementById('verify-now-button-cell');
            
            if (status === 'unverified') {
                statusDisplay.innerHTML = '<span class="status-unverified"><i class="fa-solid fa-xmark"></i> Non-Verified</span>';
                badge.innerHTML = '<i class="fa-solid fa-xmark"></i> Unverified';
                badge.className = 'unverified-badge';
                statusAlert.className = 'status-alert';
                verificationText.textContent = 'Account not verified';
                verifyBtnText.textContent = 'Verify';
                statusAlert.style.display = 'flex';
                if (verifyBtnCell) verifyBtnCell.style.display = 'block';
            } else if (status === 'processing') {
                statusDisplay.innerHTML = '<span class="status-processing"><i class="fa-solid fa-clock"></i> Processing</span>';
                badge.innerHTML = '<i class="fa-solid fa-clock"></i> Processing';
                badge.className = 'processing-badge';
                statusAlert.className = 'status-alert processing';
                verificationText.textContent = 'Verification in progress';
                verifyBtnText.textContent = 'View';
                statusAlert.style.display = 'flex';
                if (verifyBtnCell) verifyBtnCell.style.display = 'block'; // show button (view)
            } else if (status === 'verified') {
                statusDisplay.innerHTML = '<span class="status-verified"><i class="fa-solid fa-check"></i> Verified</span>';
                badge.innerHTML = '<i class="fa-solid fa-check"></i> Verified';
                badge.className = 'verified-badge';
                statusAlert.style.display = 'none';
                // â Hide Verify Now button
                if (verifyBtnCell) verifyBtnCell.style.display = 'none';
            }
        }

        // OLD loadWithdrawPackages â kept for reference but no longer called (demo data removed)
        async function loadWithdrawPackages() {
            console.warn('â ï¸ Old loadWithdrawPackages called â no longer used. All packages are now wallet-wise.');
        }

        // â NEW: SELECT WITHDRAW PACKAGE
        function selectWithdrawPackage(pkg) {
            selectedWithdrawPackage = pkg;
            
            const packageGrid = document.getElementById('withdraw-package-grid');
            const packageCards = packageGrid.querySelectorAll('.package-card');
            packageCards.forEach(card => {
                card.classList.remove('selected');
            });
            
            packageCards.forEach(card => {
                if (card.textContent.includes(`à§³${pkg.withdrawAmount}`)) {
                    card.classList.add('selected');
                }
            });
            
            document.getElementById('calc-package-name').textContent = `à§³${pkg.withdrawAmount} Package`;
            document.getElementById('calc-amount').textContent = `à§³${pkg.withdrawAmount}`;
            document.getElementById('calc-charge').textContent = `à§³${pkg.charge}`;
            document.getElementById('calc-receive').textContent = `à§³${pkg.receiveAmount}`;
        }

        // â MODIFIED: SUBMIT WITHDRAW â NO TOTALWITHDRAW INCREMENT
        async function submitWithdraw() {
            const paymentMethodSelect = document.getElementById('withdraw-payment-method');
            const paymentMethod = paymentMethodSelect.value;
            const receiverNumber = document.getElementById('receiver-number').value;
            
            if (!paymentMethod) {
                showToast('Please select a payment method', 'error');
                return;
            }
            
            if (!receiverNumber || receiverNumber.length !== 11 || !receiverNumber.startsWith('01')) {
                showToast('Please enter a valid 11-digit Bangladeshi mobile number', 'error');
                return;
            }
            
            if (!selectedWithdrawPackage) {
                showToast('Please select a withdraw package', 'error');
                return;
            }

            const walletType = selectedWithdrawPackage.walletType;
            if (!walletType) {
                showToast('Package wallet type is missing', 'error');
                return;
            }
            
            const user = auth.currentUser;
            if (!user || !userDocRef || !userData) {
                showToast('Please login again', 'error');
                return;
            }

            // Get current balance for selected wallet
            let currentBalance = 0;
            switch (walletType) {
                case 'mainBalance': currentBalance = userData.mainBalance || 0; break;
                case 'referralIncome': currentBalance = userData.referralIncome || 0; break;
                case 'salaryWallet': currentBalance = userData.salaryWallet || 0; break;
                case 'gmailWallet': currentBalance = userData.gmailWallet || 0; break;
                case 'freeJobBalance': currentBalance = userData.freeJobBalance || 0; break;
                default: currentBalance = 0;
            }

            if (currentBalance < selectedWithdrawPackage.withdrawAmount) {
                showToast('Insufficient balance in selected wallet', 'error');
                return;
            }
            
            const btn = document.getElementById('withdraw-submit-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="loading-spinner"></div> Processing...';
            btn.disabled = true;
            
            try {
                await db.runTransaction(async (transaction) => {
                    const userDoc = await transaction.get(userDocRef);
                    if (!userDoc.exists) {
                        throw new Error('User document not found');
                    }
                    
                    const freshData = userDoc.data();
                    let freshBalance = 0;
                    switch (walletType) {
                        case 'mainBalance': freshBalance = freshData.mainBalance || 0; break;
                        case 'referralIncome': freshBalance = freshData.referralIncome || 0; break;
                        case 'salaryWallet': freshBalance = freshData.salaryWallet || 0; break;
                        case 'gmailWallet': freshBalance = freshData.gmailWallet || 0; break;
                        case 'freeJobBalance': freshBalance = freshData.freeJobBalance || 0; break;
                    }
                    
                    if (freshBalance < selectedWithdrawPackage.withdrawAmount) {
                        throw new Error('Insufficient balance');
                    }
                    
                    // Dynamically update the correct wallet field
                    const updateData = {};
                    updateData[walletType] = firebase.firestore.FieldValue.increment(-selectedWithdrawPackage.withdrawAmount);
                    // ð´ DO NOT INCREMENT totalWithdraw HERE â only on approval
                    updateData.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                    
                    transaction.update(userDocRef, updateData);
                    
                    const withdrawData = {
                        uid: user.uid,
                        walletType: walletType,
                        packageId: selectedWithdrawPackage.id || '',
                        withdrawAmount: selectedWithdrawPackage.withdrawAmount,
                        charge: selectedWithdrawPackage.charge,
                        receiveAmount: selectedWithdrawPackage.receiveAmount,
                        paymentMethod: paymentMethod,
                        receiverNumber: receiverNumber,
                        status: 'processing',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    const withdrawRef = db.collection('withdraw_requests').doc();
                    transaction.set(withdrawRef, withdrawData);
                });
                
                showToast('Withdraw request submitted successfully! Processing time: 24-48 hours.');
                
                // Clear form
                document.getElementById('receiver-number').value = '';
                paymentMethodSelect.value = '';
                selectedWithdrawPackage = null;
                
                // Reset calculation preview
                document.getElementById('calc-package-name').textContent = '-';
                document.getElementById('calc-amount').textContent = 'à§³0';
                document.getElementById('calc-charge').textContent = 'à§³0';
                document.getElementById('calc-receive').textContent = 'à§³0';
                
                // Unhighlight packages
                const packageGrid = document.getElementById('withdraw-package-grid');
                const packageCards = packageGrid.querySelectorAll('.package-card');
                packageCards.forEach(card => card.classList.remove('selected'));
                
            } catch (error) {
                console.error('Error submitting withdraw:', error);
                if (error.message === 'Insufficient balance') {
                    showToast('Insufficient balance', 'error');
                } else {
                    showToast('Failed to submit withdraw request: ' + error.message, 'error');
                }
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // â NEW: SETUP WITHDRAW REQUESTS LISTENER â Handles status changes & table
        function setupWithdrawRequestsListener(userId) {
            if (withdrawRequestsListener) {
                withdrawRequestsListener();
            }

            withdrawRequestsListener = db.collection('withdraw_requests')
                .where('uid', '==', userId)
                .orderBy('createdAt', 'desc')
                .onSnapshot((snapshot) => {
                    // Process status changes for approved/rejected
                    snapshot.docChanges().forEach(async (change) => {
                        if (change.type === 'modified') {
                            const request = change.doc.data();
                            const oldRequest = change.doc.metadata.hasPendingWrites ? null : null; // can't get old data easily
                            // We'll rely on a flag 'totalWithdrawAdded' to avoid double increments
                            if (request.status === 'approved' && !request.totalWithdrawAdded) {
                                await handleWithdrawApproved(userId, request.withdrawAmount, change.doc.id);
                            } else if (request.status === 'rejected' && !request.refundProcessed) {
                                await handleWithdrawRejected(userId, request.walletType, request.withdrawAmount, change.doc.id);
                            }
                        }
                    });

                    // Update the withdraw history table
                    updateWithdrawHistoryTable(snapshot);
                }, (error) => {
                    console.error('Error in withdraw requests listener:', error);
                });
        }

        // â NEW: Handle withdraw approval â add to totalWithdraw
        async function handleWithdrawApproved(userId, amount, requestId) {
            try {
                await db.runTransaction(async (transaction) => {
                    const userRef = db.collection('users').doc(userId);
                    const requestRef = db.collection('withdraw_requests').doc(requestId);
                    
                    const userDoc = await transaction.get(userRef);
                    const requestDoc = await transaction.get(requestRef);
                    
                    if (!userDoc.exists || !requestDoc.exists) return;
                    
                    const requestData = requestDoc.data();
                    if (requestData.status !== 'approved' || requestData.totalWithdrawAdded) return;
                    
                    transaction.update(userRef, {
                        totalWithdraw: firebase.firestore.FieldValue.increment(amount),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    transaction.update(requestRef, {
                        totalWithdrawAdded: true,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });
                console.log(`â Withdraw approved: à§³${amount} added to totalWithdraw`);
            } catch (error) {
                console.error('Error handling withdraw approval:', error);
            }
        }

        // â NEW: Handle withdraw rejection â refund amount to wallet
        async function handleWithdrawRejected(userId, walletType, amount, requestId) {
            try {
                await db.runTransaction(async (transaction) => {
                    const userRef = db.collection('users').doc(userId);
                    const requestRef = db.collection('withdraw_requests').doc(requestId);
                    
                    const userDoc = await transaction.get(userRef);
                    const requestDoc = await transaction.get(requestRef);
                    
                    if (!userDoc.exists || !requestDoc.exists) return;
                    
                    const requestData = requestDoc.data();
                    if (requestData.status !== 'rejected' || requestData.refundProcessed) return;
                    
                    const updateData = {};
                    updateData[walletType] = firebase.firestore.FieldValue.increment(amount);
                    updateData.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                    
                    transaction.update(userRef, updateData);
                    
                    transaction.update(requestRef, {
                        refundProcessed: true,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });
                console.log(`â Withdraw rejected: à§³${amount} refunded to ${walletType}`);
            } catch (error) {
                console.error('Error handling withdraw rejection:', error);
            }
        }

        // â NEW: Update withdraw history table (moved from old updateWithdrawHistory)
        async function updateWithdrawHistoryTable(snapshot) {
            const tbody = document.getElementById('withdraw-processing-tbody');
            if (!tbody) return;

            tbody.innerHTML = '';

            if (snapshot.empty) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: var(--text-light);">
                            <i class="fa-solid fa-inbox" style="font-size: 48px; margin-bottom: 20px; opacity: 0.5;"></i>
                            <p>No withdraw history yet</p>
                        </td>
                    </tr>
                `;
                return;
            }

            let sl = 1;
            
            const rows = [];
            
            for (const doc of snapshot.docs) {
                const data = doc.data();
                const date = data.createdAt ? data.createdAt.toDate() : new Date();
                const formattedDate = date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                let paymentMethodName = 'Unknown';
                
                try {
                    if (data.paymentMethod) {
                        const cachedMethod = paymentMethods.find(method => method.id === data.paymentMethod);
                        if (cachedMethod) {
                            paymentMethodName = cachedMethod.methodName || cachedMethod.name || data.paymentMethod;
                        } else {
                            const methodDoc = await db.collection('payment_methods').doc(data.paymentMethod).get();
                            if (methodDoc.exists) {
                                const methodData = methodDoc.data();
                                paymentMethodName = methodData.methodName || methodData.name || data.paymentMethod;
                            } else {
                                paymentMethodName = data.paymentMethod;
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error fetching payment method name:', error);
                    paymentMethodName = data.paymentMethod || 'N/A';
                }
                
                const statusClass = getStatusClass(data.status);
                const statusText = data.status || 'pending';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="padding: 12px;">${sl}</td>
                    <td style="padding: 12px;">à§³${data.withdrawAmount || 0}</td>
                    <td style="padding: 12px;"><strong>${paymentMethodName}</strong></td>
                    <td style="padding: 12px;">${data.receiverNumber || ''}</td>
                    <td style="padding: 12px;">
                        <span class="${statusClass}">${statusText}</span>
                    </td>
                    <td style="padding: 12px;">${formattedDate}</td>
                `;
                rows.push(row);
                sl++;
            }
            
            rows.forEach(row => tbody.appendChild(row));
        }

        // SUBMIT VERIFICATION
        async function submitVerification() {
            const methodSelect = document.getElementById('verification-method-select');
            const methodId = methodSelect.value;
            const senderNumber = document.getElementById('sender-number').value;
            const transactionId = document.getElementById('transaction-id').value;
            
            if (!methodId) {
                showToast('Please select a payment method', 'error');
                return;
            }
            
            if (!senderNumber || senderNumber.length !== 11 || !senderNumber.startsWith('01')) {
                showToast('Please enter a valid 11-digit phone number', 'error');
                return;
            }
            
            if (!transactionId) {
                showToast('Please enter Transaction ID (TrxID)', 'error');
                return;
            }
            
            const user = auth.currentUser;
            if (!user || !userDocRef) {
                showToast('Please login again', 'error');
                return;
            }
            
            const btn = document.getElementById('verification-submit-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="loading-spinner"></div> Submitting...';
            btn.disabled = true;
            
            try {
                const verificationData = {
                    uid: user.uid,
                    paymentMethod: methodId,
                    senderNumber: senderNumber,
                    transactionId: transactionId,
                    status: 'processing',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('verification_requests').add(verificationData);
                
                await userDocRef.update({
                    verificationStatus: 'processing',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showToast('Verification request submitted successfully! Status: Processing');
                
                methodSelect.value = '';
                document.getElementById('receiver-number-display').value = '';
                document.getElementById('verification-amount-display').value = '';
                document.getElementById('sender-number').value = '';
                document.getElementById('transaction-id').value = '';
                
                setTimeout(() => {
                    navigateTo('dashboard');
                }, 2000);
                
            } catch (error) {
                console.error('â Error submitting verification:', error);
                showToast('Failed to submit verification: ' + error.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

      auth.onAuthStateChanged(async (user) => {

    // â Step 1: Referral Code Detect
    const urlParams = new URLSearchParams(window.location.search);
    const referralCode = urlParams.get("ref");

    // â Step 2: If NOT logged in but referral exists â Stay on Signup Page
    if (!user && referralCode) {

        console.log("Referral Visitor â Signup Page Stay");

        openSignupPage();

        setTimeout(() => {
            const referralInput = document.getElementById("signup-referral");
            if (referralInput) {
                referralInput.value = referralCode.trim();
                referralInput.readOnly = true;
            }
        }, 300);

        return; // ð« Stop Here (do not showWelcome)
    }

    // â Normal Auth Flow
    if (user) {
        try {
            const userDoc = await db.collection("users").doc(user.uid).get();

            if (userDoc.exists) {

                setupUserListener(user.uid);
                setupAppConfigListener();
                setupReferralSettingsListener();
                setupPaymentMethodsListener();
                setupVerificationMethodsListener();

                document.getElementById("auth-container").style.display = "none";
                document.getElementById("app-container").style.display = "block";

                navigateTo("dashboard");

            } else {
                await auth.signOut();
                showToast("User data not found. Please sign up again.", "error");
                showSignIn();
            }

        } catch (error) {
            console.error("Auth listener error:", error);
            showToast("An error occurred. Please try again.", "error");
            showSignIn();
        }

    } else {
        // â Only show welcome if no referral
        showWelcome();
    }
});

        // --- AUTHENTICATION FUNCTIONS ---
        async function signIn(event) {
            event.preventDefault();
            
            const email = document.getElementById('signin-email').value.trim();
            const password = document.getElementById('signin-password').value;
            const btn = document.getElementById('signin-btn');
            const errorDiv = document.getElementById('signin-error');
            const errorText = document.getElementById('signin-error-text');
            
            if (!email || !password) {
                errorDiv.style.display = 'flex';
                errorText.textContent = 'à¦à¦®à§à¦à¦² à¦à¦¬à¦ à¦ªà¦¾à¦¸à¦à¦¯à¦¼à¦¾à¦°à§à¦¡ à¦¦à¦¿à¦¨';
                return;
            }
            
            const originalBtnText = btn.innerHTML;
            btn.innerHTML = '<div class="loading-spinner"></div> à¦²à¦à¦à¦¨ à¦¹à¦à§à¦à§...';
            btn.disabled = true;
            errorDiv.style.display = 'none';
            
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                
                const userDoc = await db.collection('users').doc(userCredential.user.uid).get();
                
                if (!userDoc.exists) {
                    await auth.signOut();
                    throw new Error('USER_DOCUMENT_NOT_FOUND');
                }
                
                setupUserListener(userCredential.user.uid);
                setupAppConfigListener();
                setupReferralSettingsListener();
                setupPaymentMethodsListener();
                setupVerificationMethodsListener();
                
                document.getElementById('auth-container').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                navigateTo('dashboard');
                
                document.getElementById('signin-email').value = '';
                document.getElementById('signin-password').value = '';
                
                showToast('à¦¸à¦«à¦²à¦­à¦¾à¦¬à§ à¦²à¦à¦à¦¨ à¦¹à¦¯à¦¼à§à¦à§à¥¤');
                
            } catch (error) {
                console.error('â Sign In Error:', error);
                
                errorDiv.style.display = 'flex';
                
                if (error.code === 'auth/user-not-found' || error.message === 'USER_DOCUMENT_NOT_FOUND') {
                    errorText.textContent = 'à¦à¦ à¦à¦®à§à¦à¦²à§ à¦à§à¦¨à§ à¦à§à¦¯à¦¾à¦à¦¾à¦à¦¨à§à¦ à¦¨à§à¦à¥¤ à¦¸à¦¾à¦à¦¨ à¦à¦ª à¦à¦°à§à¦¨à¥¤';
                } 
                else if (error.code === 'auth/wrong-password') {
                    errorText.textContent = 'à¦ªà¦¾à¦¸à¦à¦¯à¦¼à¦¾à¦°à§à¦¡ à¦­à§à¦² à¦¹à§à§à¦à§à¥¤ à¦à¦¬à¦¾à¦° à¦à§à¦·à§à¦à¦¾ à¦à¦°à§à¦¨à¥¤';
                }
                else if (error.code === 'auth/invalid-email') {
                    errorText.textContent = 'à¦à¦®à§à¦à¦² à¦ à¦¿à¦à¦¾à¦¨à¦¾à¦à¦¿ à¦¸à¦ à¦¿à¦ à¦¨à§à¥¤';
                }
                else if (error.code === 'auth/too-many-requests') {
                    errorText.textContent = 'à¦à¦¨à§à¦à¦¬à¦¾à¦° à¦à§à¦·à§à¦à¦¾ à¦à¦°à¦¾ à¦¹à§à§à¦à§à¥¤ à¦ªà¦°à§ à¦à¦¬à¦¾à¦° à¦à§à¦·à§à¦à¦¾ à¦à¦°à§à¦¨à¥¤';
                }
                else if (error.code === 'auth/network-request-failed') {
                    errorText.textContent = 'à¦¨à§à¦à¦à¦¯à¦¼à¦¾à¦°à§à¦ à¦¸à¦®à¦¸à§à¦¯à¦¾à¥¤ à¦à¦¨à§à¦à¦¾à¦°à¦¨à§à¦ à¦à§à¦ à¦à¦°à§à¦¨à¥¤';
                }
                else {
                    errorText.textContent = 'à¦²à¦à¦à¦¨à§ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à§à§à¦à§à¥¤ à¦à¦¬à¦¾à¦° à¦à§à¦·à§à¦à¦¾ à¦à¦°à§à¦¨à¥¤';
                }
            } finally {
                btn.innerHTML = originalBtnText;
                btn.disabled = false;
            }
        }

        // FORGOT PASSWORD
        async function resetPassword(event) {
            event.preventDefault();
            
            const email = document.getElementById('forgot-email').value;
            const btn = document.getElementById('forgot-btn');
            const errorDiv = document.getElementById('forgot-error');
            const successDiv = document.getElementById('forgot-success');
            
            btn.innerHTML = '<div class="loading-spinner"></div> Sending Reset Link...';
            btn.disabled = true;
            
            try {
                await auth.sendPasswordResetEmail(email);
                
                successDiv.style.display = 'flex';
                document.getElementById('forgot-success-text').textContent = 
                    'à¦à¦ªà¦¨à¦¾à¦° à¦à¦®à§à¦à¦²à§ à¦à¦à¦à¦¿ à¦ªà¦¾à¦¸à¦à¦¯à¦¼à¦¾à¦°à§à¦¡ à¦°à¦¿à¦¸à§à¦ à¦²à¦¿à¦à¦ à¦ªà¦¾à¦ à¦¾à¦¨à§ à¦¹à¦¯à¦¼à§à¦à§à¥¤ à¦¦à¦¯à¦¼à¦¾ à¦à¦°à§ à¦à¦®à§à¦à¦² à¦à§à¦ à¦à¦°à§à¦¨à¥¤';
                errorDiv.style.display = 'none';
                
                btn.innerHTML = '<i class="fa-solid fa-key"></i> Reset Password';
                btn.disabled = false;
                
                document.getElementById('forgot-email').value = '';
                
            } catch (error) {
                errorDiv.style.display = 'flex';
                document.getElementById('forgot-error-text').textContent = getErrorMessage(error.code);
                successDiv.style.display = 'none';
                btn.innerHTML = '<i class="fa-solid fa-key"></i> Reset Password';
                btn.disabled = false;
            }
        }

        // AUTH SCREEN MANAGEMENT
        function showWelcome() {
            document.getElementById('welcome-screen').style.display = 'flex';
            document.getElementById('signin-screen').style.display = 'none';
            document.getElementById('signup-screen').style.display = 'none';
            document.getElementById('forgot-password-screen').style.display = 'none';
            clearAuthErrors();
        }

        function showSignIn() {
            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('signin-screen').style.display = 'flex';
            document.getElementById('signup-screen').style.display = 'none';
            document.getElementById('forgot-password-screen').style.display = 'none';
            clearAuthErrors();
        }

        function showSignUp() {
            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('signin-screen').style.display = 'none';
            document.getElementById('signup-screen').style.display = 'flex';
            document.getElementById('forgot-password-screen').style.display = 'none';
            clearAuthErrors();
        }

        function showForgotPassword() {
            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('signin-screen').style.display = 'none';
            document.getElementById('signup-screen').style.display = 'none';
            document.getElementById('forgot-password-screen').style.display = 'flex';
            clearAuthErrors();
        }

        function clearAuthErrors() {
            document.getElementById('signin-error').style.display = 'none';
            document.getElementById('signup-error').style.display = 'none';
            document.getElementById('forgot-error').style.display = 'none';
            document.getElementById('forgot-success').style.display = 'none';
        }

        // PROFILE FUNCTIONS
        async function updateUsername() {
            const newUsername = document.getElementById('username-input').value;
            if(!newUsername.trim()) {
                showToast('Username cannot be empty', 'error');
                return;
            }
            
            const user = auth.currentUser;
            if (user && userDocRef) {
                try {
                    await userDocRef.update({
                        fullName: newUsername,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    showToast('Username updated successfully!');
                } catch (error) {
                    console.error('Error updating username:', error);
                    showToast('Failed to update username', 'error');
                }
            }
        }

        // NAVIGATION
        let currentPage = 'dashboard';

        function toggleMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            if(sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
                overlay.style.display = 'none';
            } else {
                sidebar.classList.add('active');
                overlay.style.display = 'block';
            }
        }

        function navigateTo(pageId) {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            if (sidebar && sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
            }
            
            if (overlay) {
                overlay.style.display = 'none';
            }

            document.querySelectorAll('.page-view').forEach(p => p.classList.remove('active'));
            
            currentPage = pageId;
            
            const pages = {
                'dashboard': 'dashboard-view',
                'help-line': 'help-line-view',
                'profile': 'profile-view',
                'withdraw': 'withdraw-view',
                'withdraw-processing': 'withdraw-processing-view',
                'verify': 'verify-view',
                'gmail-sell': 'gmail-sell-view',
                'gmail-processing': 'gmail-processing-view',
                'referral-system': 'referral-system-view',
                'salary-apply': 'salary-apply-view',
                'my-referrals': 'my-referrals-view',
                // ===== FREE JOB PAGES =====
                'free-job-projects': 'free-job-projects-view',
                'free-job-cards': 'free-job-cards-view',
                'free-job-jobs': 'free-job-jobs-view',
                'free-job-details': 'free-job-details-view',
                // ===== JOB SUBMISSIONS PAGE =====
                'job-submissions': 'job-submissions-view'
            };
            
            if(pages[pageId]) {
                const pageElement = document.getElementById(pages[pageId]);
                if (pageElement) {
                    pageElement.classList.add('active');
                    
                    if (pageId === 'my-referrals') {
                        loadReferralList('all');
                    }
                    
                    if (pageId === 'help-line') {
                        setupSupportContactsListener();
                    }
                    
                    if (pageId === 'gmail-processing') {
                        const user = auth.currentUser;
                        if (user) {
                            setupGmailHistoryListener(user.uid);
                        }
                    }
                    
                    if (pageId === 'withdraw-processing') {
                        // Already listening via setupWithdrawRequestsListener
                    }

                    // ===== FREE JOB PAGE LOADERS =====
                    if (pageId === 'free-job-projects') {
                        loadFreeJobProjects();
                    }
                    if (pageId === 'free-job-cards' && selectedProjectId) {
                        document.getElementById('free-job-cards-project-title').textContent = 'Cards';
                        loadFreeJobCards(selectedProjectId);
                    }
                    if (pageId === 'free-job-jobs' && selectedCardId) {
                        document.getElementById('free-job-jobs-card-title').textContent = 'Jobs';
                        loadFreeJobJobs(selectedCardId);
                    }
                    if (pageId === 'free-job-details' && selectedJob) {
                        renderFreeJobDetails(selectedJob);
                    }

                    // â When withdraw page opens, ensure wallet selection triggers package load
                    if (pageId === 'withdraw') {
                        const walletSelect = document.getElementById('withdraw-wallet-select');
                        if (walletSelect && walletSelect.value) {
                            onWalletChange();
                        }
                    }
                }
            }
            
            window.scrollTo(0,0);
        }

        // â NEW: SETUP WALLET TYPES LISTENER (REAL-TIME)
        function setupWalletTypesListener() {
            if (walletTypesListener) {
                walletTypesListener();
            }

            walletTypesListener = db.collection('wallet_types')
                .where('status', '==', 'active')
                .orderBy('order', 'asc')
                .onSnapshot((snapshot) => {
                    walletTypes = [];
                    snapshot.forEach(doc => {
                        const wallet = doc.data();
                        wallet.id = doc.id;
                        walletTypes.push(wallet);
                    });
                    populateWalletDropdown();
                }, (error) => {
                    console.error('Error loading wallet types:', error);
                });
        }

        // â NEW: POPULATE WALLET DROPDOWN AND SELECT FIRST
        function populateWalletDropdown() {
            const select = document.getElementById('withdraw-wallet-select');
            if (!select) return;

            select.innerHTML = '<option value="">Select Wallet</option>';

            if (walletTypes.length === 0) {
                select.innerHTML = '<option value="">No wallets available</option>';
                return;
            }

            walletTypes.forEach(wallet => {
                const option = document.createElement('option');
                option.value = wallet.walletKey;
                option.textContent = wallet.title || wallet.walletKey;
                select.appendChild(option);
            });

            // Auto-select first wallet and trigger change
            if (walletTypes.length > 0) {
                select.value = walletTypes[0].walletKey;
                const event = new Event('change');
                select.dispatchEvent(event);
            }
        }

        // â NEW: HANDLE WALLET SELECTION CHANGE
        function onWalletChange() {
            const select = document.getElementById('withdraw-wallet-select');
            selectedWalletKey = select.value;

            if (!selectedWalletKey) {
                document.getElementById('withdraw-package-grid').innerHTML = '';
                document.getElementById('withdraw-available-balance').textContent = '0.00';
                return;
            }

            updateWithdrawAvailableBalance();
            loadWithdrawPackagesForWallet(selectedWalletKey);
        }

        // â NEW: UPDATE WITHDRAW AVAILABLE BALANCE BASED ON SELECTED WALLET
        function updateWithdrawAvailableBalance() {
            if (!userData || !selectedWalletKey) {
                document.getElementById('withdraw-available-balance').textContent = '0.00';
                return;
            }

            let balance = 0;
            switch (selectedWalletKey) {
                case 'mainBalance': balance = userData.mainBalance || 0; break;
                case 'referralIncome': balance = userData.referralIncome || 0; break;
                case 'salaryWallet': balance = userData.salaryWallet || 0; break;
                case 'gmailWallet': balance = userData.gmailWallet || 0; break;
                case 'freeJobBalance': balance = userData.freeJobBalance || 0; break;
                default: balance = 0;
            }
            document.getElementById('withdraw-available-balance').textContent = balance.toFixed(2);
        }

        // â NEW: LOAD WITHDRAW PACKAGES FOR SPECIFIC WALLET (REAL-TIME CAPABLE, SIMPLE GET)
        async function loadWithdrawPackagesForWallet(walletType) {
            const packageGrid = document.getElementById('withdraw-package-grid');
            if (!packageGrid) return;

            packageGrid.innerHTML = '<div style="grid-column: span 2; text-align: center; padding: 20px;"><i class="fa-solid fa-spinner fa-spin"></i> Loading packages...</div>';

            try {
                const snapshot = await db.collection('withdraw_packages')
                    .where('walletType', '==', walletType)
                    .where('status', '==', 'active')
                    .orderBy('priority', 'asc')
                    .get();

                packageGrid.innerHTML = '';

                if (snapshot.empty) {
                    packageGrid.innerHTML = `
                        <div style="grid-column: span 2; text-align: center; padding: 40px 20px; color: var(--text-light);">
                            <i class="fa-solid fa-inbox" style="font-size: 48px; margin-bottom: 20px; opacity: 0.5;"></i>
                            <p>No withdraw packages available for this wallet.</p>
                        </div>
                    `;
                    return;
                }

                snapshot.forEach(doc => {
                    const pkg = doc.data();
                    pkg.id = doc.id;
                    const packageCard = document.createElement('div');
                    packageCard.className = 'package-card';
                    packageCard.onclick = () => selectWithdrawPackage(pkg);
                    packageCard.innerHTML = `
                        <div class="package-amount">à§³${pkg.withdrawAmount}</div>
                        <div class="package-charge">Charge: à§³${pkg.charge}</div>
                        <div class="package-receive">Receive: à§³${pkg.receiveAmount}</div>
                    `;
                    packageGrid.appendChild(packageCard);
                });
            } catch (error) {
                console.error('Error loading withdraw packages:', error);
                packageGrid.innerHTML = `
                    <div style="grid-column: span 2; text-align: center; padding: 40px 20px; color: var(--danger);">
                        <i class="fa-solid fa-exclamation-circle" style="font-size: 48px; margin-bottom: 20px;"></i>
                        <p>Error loading withdraw packages. Please try again later.</p>
                    </div>
                `;
            }
        }

        // HELP LINE SYSTEM
        function openEmailSupport(email) {
            if (!email) {
                showToast('Email support is not available', 'error');
                return;
            }
            window.location.href = `mailto:${email}?subject=SmartPay Support Request`;
        }

        function openPhoneSupport(phone) {
            if (!phone) {
                showToast('Phone support is not available', 'error');
                return;
            }
            window.location.href = `tel:${phone}`;
        }

        function openWhatsAppSupport(whatsapp) {
            if (!whatsapp) {
                showToast('WhatsApp support is not available', 'error');
                return;
            }
            const message = encodeURIComponent('Hello, I need help with SmartPay.');
            window.open(`https://wa.me/${whatsapp}?text=${message}`, '_blank');
        }

        function openTelegramChannel(telegram) {
            if (!telegram) {
                showToast('Telegram channel is not available', 'error');
                return;
            }
            window.open(telegram, '_blank');
        }

        // COPY FUNCTIONS
        function copyText(text) {
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => {
                    showToast('Copied successfully!');
                }).catch(() => {
                    fallbackCopy(text);
                });
            } else {
                fallbackCopy(text);
            }
        }

        function fallbackCopy(text) {
            const input = document.createElement('input');
            input.value = text;
            document.body.appendChild(input);
            input.select();
            input.setSelectionRange(0, 99999);
            document.execCommand('copy');
            document.body.removeChild(input);
            showToast('Copied successfully!');
        }

        function copyReceiverNumber() {
            const receiverNumber = document.getElementById('receiver-number-display').value;
            if (!receiverNumber) {
                showToast('No receiver number found', 'error');
                return;
            }
            copyText(receiverNumber);
        }

        function copyReferralLink() {
            const link = document.getElementById('referral-link').value;
            if (!link) {
                showToast('No referral link found', 'error');
                return;
            }
            
            const message = 'Join SmartPay using my referral link!';
            const textToCopy = `${message}\n\n${link}`;
            copyText(textToCopy);
        }

        function copyReferralId() {
            const id = document.getElementById('referral-id').value;
            if (!id) {
                showToast('No referral ID found', 'error');
                return;
            }
            copyText(id);
        }

        // MODAL FUNCTIONS
        function showMessageModal() {
            const modal = document.getElementById('message-modal');
            if (modal) {
                modal.classList.add('active');
            }
        }

        function closeMessageModal() {
            const modal = document.getElementById('message-modal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        function showGmailNoticeModal() {
            const modal = document.getElementById('gmail-notice-modal');
            if (modal) {
                modal.classList.add('active');
            }
        }

        function closeGmailNoticeModal() {
            const modal = document.getElementById('gmail-notice-modal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        // TOAST MESSAGES
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = 'toast-message ' + type;
            toast.innerHTML = `
                <i class="fa-solid fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'exclamation-triangle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 400);
            }, 3000);
        }

        // UTILITY FUNCTIONS
        function getErrorMessage(errorCode) {
            const messages = {
                'auth/invalid-email': 'Invalid email address',
                'auth/user-disabled': 'This account has been disabled',
                'auth/user-not-found': 'No account found with this email',
                'auth/wrong-password': 'Incorrect password',
                'auth/email-already-in-use': 'Email already in use',
                'auth/weak-password': 'Password is too weak',
                'auth/operation-not-allowed': 'Operation not allowed',
                'auth/network-request-failed': 'Network error. Please check your connection'
            };
            
            return messages[errorCode] || 'An error occurred. Please try again.';
        }

        function formatDate(date) {
            if (!date) return 'â';
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function getStatusClass(status) {
            switch(status) {
                case 'approved':
                case 'paid':
                case 'verified':
                    return 'badge-approved';
                case 'rejected':
                case 'failed':
                    return 'badge-rejected';
                case 'processing':
                case 'pending':
                default:
                    return 'badge-pending';
            }
        }

        // GMAIL FUNCTIONS
        function setupGmailListeners() {
            const user = auth.currentUser;
            if (!user) return;

            if (gmailSettingsListener) {
                gmailSettingsListener();
            }
            
            gmailSettingsListener = db.collection('gmail_sell_settings').doc('settings')
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        updateGmailSettingsUI(doc.data());
                    }
                }, (error) => {
                    console.error('Error loading Gmail settings:', error);
                });

            setupGmailStatusSummary(user.uid);
            
            if (document.getElementById('gmail-processing-view')?.classList.contains('active')) {
                setupGmailHistoryListener(user.uid);
            }
        }

        // â NEW: Gmail Wallet Listener â detects approved status and adds to gmailWallet
        function setupGmailWalletListener(userId) {
            if (gmailWalletListener) {
                gmailWalletListener();
            }

            gmailWalletListener = db.collection('gmail_sell_requests')
                .where('uid', '==', userId)
                .onSnapshot((snapshot) => {
                    // Update summary totals
                    let totalApproved = 0;
                    let totalPending = 0;
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.status === 'approved') {
                            totalApproved += data.amount || 0;
                        } else if (data.status === 'processing') {
                            totalPending += data.amount || 0;
                        }
                    });
                    
                    document.getElementById('gmail-total-approved').textContent = `à§³${totalApproved}`;
                    document.getElementById('gmail-total-pending').textContent = `à§³${totalPending}`;
                    
                    // Process status changes for wallet addition
                    snapshot.docChanges().forEach(change => {
                        const doc = change.doc;
                        const data = doc.data();
                        
                        if (change.type === 'modified') {
                            if (data.status === 'approved' && !data.rewardAdded) {
                                addGmailReward(userId, data.amount || 0, doc.id);
                            }
                        } else if (change.type === 'added') {
                            if (data.status === 'approved' && !data.rewardAdded) {
                                addGmailReward(userId, data.amount || 0, doc.id);
                            }
                        }
                    });
                }, (error) => {
                    console.error('Error in Gmail wallet listener:', error);
                });
        }

        // â NEW: Add Gmail reward to gmailWallet
        async function addGmailReward(userId, amount, requestId) {
            try {
                await db.runTransaction(async (transaction) => {
                    const userRef = db.collection('users').doc(userId);
                    const requestRef = db.collection('gmail_sell_requests').doc(requestId);
                    
                    const userDoc = await transaction.get(userRef);
                    const requestDoc = await transaction.get(requestRef);
                    
                    if (!userDoc.exists || !requestDoc.exists) return;
                    
                    const requestData = requestDoc.data();
                    if (requestData.status !== 'approved' || requestData.rewardAdded) return;
                    
                    transaction.update(userRef, {
                        gmailWallet: firebase.firestore.FieldValue.increment(amount),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    transaction.update(requestRef, {
                        rewardAdded: true,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });
                console.log(`â Gmail reward à§³${amount} added to gmailWallet`);
            } catch (error) {
                console.error('Error adding Gmail reward:', error);
            }
        }

        function updateGmailSettingsUI(settings) {
            if (!settings) return;
            
            if (settings.pricePerGmail) {
                document.getElementById('gmail-price-amount').textContent = `à§³${settings.pricePerGmail}`;
            }
            
            if (settings.passwordToday) {
                document.getElementById('password-today-display').textContent = settings.passwordToday;
            }
            
            if (settings.message) {
                document.getElementById('gmail-notice-content').innerHTML = settings.message.replace(/\n/g, '<br>');
            }
        }

        function setupGmailStatusSummary(userId) {
            if (gmailProcessingListener) {
                gmailProcessingListener();
            }
            
            gmailProcessingListener = db.collection('gmail_sell_requests')
                .where('uid', '==', userId)
                .onSnapshot((snapshot) => {
                    updateGmailStatusSummary(snapshot);
                }, (error) => {
                    console.error('Error loading Gmail status summary:', error);
                });
        }

        function updateGmailStatusSummary(snapshot) {
            if (!snapshot) return;
            
            let processingCount = 0;
            let approvedCount = 0;
            let rejectedCount = 0;
            
            snapshot.forEach(doc => {
                const gmailData = doc.data();
                switch(gmailData.status) {
                    case 'processing':
                        processingCount++;
                        break;
                    case 'approved':
                        approvedCount++;
                        break;
                    case 'rejected':
                        rejectedCount++;
                        break;
                }
            });
            
            document.getElementById('gmail-processing-count').textContent = processingCount;
            document.getElementById('gmail-approved-count').textContent = approvedCount;
            document.getElementById('gmail-rejected-count').textContent = rejectedCount;
        }

        function setupGmailHistoryListener(userId) {
            if (gmailHistoryListener) {
                gmailHistoryListener();
            }
            
            gmailHistoryListener = db.collection('gmail_sell_requests')
                .where('uid', '==', userId)
                .orderBy('createdAt', 'desc')
                .onSnapshot((snapshot) => {
                    updateGmailHistory(snapshot);
                }, (error) => {
                    console.error('Error loading Gmail history:', error);
                });
        }

        function updateGmailHistory(snapshot) {
            const tbody = document.getElementById('gmail-history-tbody');
            if (!tbody) return;

            tbody.innerHTML = '';

            if (snapshot.empty) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: var(--text-light);">
                            <i class="fa-solid fa-inbox" style="font-size: 48px; margin-bottom: 20px; opacity: 0.5;"></i>
                            <p>No Gmail submissions yet</p>
                        </td>
                    </tr>
                `;
                return;
            }

            let sl = 1;
            snapshot.forEach(doc => {
                const gmailData = doc.data();
                const date = gmailData.createdAt ? gmailData.createdAt.toDate() : new Date();
                const formattedDate = date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                let statusBadge = '';
                switch(gmailData.status) {
                    case 'processing':
                        statusBadge = '<span class="badge-pending">Processing</span>';
                        break;
                    case 'approved':
                        statusBadge = '<span class="badge-approved">Approved</span>';
                        break;
                    case 'rejected':
                        statusBadge = '<span class="badge-rejected">Rejected</span>';
                        break;
                    default:
                        statusBadge = '<span class="badge-pending">Processing</span>';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="padding: 12px;">${sl}</td>
                    <td style="padding: 12px;">${gmailData.gmail || ''}</td>
                    <td style="padding: 12px;">à§³${gmailData.amount || 0}</td>
                    <td style="padding: 12px;">${statusBadge}</td>
                    <td style="padding: 12px;">${formattedDate}</td>
                `;
                tbody.appendChild(row);
                sl++;
            });
        }

        async function submitGmail() {
            const gmail = document.getElementById('gmail-address').value.trim();
            const password = document.getElementById('gmail-password').value.trim();
            const user = auth.currentUser;
            
            if (!user || !userDocRef) {
                showToast('Please login again', 'error');
                return;
            }
            
            if (!gmail || !password) {
                showToast('Please fill both Gmail and Password fields', 'error');
                return;
            }
            
            if (!gmail.includes('@gmail.com')) {
                showToast('Please enter a valid Gmail address', 'error');
                return;
            }
            
            try {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const todaySubmissionsQuery = await db.collection('gmail_sell_requests')
                    .where('uid', '==', user.uid)
                    .where('createdAt', '>=', firebase.firestore.Timestamp.fromDate(today))
                    .get();
                
                const settingsDoc = await db.collection('gmail_sell_settings').doc('settings').get();
                const maxSubmissions = settingsDoc.exists ? (settingsDoc.data().maxSubmissionsPerDay || 5) : 5;
                
                if (todaySubmissionsQuery.size >= maxSubmissions) {
                    showToast(`You can only submit ${maxSubmissions} Gmail(s) per day`, 'error');
                    return;
                }
            } catch (error) {
                console.error('Error checking daily limit:', error);
            }
            
            const btn = document.getElementById('gmail-submit-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="loading-spinner"></div> Submitting...';
            btn.disabled = true;
            
            try {
                const settingsDoc = await db.collection('gmail_sell_settings').doc('settings').get();
                const pricePerGmail = settingsDoc.exists ? (settingsDoc.data().pricePerGmail || 10) : 10;
                
                const gmailData = {
                    uid: user.uid,
                    gmail: gmail,
                    password: password,
                    amount: pricePerGmail,
                    status: 'processing',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('gmail_sell_requests').add(gmailData);
                
                showToast('Gmail submitted successfully! Status: Processing');
                
                document.getElementById('gmail-address').value = '';
                document.getElementById('gmail-password').value = '';
                
            } catch (error) {
                console.error('Error submitting Gmail:', error);
                showToast('Failed to submit Gmail', 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function copyPasswordToday() {
            const password = document.getElementById('password-today-display').textContent;
            if (!password || password === 'Loading...') {
                showToast('No password available', 'error');
                return;
            }
            copyText(password);
        }

        // ð´ SALARY LISTENERS â ONLY SALARY PACKAGES (history removed)
        function setupSalaryListeners() {
            const user = auth.currentUser;
            if (!user) return;

            if (salaryPackagesListener) {
                salaryPackagesListener();
            }
            
            salaryPackagesListener = db.collection('salary_packages')
                .where('status', '==', 'active')
                .onSnapshot(loadSalaryPackages, (error) => {
                    console.error('Error loading salary packages:', error);
                    const packagesContainer = document.getElementById('salary-packages-container');
                    if (packagesContainer) {
                        packagesContainer.innerHTML = `
                            <div style="text-align: center; padding: 40px 20px; color: var(--danger);">
                                <i class="fa-solid fa-exclamation-circle" style="font-size: 48px; margin-bottom: 20px;"></i>
                                <p>Error loading salary packages. Please try again later.</p>
                            </div>
                        `;
                    }
                });
            // ð´ salary_applications and salary_payments listeners removed
        }

        // SUPPORT CONTACTS LISTENER
        function setupSupportContactsListener() {
            if (supportContactsListener) {
                supportContactsListener();
            }

            supportContactsListener = db.collection('support_contacts')
                .doc('settings')
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        const supportData = doc.data();
                        updateSupportUI(supportData);
                    } else {
                        updateSupportUI(null);
                    }
                }, (error) => {
                    console.error('Error loading support contacts:', error);
                    updateSupportUI(null);
                });
        }

        function updateSupportUI(supportData) {
            const supportContainer = document.getElementById('support-cards-container');
            if (!supportContainer) return;

            supportContainer.innerHTML = '';

            if (!supportData) {
                supportContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-light);">
                        <i class="fa-solid fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
                        <h3 style="color: var(--dark); margin-bottom: 10px;">No Support Channels Available</h3>
                        <p style="color: var(--text-light);">Support contacts will be added soon. Please check back later.</p>
                    </div>
                `;
                return;
            }

            let supportCardsHTML = '';

            if (supportData.supportEmail && supportData.supportEmail.trim() !== '') {
                supportCardsHTML += `
                    <div class="support-card" id="email-support-card">
                        <div class="support-icon" style="background: linear-gradient(135deg, #ea4335 0%, #d93025 100%);">
                            <i class="fa-solid fa-envelope"></i>
                        </div>
                        <div class="support-title">Email Support</div>
                        <div class="support-desc">Get direct support via email for any account-related issues.</div>
                        <button class="master-btn master-btn-red master-btn-full" onclick="openEmailSupport('${supportData.supportEmail}')">
                            <i class="fa-solid fa-paper-plane"></i> Send Email
                        </button>
                    </div>
                `;
            }

            if (supportData.supportPhone && supportData.supportPhone.trim() !== '') {
                supportCardsHTML += `
                    <div class="support-card" id="phone-support-card">
                        <div class="support-icon" style="background: linear-gradient(135deg, #34a853 0%, #2e8b46 100%);">
                            <i class="fa-solid fa-phone"></i>
                        </div>
                        <div class="support-title">Direct Phone Support</div>
                        <div class="support-desc">Speak directly with our support team for immediate assistance.</div>
                        <button class="master-btn master-btn-green master-btn-full" onclick="openPhoneSupport('${supportData.supportPhone}')">
                            <i class="fa-solid fa-phone"></i> Call Now
                        </button>
                    </div>
                `;
            }

            if (supportData.whatsappNumber && supportData.whatsappNumber.trim() !== '') {
                supportCardsHTML += `
                    <div class="support-card" id="whatsapp-support-card">
                        <div class="support-icon" style="background: linear-gradient(135deg, #25d366 0%, #1da851 100%);">
                            <i class="fa-brands fa-whatsapp"></i>
                        </div>
                        <div class="support-title">WhatsApp Support</div>
                        <div class="support-desc">Chat instantly with our support team via WhatsApp.</div>
                        <button class="master-btn master-btn-green master-btn-full" onclick="openWhatsAppSupport('${supportData.whatsappNumber}')">
                            <i class="fa-brands fa-whatsapp"></i> Chat Now
                        </button>
                    </div>
                `;
            }

            if (supportData.telegramLink && supportData.telegramLink.trim() !== '') {
                supportCardsHTML += `
                    <div class="support-card" id="telegram-support-card">
                        <div class="support-icon" style="background: linear-gradient(135deg, #0088cc 0%, #006699 100%);">
                            <i class="fa-brands fa-telegram"></i>
                        </div>
                        <div class="support-title">Telegram Channel</div>
                        <div class="support-desc">Join our Telegram channel for updates and announcements.</div>
                        <button class="master-btn master-btn-primary master-btn-full" onclick="openTelegramChannel('${supportData.telegramLink}')">
                            <i class="fa-brands fa-telegram"></i> Join Channel
                        </button>
                    </div>
                `;
            }

            if (!supportCardsHTML) {
                supportCardsHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-light);">
                        <i class="fa-solid fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
                        <h3 style="color: var(--dark); margin-bottom: 10px;">No Support Channels Available</h3>
                        <p style="color: var(--text-light);">Support contacts will be added soon. Please check back later.</p>
                    </div>
                `;
            }

            supportContainer.innerHTML = supportCardsHTML;
        }

        // â FIXED: LOGOUT FUNCTION WITH CLEANUP
        async function logout() {
            try {
                if (userListener) {
                    userListener();
                    userListener = null;
                }
                
                if (appConfigListener) {
                    appConfigListener();
                    appConfigListener = null;
                }
                
                if (referralSettingsListener) {
                    referralSettingsListener();
                    referralSettingsListener = null;
                }
                
                if (referralRequestsListener) {
                    referralRequestsListener();
                    referralRequestsListener = null;
                }
                
                if (salaryPackagesListener) {
                    salaryPackagesListener();
                    salaryPackagesListener = null;
                }
                
                // ð´ salaryApplicationsListener and salaryPaymentsListener removed
                
                if (withdrawPackagesListener) {
                    withdrawPackagesListener();
                    withdrawPackagesListener = null;
                }
                
                if (withdrawRequestsListener) {
                    withdrawRequestsListener();
                    withdrawRequestsListener = null;
                }
                
                if (gmailProcessingListener) {
                    gmailProcessingListener();
                    gmailProcessingListener = null;
                }
                
                if (gmailHistoryListener) {
                    gmailHistoryListener();
                    gmailHistoryListener = null;
                }
                
                if (gmailSettingsListener) {
                    gmailSettingsListener();
                    gmailSettingsListener = null;
                }
                
                if (gmailWalletListener) {
                    gmailWalletListener();
                    gmailWalletListener = null;
                }
                
                if (supportContactsListener) {
                    supportContactsListener();
                    supportContactsListener = null;
                }
                
                if (referralListListener) {
                    referralListListener();
                    referralListListener = null;
                }
                
                if (paymentMethodsListener) {
                    paymentMethodsListener();
                    paymentMethodsListener = null;
                }
                
                if (verificationMethodsListener) {
                    verificationMethodsListener();
                    verificationMethodsListener = null;
                }
                
                if (walletTypesListener) { // â NEW
                    walletTypesListener();
                    walletTypesListener = null;
                }
                
                if (liveTimerInterval) {
                    clearInterval(liveTimerInterval);
                    liveTimerInterval = null;
                }

                // ===== FREE JOB CLEANUP =====
                if (freeJobProjectsListener) {
                    freeJobProjectsListener();
                    freeJobProjectsListener = null;
                }
                if (freeJobCardsListener) {
                    freeJobCardsListener();
                    freeJobCardsListener = null;
                }
                if (freeJobJobsListener) {
                    freeJobJobsListener();
                    freeJobJobsListener = null;
                }
                if (freeJobSubmissionsListener) {
                    freeJobSubmissionsListener();
                    freeJobSubmissionsListener = null;
                }
                // ===== JOB SUBMISSIONS CLEANUP =====
                if (jobSubmissionsListener) {
                    jobSubmissionsListener();
                    jobSubmissionsListener = null;
                }
                
                selectedProjectId = null;
                selectedCardId = null;
                selectedJob = null;
                selectedProjectTitle = '';
                selectedCardTitle = '';
                selectedJobTitle = '';
                // ==============================
                
                paymentMethods = [];
                verificationMethods = [];
                referralSettings = null;
                previousVerificationStatus = null;
                walletTypes = []; // â NEW
                selectedWalletKey = null; // â NEW
                
                await auth.signOut();
                
                userData = null;
                userDocRef = null;
                appConfig = null;
                selectedWithdrawPackage = null;
                
                document.getElementById('app-container').style.display = 'none';
                document.getElementById('auth-container').style.display = 'block';
                
                showWelcome();
                
                toggleMenu();
                
                showToast('à¦à¦ªà¦¨à¦¿ à¦¸à¦«à¦²à¦­à¦¾à¦¬à§ à¦²à¦à¦à¦à¦ à¦¹à¦¯à¦¼à§à¦à§à¦¨à¥¤');
            } catch (error) {
                showToast('à¦²à¦à¦à¦à¦ à¦à¦°à¦¤à§ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à§à§à¦à§à¥¤', 'error');
            }
        }

        // ========== FREE JOB SYSTEM FUNCTIONS ==========

        // â DAILY RESET FUNCTION
        async function resetDailyLimitIfNeeded(projectId) {
            const projectRef = db.collection('projects').doc(projectId);
            const projectDoc = await projectRef.get();
            if (!projectDoc.exists) return;
            const project = projectDoc.data();
            const todayDate = new Date().toDateString();
            if (project.lastUsedDate !== todayDate) {
                await projectRef.update({
                    todayUsed: 0,
                    lastUsedDate: todayDate
                });
                console.log(`â Daily limit reset for project ${projectId}`);
            }
        }

        // 1. Load Projects â with daily limit check & lock
        function loadFreeJobProjects() {
            const container = document.getElementById('free-job-projects-container');
            container.innerHTML = '<div style="text-align: center; padding: 40px 20px; color: var(--text-light);"><i class="fa-solid fa-spinner fa-spin" style="font-size: 48px;"></i><p>Loading projects...</p></div>';

            if (freeJobProjectsListener) freeJobProjectsListener();

            freeJobProjectsListener = db.collection('projects')
                .where('status', '==', 'active')
                .orderBy('order', 'asc')
                .onSnapshot(async (snapshot) => {
                    // Reset daily limits if needed
                    const resetPromises = snapshot.docs.map(doc => resetDailyLimitIfNeeded(doc.id));
                    await Promise.all(resetPromises);
                    renderFreeJobProjects(snapshot);
                }, (error) => {
                    console.error('Error loading projects:', error);
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--danger);"><i class="fa-solid fa-exclamation-circle" style="font-size: 48px;"></i><p>Error loading projects.</p></div>';
                });
        }

        // â Updated render function with lock, remaining count
        function renderFreeJobProjects(snapshot) {
            const container = document.getElementById('free-job-projects-container');
            if (snapshot.empty) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-light);"><i class="fa-solid fa-inbox" style="font-size: 48px;"></i><p>No active projects.</p></div>';
                return;
            }

            let html = '';
            snapshot.forEach(doc => {
                const project = doc.data();
                const projectId = doc.id;

                const usedWorkPerDay = Number(project.usedWorkPerDay);
                const todayUsed = Number(project.todayUsed || 0);

                // If usedWorkPerDay missing, skip (treat as unlimited)
                if (!usedWorkPerDay) {
                    console.error('usedWorkPerDay missing for project:', projectId);
                    return;
                }

                const remaining = Math.max(0, usedWorkPerDay - todayUsed);
                const isLocked = todayUsed >= usedWorkPerDay;

                let statusClass = '';
                if (isLocked) {
                    statusClass = 'free-job-project-locked';
                } else if (project.status === 'coming') {
                    statusClass = 'free-job-project-coming';
                }

                html += `
                    <div class="free-job-project-card ${statusClass}"
                        ${isLocked ? '' : `onclick="selectProject('${projectId}', '${project.title}')"`}>

                        <h3 style="font-size:18px; font-weight:700; margin-bottom:6px;">
                            ${project.title}
                        </h3>

                        <p style="font-size:13px; color:gray;">
                            ${project.description || ''}
                        </p>

                        <div style="display:flex; justify-content:space-between; margin-top:10px;">

                            <span style="font-size:12px; font-weight:600; color:${isLocked ? 'red' : 'green'};">
                                â³ Remaining Today: ${remaining}/${usedWorkPerDay}
                            </span>

                            <span style="font-size:12px; color:gray;">
                                ${isLocked ? 'â Daily Limit Finished' : 'â Active'}
                            </span>

                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // â Updated selectProject â checks limit before navigating
        async function selectProject(projectId, projectTitle) {
            try {
                const projectDoc = await db.collection('projects').doc(projectId).get();
                if (!projectDoc.exists) {
                    showToast('â Project not found!', 'error');
                    return;
                }

                const project = projectDoc.data();
                const usedWorkPerDay = Number(project.usedWorkPerDay);
                const todayUsed = Number(project.todayUsed || 0);

                if (todayUsed >= usedWorkPerDay) {
                    showToast('â Daily limit finished! Come back tomorrow.', 'warning');
                    return;
                }

                selectedProjectId = projectId;
                selectedProjectTitle = projectTitle;
                navigateTo('free-job-cards');
            } catch (error) {
                console.error('Error selecting project:', error);
                showToast('â Something went wrong!', 'error');
            }
        }

        // 2. Load Cards
        function loadFreeJobCards(projectId) {
            const container = document.getElementById('free-job-cards-container');
            container.innerHTML = '<div style="text-align: center; padding: 40px 20px; color: var(--text-light);"><i class="fa-solid fa-spinner fa-spin" style="font-size: 48px;"></i><p>Loading cards...</p></div>';

            if (freeJobCardsListener) freeJobCardsListener();

            freeJobCardsListener = db.collection('cards')
                .where('projectId', '==', projectId)
                .where('status', '==', 'active')
                .orderBy('order', 'asc')
                .onSnapshot((snapshot) => {
                    renderFreeJobCards(snapshot);
                }, (error) => {
                    console.error('Error loading cards:', error);
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--danger);"><i class="fa-solid fa-exclamation-circle" style="font-size: 48px;"></i><p>Error loading cards.</p></div>';
                });
        }

        function renderFreeJobCards(snapshot) {
            const container = document.getElementById('free-job-cards-container');
            if (snapshot.empty) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-light);"><i class="fa-solid fa-inbox" style="font-size: 48px;"></i><p>No cards available in this project.</p></div>';
                return;
            }

            let html = '';
            snapshot.forEach(doc => {
                const card = doc.data();
                const cardId = doc.id;
                const statusClass = card.status === 'locked' ? 'free-job-card-locked' : '';
                html += `
                    <div class="free-job-card-item ${statusClass}" onclick="selectCard('${cardId}', '${card.title}')">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <img src="${card.logoUrl || 'https://via.placeholder.com/50'}" alt="logo" style="width: 50px; height: 50px; border-radius: 10px; object-fit: cover;">
                            <div style="flex: 1;">
                                <h4 style="font-size: 16px; font-weight: 700; color: var(--dark); margin-bottom: 4px;">${card.title}</h4>
                                <p style="font-size: 13px; color: var(--success); font-weight: 600;">Reward: à§³${card.rewardAmount || 0}</p>
                            </div>
                            <button class="master-btn master-btn-primary master-btn-sm" style="width: auto; margin: 0;">${card.buttonText || 'View'}</button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // Select card -> go to jobs page
        function selectCard(cardId, cardTitle) {
            selectedCardId = cardId;
            selectedCardTitle = cardTitle;
            document.getElementById('free-job-jobs-card-title').textContent = cardTitle;
            navigateTo('free-job-jobs');
        }

        // 3. Load Jobs
        function loadFreeJobJobs(cardId) {
            const container = document.getElementById('free-job-jobs-container');
            container.innerHTML = '<div style="text-align: center; padding: 40px 20px; color: var(--text-light);"><i class="fa-solid fa-spinner fa-spin" style="font-size: 48px;"></i><p>Loading jobs...</p></div>';

            if (freeJobJobsListener) freeJobJobsListener();

            freeJobJobsListener = db.collection('jobs')
                .where('cardId', '==', cardId)
                .where('status', '==', 'active')
                .orderBy('createdAt', 'desc')
                .onSnapshot((snapshot) => {
                    renderFreeJobJobs(snapshot);
                }, (error) => {
                    console.error('Error loading jobs:', error);
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--danger);"><i class="fa-solid fa-exclamation-circle" style="font-size: 48px;"></i><p>Error loading jobs.</p></div>';
                });
        }

        function renderFreeJobJobs(snapshot) {
            const container = document.getElementById('free-job-jobs-container');
            if (snapshot.empty) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-light);"><i class="fa-solid fa-inbox" style="font-size: 48px;"></i><p>No jobs available in this card.</p></div>';
                return;
            }

            let html = '';
            snapshot.forEach(doc => {
                const job = doc.data();
                const jobId = doc.id;
                const statusClass = job.status === 'locked' ? 'free-job-locked' : '';
                html += `
                    <div class="free-job-item ${statusClass}" onclick="selectJob('${jobId}', ${JSON.stringify(job).replace(/"/g, '&quot;')})">
                        <h4 style="font-size: 16px; font-weight: 700; color: var(--dark); margin-bottom: 8px;">${job.jobTitle}</h4>
                        <p style="font-size: 14px; color: var(--text-light); margin-bottom: 5px;">${job.description ? job.description.substring(0, 60) + '...' : ''}</p>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 14px; color: var(--success); font-weight: 600;">Reward: à§³${job.reward || 0}</span>
                            <button class="master-btn master-btn-primary master-btn-sm" style="width: auto; margin: 0;">View Details</button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // Select job -> go to details page
        function selectJob(jobId, jobObj) {
            // Parse job object (it's passed as escaped JSON string)
            if (typeof jobObj === 'string') {
                try {
                    jobObj = JSON.parse(jobObj);
                } catch (e) {
                    console.error('Error parsing job object', e);
                    return;
                }
            }
            selectedJob = jobObj;
            selectedJob.id = jobId;
            selectedJobTitle = jobObj.jobTitle || '';
            navigateTo('free-job-details');
        }

        // 4. Render Job Details Page
        function renderFreeJobDetails(job) {
            const container = document.getElementById('free-job-details-container');
            if (!job) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--danger);">Job not found.</div>';
                return;
            }

            // â Build media items for carousel
            let mediaItems = [];
            
            // Add images with their orders
            if (job.jobImages && Array.isArray(job.jobImages)) {
                job.jobImages.forEach((url, index) => {
                    const order = (job.jobImageOrders && job.jobImageOrders[index]) ? job.jobImageOrders[index] : index + 1;
                    mediaItems.push({
                        type: 'image',
                        url: url,
                        order: order
                    });
                });
            }
            
            // Add video if exists
            if (job.videoUrl && job.videoUrl.trim() !== '') {
                mediaItems.push({
                    type: 'video',
                    url: job.videoUrl,
                    order: job.videoOrder || 1
                });
            }
            
            // Sort by order
            mediaItems.sort((a, b) => a.order - b.order);

            // Generate media slider HTML
            let mediaSliderHtml = '';
            if (mediaItems.length > 0) {
                mediaSliderHtml = `
                    <div class="media-slider-container" id="media-slider">
                        ${mediaItems.map((item, idx) => `
                            <div class="media-slide ${idx === 0 ? 'active' : ''}" data-index="${idx}">
                                ${item.type === 'image' 
                                    ? `<img src="${item.url}" alt="Job media" style="width: 100%; height: 200px; object-fit: cover;">`
                                    : `<video controls style="width: 100%; height: 200px; object-fit: cover;">
                                        <source src="${item.url}" type="video/mp4">
                                        Your browser does not support the video tag.
                                       </video>`
                                }
                            </div>
                        `).join('')}
                        ${mediaItems.length > 1 ? `
                            <button class="slider-btn prev" onclick="changeMediaSlide(-1)"><i class="fa-solid fa-chevron-left"></i></button>
                            <button class="slider-btn next" onclick="changeMediaSlide(1)"><i class="fa-solid fa-chevron-right"></i></button>
                            <div class="media-indicators">
                                ${mediaItems.map((_, idx) => `
                                    <span class="media-dot ${idx === 0 ? 'active' : ''}" onclick="goToMediaSlide(${idx})"></span>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            } else {
                // Fallback if no media
                mediaSliderHtml = `<img src="https://via.placeholder.com/600x200?text=No+Media" alt="No media" class="free-job-job-banner">`;
            }

            // Instruction steps with bold font
            let stepsHtml = '';
            if (job.instructionSteps && Array.isArray(job.instructionSteps)) {
                job.instructionSteps.forEach((step, idx) => {
                    stepsHtml += `
                        <div class="free-job-instruction-step">
                            <span class="free-job-step-number">${idx + 1}</span>
                            <span class="free-job-step-text" style="font-weight: 700;">${step.text || ''}</span>
                        </div>
                    `;
                });
            } else {
                stepsHtml = '<p style="color: var(--text-light); font-weight: 700;">No instructions provided.</p>';
            }

            // Proof requirements
            const proofReq = job.proofRequirements || { screenshot: { required: false, count: 0 }, link: { required: false }, text: { required: false } };
            const screenshotCount = proofReq.screenshot?.count || 0;
            const requireScreenshot = proofReq.screenshot?.required || false;
            const requireLink = proofReq.link?.required || false;
            const requireText = proofReq.text?.required || false;

            let proofHtml = '<div class="free-job-proof-section"><h4 style="margin-bottom: 15px; color: var(--dark); font-size: 16px; font-weight: 700;">Submit Your Proof</h4>';

            if (requireScreenshot) {
                for (let i = 0; i < screenshotCount; i++) {
                    proofHtml += `
                        <div class="free-job-upload-area">
                            <label class="free-job-upload-label" style="font-weight: 700;">Screenshot ${i + 1}</label>
                            <input type="file" class="free-job-file-input" accept="image/*" id="screenshot-${i}">
                        </div>
                    `;
                }
            }

            if (requireLink) {
                proofHtml += `
                    <div class="free-job-upload-area">
                        <label class="free-job-upload-label" style="font-weight: 700;">Proof Link</label>
                        <input type="url" class="free-job-link-input" id="proof-link" placeholder="https://...">
                    </div>
                `;
            }

            if (requireText) {
                proofHtml += `
                    <div class="free-job-upload-area">
                        <label class="free-job-upload-label" style="font-weight: 700;">Text Proof</label>
                        <input type="text" class="free-job-link-input" id="proof-text" placeholder="Enter text...">
                    </div>
                `;
            }

            proofHtml += `
                <button class="master-btn master-btn-green master-btn-full" onclick="submitFreeJobProof('${job.id}')" style="margin-top: 20px;">
                    <i class="fa-solid fa-paper-plane"></i> Submit Work Proof
                </button>
            </div>`;

            // Full HTML with bold applied to all text elements
            container.innerHTML = `
                <div style="padding: 0 20px 20px;">
                    ${mediaSliderHtml}
                    
                    <div style="margin-bottom: 25px;">
                        <h3 style="font-size: 20px; font-weight: 700; color: var(--dark); margin-bottom: 10px;">${job.jobTitle}</h3>
                        <p style="font-size: 14px; color: var(--text); line-height: 1.6; font-weight: 700;">${job.description || ''}</p>
                    </div>

                    <div style="margin-bottom: 25px;">
                        <h4 style="font-size: 16px; font-weight: 700; color: var(--dark); margin-bottom: 15px;">Instructions</h4>
                        ${stepsHtml}
                    </div>

                    <a href="${job.workLink || '#'}" target="_blank" class="master-btn master-btn-primary master-btn-full" style="text-decoration: none; text-align: center; font-weight: 700;">
                        <i class="fa-solid fa-arrow-up-right-from-square"></i> GO TO WORK LINK
                    </a>

                    ${proofHtml}
                </div>
            `;
        }

        // Media slider navigation functions
        let currentSlideIndex = 0;

        function changeMediaSlide(direction) {
            const slides = document.querySelectorAll('.media-slide');
            const dots = document.querySelectorAll('.media-dot');
            if (!slides.length) return;
            
            slides[currentSlideIndex].classList.remove('active');
            if (dots.length) dots[currentSlideIndex].classList.remove('active');
            
            currentSlideIndex += direction;
            if (currentSlideIndex < 0) currentSlideIndex = slides.length - 1;
            if (currentSlideIndex >= slides.length) currentSlideIndex = 0;
            
            slides[currentSlideIndex].classList.add('active');
            if (dots.length) dots[currentSlideIndex].classList.add('active');
        }

        function goToMediaSlide(index) {
            const slides = document.querySelectorAll('.media-slide');
            const dots = document.querySelectorAll('.media-dot');
            if (!slides.length) return;
            
            slides[currentSlideIndex].classList.remove('active');
            if (dots.length) dots[currentSlideIndex].classList.remove('active');
            
            currentSlideIndex = index;
            slides[currentSlideIndex].classList.add('active');
            if (dots.length) dots[currentSlideIndex].classList.add('active');
        }

        // 5. Submit Work Proof
        async function submitFreeJobProof(jobId) {
            const user = auth.currentUser;
            if (!user || !userData) {
                showToast('Please login again', 'error');
                return;
            }

            // â Check project daily limit again before submission
            try {
                const projectDoc = await db.collection('projects').doc(selectedProjectId).get();
                if (projectDoc.exists) {
                    const project = projectDoc.data();
                    const usedWorkPerDay = Number(project.usedWorkPerDay);
                    const todayUsed = Number(project.todayUsed || 0);
                    if (todayUsed >= usedWorkPerDay) {
                        showToast('â Daily limit finished! Cannot submit work.', 'warning');
                        return;
                    }
                }
            } catch (error) {
                console.error('Error checking project limit:', error);
            }

            const job = selectedJob;
            if (!job) return;

            const proofReq = job.proofRequirements || { screenshot: { required: false, count: 0 }, link: { required: false }, text: { required: false } };
            const screenshotCount = proofReq.screenshot?.count || 0;
            const requireScreenshot = proofReq.screenshot?.required || false;
            const requireLink = proofReq.link?.required || false;
            const requireText = proofReq.text?.required || false;

            // Collect proofs
            let proofs = {};

            if (requireScreenshot) {
                // In a real implementation, you would upload files to Firebase Storage.
                // Here we just store the file names as placeholders.
                for (let i = 0; i < screenshotCount; i++) {
                    const fileInput = document.getElementById(`screenshot-${i}`);
                    if (fileInput && fileInput.files.length > 0) {
                        proofs[`screenshot${i}`] = fileInput.files[0].name;
                    } else {
                        showToast(`Please upload screenshot ${i + 1}`, 'error');
                        return;
                    }
                }
            }

            if (requireLink) {
                const linkInput = document.getElementById('proof-link');
                if (linkInput && linkInput.value.trim()) {
                    proofs.linkProof = linkInput.value.trim();
                } else {
                    showToast('Please enter proof link', 'error');
                    return;
                }
            }

            if (requireText) {
                const textInput = document.getElementById('proof-text');
                if (textInput && textInput.value.trim()) {
                    proofs.textProof = textInput.value.trim();
                } else {
                    showToast('Please enter text proof', 'error');
                    return;
                }
            }

            // Prepare submission document with titles (for Job Submissions page)
            const submissionData = {
                uid: user.uid,
                jobId: job.id,
                cardId: selectedCardId,
                projectId: selectedProjectId,
                // â Store titles for easy display
                projectTitle: selectedProjectTitle,
                cardTitle: selectedCardTitle,
                jobTitle: selectedJobTitle,
                proofs: proofs,
                reward: job.reward || 0,
                status: 'processing',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                // â Add submission
                await db.collection('job_submissions').add(submissionData);
                
                // â Increment todayUsed for the project
                const projectRef = db.collection('projects').doc(selectedProjectId);
                await projectRef.update({
                    todayUsed: firebase.firestore.FieldValue.increment(1)
                });
                
                showToast('Work proof submitted successfully! Status: Processing');
                
                // Navigate back to jobs page
                setTimeout(() => {
                    navigateTo('free-job-jobs');
                }, 1500);
            } catch (error) {
                console.error('Error submitting proof:', error);
                showToast('Failed to submit proof: ' + error.message, 'error');
            }
        }

        // ========== END FREE JOB SYSTEM ==========

        // ========== JOB SUBMISSIONS PAGE ==========
        function setupJobSubmissionsListener(userId) {
            if (jobSubmissionsListener) {
                jobSubmissionsListener();
            }

            jobSubmissionsListener = db.collection('job_submissions')
                .where('uid', '==', userId)
                .orderBy('createdAt', 'desc')
                .onSnapshot((snapshot) => {
                    allSubmissions = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        data.id = doc.id;
                        allSubmissions.push(data);
                    });
                    // Update summary and list with current filter
                    updateSubmissionsSummary(allSubmissions);
                    filterSubmissions(currentSubmissionFilter);
                    
                    // â Detect approved status and add reward to freeJobBalance
                    snapshot.docChanges().forEach(change => {
                        const doc = change.doc;
                        const data = doc.data();
                        
                        if (change.type === 'modified') {
                            if (data.status === 'approved' && !data.rewardAdded) {
                                addFreeJobReward(userId, data.reward || 0, doc.id);
                            }
                        } else if (change.type === 'added') {
                            if (data.status === 'approved' && !data.rewardAdded) {
                                addFreeJobReward(userId, data.reward || 0, doc.id);
                            }
                        }
                    });
                }, (error) => {
                    console.error('Error loading job submissions:', error);
                    const list = document.getElementById('job-submissions-list');
                    if (list) {
                        list.innerHTML = `<div style="text-align: center; padding: 40px; color: var(--danger);">
                            <i class="fa-solid fa-exclamation-circle" style="font-size: 48px;"></i>
                            <p>Error loading submissions.</p>
                        </div>`;
                    }
                });
        }

        // â NEW: Add Free Job reward to freeJobBalance
        async function addFreeJobReward(userId, amount, submissionId) {
            try {
                await db.runTransaction(async (transaction) => {
                    const userRef = db.collection('users').doc(userId);
                    const submissionRef = db.collection('job_submissions').doc(submissionId);
                    
                    const userDoc = await transaction.get(userRef);
                    const submissionDoc = await transaction.get(submissionRef);
                    
                    if (!userDoc.exists || !submissionDoc.exists) return;
                    
                    const submissionData = submissionDoc.data();
                    if (submissionData.status !== 'approved' || submissionData.rewardAdded) return;
                    
                    transaction.update(userRef, {
                        freeJobBalance: firebase.firestore.FieldValue.increment(amount),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    transaction.update(submissionRef, {
                        rewardAdded: true,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });
                console.log(`â Free Job reward à§³${amount} added to freeJobBalance`);
            } catch (error) {
                console.error('Error adding free job reward:', error);
            }
        }

        function updateSubmissionsSummary(submissions) {
            let pendingReward = 0;
            let approvedReward = 0;
            submissions.forEach(sub => {
                if (sub.status === 'processing') {
                    pendingReward += sub.reward || 0;
                } else if (sub.status === 'approved') {
                    approvedReward += sub.reward || 0;
                }
            });
            document.getElementById('pending-reward-sum').innerHTML = `à§³${pendingReward}`;
            document.getElementById('approved-reward-sum').innerHTML = `à§³${approvedReward}`;
        }

        function filterSubmissions(status) {
            currentSubmissionFilter = status;
            
            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const activeTab = Array.from(document.querySelectorAll('.filter-tab')).find(tab => 
                tab.textContent.toLowerCase() === status || (status === 'all' && tab.textContent === 'All')
            );
            if (activeTab) activeTab.classList.add('active');

            let filtered = allSubmissions;
            if (status !== 'all') {
                filtered = allSubmissions.filter(sub => sub.status === status);
            }
            renderJobSubmissions(filtered);
        }

        function renderJobSubmissions(submissions) {
            const list = document.getElementById('job-submissions-list');
            if (!list) return;

            if (!submissions || submissions.length === 0) {
                list.innerHTML = `<div style="text-align: center; padding: 40px; color: var(--text-light);">
                    <i class="fa-solid fa-inbox" style="font-size: 48px; margin-bottom: 20px; opacity: 0.5;"></i>
                    <p>No job submissions yet.</p>
                </div>`;
                return;
            }

            let html = '';
            submissions.forEach((sub, index) => {
                const date = sub.createdAt ? sub.createdAt.toDate() : new Date();
                const formattedDate = date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                let statusBadge = '';
                let statusColor = '';
                if (sub.status === 'processing') {
                    statusBadge = '<span class="badge-pending">Processing</span>';
                    statusColor = '#f59e0b';
                } else if (sub.status === 'approved') {
                    statusBadge = '<span class="badge-approved">Approved</span>';
                    statusColor = '#10b981';
                } else if (sub.status === 'rejected') {
                    statusBadge = '<span class="badge-rejected">Rejected</span>';
                    statusColor = '#ef4444';
                }

                // Proof summary
                let proofSummary = '';
                if (sub.proofs) {
                    const proofItems = [];
                    if (sub.proofs.linkProof) proofItems.push('ð Link');
                    if (sub.proofs.textProof) proofItems.push('ð Text');
                    Object.keys(sub.proofs).forEach(key => {
                        if (key.startsWith('screenshot')) proofItems.push('ð¼ï¸ Screenshot');
                    });
                    proofSummary = proofItems.join(', ') || 'No proofs';
                }

                html += `
                    <div class="job-submission-card">
                        <div class="submission-header">
                            <span class="submission-project"><i class="fa-solid fa-folder"></i> ${sub.projectTitle || 'N/A'}</span>
                            <span class="submission-status">${statusBadge}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <div style="font-weight: 700; color: var(--dark);">${sub.cardTitle || 'N/A'} / ${sub.jobTitle || 'N/A'}</div>
                            <div style="font-weight: 800; color: var(--success);">à§³${sub.reward || 0}</div>
                        </div>
                        <div class="submission-details">
                            <div class="submission-detail-item">
                                <span class="submission-detail-label">Submitted:</span> ${formattedDate}
                            </div>
                            <div class="submission-detail-item">
                                <span class="submission-detail-label">Proofs:</span> ${proofSummary}
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="master-btn master-btn-primary master-btn-sm" style="width: auto;" onclick="showSubmissionDetail('${sub.id}')">
                                <i class="fa-solid fa-eye"></i> View Details
                            </button>
                        </div>
                    </div>
                `;
            });
            list.innerHTML = html;
        }

        function showSubmissionDetail(submissionId) {
            const submission = allSubmissions.find(s => s.id === submissionId);
            if (!submission) return;

            const date = submission.createdAt ? submission.createdAt.toDate() : new Date();
            const formattedDate = date.toLocaleString();

            let proofsHtml = '';
            if (submission.proofs) {
                proofsHtml = '<div style="margin-top: 15px;"><strong>Proofs:</strong></div>';
                for (const [key, value] of Object.entries(submission.proofs)) {
                    proofsHtml += `<div style="display: flex; margin-top: 8px; padding: 8px; background: var(--light); border-radius: 8px;">
                        <span style="font-weight: 600; min-width: 100px; color: var(--text-light);">${key}:</span>
                        <span style="font-weight: 500; color: var(--dark); word-break: break-all;">${value}</span>
                    </div>`;
                }
            }

            const statusText = submission.status.charAt(0).toUpperCase() + submission.status.slice(1);
            const statusColor = submission.status === 'approved' ? '#10b981' : (submission.status === 'rejected' ? '#ef4444' : '#f59e0b');

            const content = `
                <div style="font-size: 14px;">
                    <p><strong>Project:</strong> ${submission.projectTitle || 'N/A'}</p>
                    <p><strong>Card:</strong> ${submission.cardTitle || 'N/A'}</p>
                    <p><strong>Job:</strong> ${submission.jobTitle || 'N/A'}</p>
                    <p><strong>Reward:</strong> à§³${submission.reward || 0}</p>
                    <p><strong>Status:</strong> <span style="color: ${statusColor}; font-weight: 700;">${statusText}</span></p>
                    <p><strong>Submitted:</strong> ${formattedDate}</p>
                    ${proofsHtml}
                    <p style="margin-top: 15px;"><strong>Submission ID:</strong> ${submission.id}</p>
                </div>
            `;
            document.getElementById('submission-detail-content').innerHTML = content;
            document.getElementById('submission-detail-modal').classList.add('active');
        }

        function closeSubmissionDetailModal() {
            document.getElementById('submission-detail-modal').classList.remove('active');
        }

        // ========== END JOB SUBMISSIONS PAGE ==========

        // INITIALIZE ON LOAD
        document.addEventListener('DOMContentLoaded', function() {
            console.log('SmartPay Wallet loaded successfully!');
            console.log('â Full Firestore config integration â live colors & logo');
            console.log('â Free Job System integrated â 100% Firestore driven');
            console.log('â Job Submissions Page added â tracking system');
            console.log('â Daily work limit implemented using usedWorkPerDay/todayUsed');
            console.log('â Job Details text all bold');
            console.log('â Media slider with video support added');
            console.log('â Verify Now button hidden for verified users');
            console.log('â Withdraw Page â 100% Firestore driven, wallet-wise packages');
            console.log('â PROBLEM #9 FIXED: Salary Application/Receive History completely removed');
            console.log('â PROBLEM #10 FIXED: Withdraw status logic corrected (totalWithdraw only on approved, refund on reject)');
            console.log('â PROBLEM #12 FIXED: Approved earnings sync into wallets (Referral, Free Job, Gmail)');

            // Add event listener for wallet dropdown
            const walletSelect = document.getElementById('withdraw-wallet-select');
            if (walletSelect) {
                walletSelect.addEventListener('change', onWalletChange);
            }

            updateTimerBasedOnConfig();
        });

        // =======================================================
        // â REFERRAL AUTO SIGNUP SYSTEM (Problem #13 Fix)
        // =======================================================

        window.addEventListener("load", function () {
            // Step 1: Get referral code from URL
            const urlParams = new URLSearchParams(window.location.search);
            const referralCodeFromLink = urlParams.get("ref");

            console.log("Referral Code Detected:", referralCodeFromLink);

            // Step 2: If referral code exists â Open Signup Page Automatically
            if (referralCodeFromLink && referralCodeFromLink.trim() !== "") {
                console.log("Opening Signup Page Automatically...");
                
                // Use existing showSignUp function
                showSignUp();

                // Step 3: Auto Fill Referral Code Field
                setTimeout(() => {
                    const referralInput = document.getElementById("signup-referral");
                    if (referralInput) {
                        referralInput.value = referralCodeFromLink.trim();
                        // Prevent user from editing referral code
                        referralInput.readOnly = true;
                        console.log("Referral Code Auto Filled Successfully!");
                    }
                }, 400);
            }
        });
    </script>
</body>
</html>